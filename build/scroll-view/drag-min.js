/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 1 12:12
*/
KISSY.add("scroll-view/drag",function(r,D,E,F){function s(b,c,a){var c=c.timeStamp,f=b.get("scroll"+r.ucfirst(a));b.startScroll[a]=f;b.swipe[a].startTime=c;b.swipe[a].scroll=f}function v(b,c,a,f){if(!w(b,a)){var d="left"==a?"pageX":"pageY",k=b.lastPageXY,h,e=b.startScroll[a]-(c[d]-f[a]),f=c.timeStamp,i=b.minScroll,l=b.maxScroll,g=b.lastDirection,j=b.swipe,t;k[d]&&(h=c[d]==k[d],t=0<c[d]-k[d]);b.get("bounce")||(e=Math.min(Math.max(e,i[a]),l[a]));e<i[a]?(e=i[a]-e,e*=x,e=i[a]-e):e>l[a]&&(e-=l[a],e*=x,
e=l[a]+e);i=f-j[a].startTime;if(!h&&void 0!==g[a]&&g[a]!==t||i>G)j[a].startTime=f,j[a].scroll=e;b.set("left"==a?"scrollLeft":"scrollTop",e);g[a]=t;k[d]=c[d]}}function w(b,c){return!b.allowScroll[c]&&b.get("left"==c?"lockX":"lockY")?1:0}function y(b,c,a,f){if(w(b,a))f();else{var d="scroll"+("left"==a?"Left":"Top"),k=b.$contentEl,h=b.get(d),e={},i=b.minScroll,l=b.maxScroll,g=c.timeStamp,c=b.swipe,j;h<i[a]?j=i[a]:h>l[a]&&(j=l[a]);void 0!==j?(d={},d[a]=j,b.scrollTo(d,{duration:b.get("bounceDuration"),
easing:b.get("bounceEasing"),queue:!1,complete:f})):b.pagesXY?f():(j=g-c[a].startTime,c=h-c[a].scroll,0==j||0==c?f():(j=Math.min(Math.max(c/j,-z),z),e[a]={fx:{frame:H(b,j,h,d,l[a],i[a])}},k.animate(e,{duration:9999,queue:!1,complete:f})))}}function H(b,c,a,f,d,k){var h=c*m,e=1,i=0;return function(c){var g=r.now();if(e){var c=g-c.startTime,j=Math.exp(c*I),c=parseInt(a+h*(1-j)/-A);c>k&&c<d?(this.lastValue===c&&(this.finished=1),this.lastValue=c,b.set(f,c)):(e=0,h*=j,a=c<=k?k:d,i=g)}else c=g-i,g=c/m,
g*=Math.exp(-J*g),c=parseInt(h*g),0===c&&(this.finished=1),b.set(f,a+c)}}function K(b){this.stopAnimation();if(this.isScrolling){var c=this.get("pageIndex");this.isScrolling=0;this.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,fromPageIndex:c,pageIndex:c})}}function L(b){B(this);this.startMousePos=this.dd.get("startMousePos");s(this,b,"left");s(this,b,"top");this.fire("scrollStart",{pageX:b.pageX,pageY:b.pageY});this.isScrolling=1}function M(b){var c=this.startMousePos;if(c){var a=this.get("lockX"),
f=this.get("lockY");if(a||f){var d=Math.abs(b.pageX-c.left)>Math.abs(b.pageY-c.top)?"x":"y";if(a&&"x"==d){this.dd.stopDrag();return}if(f&&"y"==d){this.dd.stopDrag();return}}b.preventDefault();v(this,b,"left",c);v(this,b,"top",c);this.fire("scrollMove",{pageX:b.pageX,pageY:b.pageY})}}function N(b){function c(){f++;if(2==f){var c=function(){a.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,fromPageIndex:s,pageIndex:a.get("pageIndex")})};if(a.pagesXY){a.get("snapThreshold");var d=a.get("snapDuration"),
m=a.get("snapEasing"),s=a.get("pageIndex"),u=a.get("scrollLeft"),n=a.get("scrollTop"),d={duration:d,easing:m,complete:c},m=a.pagesXY.concat([]);a.isScrolling=0;if(l||g)if(l&&g&&e&&i){var o=[],p=void 0;r.each(m,function(a){a&&(0<k&&a.x>u?o.push(a):0>k&&a.x<u&&o.push(a))});var q;0<h?(q=Number.MAX_VALUE,r.each(o,function(a){a.y>n&&q<a.y-n&&(q=a.y-n,p=o.index)})):(q=Number.MAX_VALUE,r.each(o,function(a){a.y<n&&q<n-a.y&&(q=n-a.y,p=o.index)}));void 0!=p?p!=s?a.scrollToPage(p,d):(a.scrollToPage(p),c()):
c()}else l&&e||g&&i?(c=a._getPageIndexFromXY(l?u:n,l,l?k:h),a.scrollToPage(c,d)):(a.scrollToPage(a.get("pageIndex")),c())}else c()}}var a=this,f=0,d=a.startMousePos,k=d.left-b.pageX,h=d.top-b.pageY,d=a.get("snapThreshold"),e=Math.abs(k)>d,i=Math.abs(h)>d,l=a.allowScroll.left,g=a.allowScroll.top;a.fire("dragend",{pageX:b.pageX,pageY:b.pageY});y(a,b,"left",c);y(a,b,"top",c)}function B(b){b.lastPageXY={};b.lastDirection={};b.swipe={left:{},top:{}};b.startMousePos=null;b.startScroll={}}var x=0.5,O=F.Gesture,
G=300,z=6,m=20,A=Math.log(0.95),I=A/m,J=0.3,C;return C=D.extend({bindUI:function(){var b=this.$contentEl;b.on(O.start,K,this);(this.dd=new E.Draggable({node:b,groups:!1,preventDefaultOnMove:!1,halt:!0})).on("dragstart",L,this).on("drag",M,this).on("dragend",N,this)},syncUI:function(){B(this)},destructor:function(){this.dd.destroy();this.stopAnimation()},stopAnimation:function(){C.superclass.stopAnimation.apply(this,arguments);this.dd.stopDrag()},_onSetDisabled:function(b){this.dd.set("disabled",b)}},
{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","dd","node"]});
