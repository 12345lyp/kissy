/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 30 19:23
*/
KISSY.add("scroll-view/drag",function(r,D,E,F){function s(a,c,b){var c=c.timeStamp,f=a.get("scroll"+r.ucfirst(b));a.startScroll[b]=f;a.swipe[b].startTime=c;a.swipe[b].scroll=f}function v(a,c,b,f){if(!w(a,b)){var d="left"==b?"pageX":"pageY",k=a.lastPageXY,h,e=a.startScroll[b]-(c[d]-f[b]),f=c.timeStamp,i=a.minScroll,l=a.maxScroll,g=a.lastDirection,j=a.swipe,t;k[d]&&(h=c[d]==k[d],t=0<c[d]-k[d]);a.get("bounce")||(e=Math.min(Math.max(e,i[b]),l[b]));e<i[b]?(e=i[b]-e,e*=x,e=i[b]-e):e>l[b]&&(e-=l[b],e*=x,
e=l[b]+e);i=f-j[b].startTime;if(!h&&void 0!==g[b]&&g[b]!==t||i>G)j[b].startTime=f,j[b].scroll=e;a.set("left"==b?"scrollLeft":"scrollTop",e);g[b]=t;k[d]=c[d]}}function w(a,c){return!a.allowScroll[c]&&a.get("left"==c?"lockX":"lockY")?1:0}function y(a,c,b,f){if(w(a,b))f();else{var d="scroll"+("left"==b?"Left":"Top"),k=a.$contentEl,h=a.get(d),e={},i=a.minScroll,l=a.maxScroll,g=c.timeStamp,c=a.swipe,j;h<i[b]?j=i[b]:h>l[b]&&(j=l[b]);void 0!==j?(d={},d[b]=j,a.scrollTo(d,{duration:a.get("bounceDuration"),
easing:a.get("bounceEasing"),queue:!1,complete:f})):a.pagesXY?f():(j=g-c[b].startTime,c=h-c[b].scroll,0==j||0==c?f():(j=Math.min(Math.max(c/j,-z),z),e[b]={fx:{frame:H(a,j,h,d,l[b],i[b])}},k.animate(e,{duration:9999,queue:!1,complete:f})))}}function H(a,c,b,f,d,k){var h=c*m,e=1,i=0;return function(c){var g=r.now();if(e){var c=g-c.startTime,j=Math.exp(c*I),c=parseInt(b+h*(1-j)/-A);c>k&&c<d?(this.lastValue===c&&(this.finished=1),this.lastValue=c,a.set(f,c)):(e=0,h*=j,b=c<=k?k:d,i=g)}else c=g-i,g=c/m,
g*=Math.exp(-J*g),c=parseInt(h*g),0===c&&(this.finished=1),a.set(f,b+c)}}function K(a){this.stopAnimation();if(this.isScrolling){var c=this.get("pageIndex");this.isScrolling=0;this.fire("scrollEnd",{pageX:a.pageX,pageY:a.pageY,fromPageIndex:c,pageIndex:c})}}function L(a){B(this);this.startMousePos={left:a.pageX,top:a.pageY};s(this,a,"left");s(this,a,"top");this.fire("scrollStart",{pageX:a.pageX,pageY:a.pageY});this.isScrolling=1}function M(a){var c=this.startMousePos;v(this,a,"left",c);v(this,a,"top",
c);this.fire("scrollMove",{pageX:a.pageX,pageY:a.pageY})}function N(a){function c(){f++;if(2==f){var c=function(){b.fire("scrollEnd",{pageX:a.pageX,pageY:a.pageY,fromPageIndex:s,pageIndex:b.get("pageIndex")})};if(b.pagesXY){b.get("snapThreshold");var d=b.get("snapDuration"),m=b.get("snapEasing"),s=b.get("pageIndex"),u=b.get("scrollLeft"),n=b.get("scrollTop"),d={duration:d,easing:m,complete:c},m=b.pagesXY.concat([]);b.isScrolling=0;if(l||g)if(l&&g&&e&&i){var o=[],p=void 0;r.each(m,function(a){a&&(0<
k&&a.x>u?o.push(a):0>k&&a.x<u&&o.push(a))});var q;0<h?(q=Number.MAX_VALUE,r.each(o,function(a){a.y>n&&q<a.y-n&&(q=a.y-n,p=o.index)})):(q=Number.MAX_VALUE,r.each(o,function(a){a.y<n&&q<n-a.y&&(q=n-a.y,p=o.index)}));void 0!=p?p!=s?b.scrollToPage(p,d):(b.scrollToPage(p),c()):c()}else l&&e||g&&i?(c=b._getPageIndexFromXY(l?u:n,l,l?k:h),b.scrollToPage(c,d)):(b.scrollToPage(b.get("pageIndex")),c())}else c()}}var b=this,f=0,d=b.startMousePos,k=d.left-a.pageX,h=d.top-a.pageY,d=b.get("snapThreshold"),e=Math.abs(k)>
d,i=Math.abs(h)>d,l=b.allowScroll.left,g=b.allowScroll.top;b.fire("dragend",{pageX:a.pageX,pageY:a.pageY});y(b,a,"left",c);y(b,a,"top",c)}function B(a){a.lastPageXY={};a.lastDirection={};a.swipe={left:{},top:{}};a.startScroll={}}var x=0.5,O=F.Gesture,G=300,z=6,m=20,A=Math.log(0.95),I=A/m,J=0.3,C;return C=D.extend({bindUI:function(){var a=this.$contentEl;a.on(O.start,K,this);(this.dd=new E.Draggable({node:a,groups:!1,halt:!0})).on("dragstart",L,this).on("drag",M,this).on("dragend",N,this)},syncUI:function(){B(this)},
destructor:function(){this.dd.destroy();this.stopAnimation()},stopAnimation:function(){C.superclass.stopAnimation.apply(this,arguments);this.dd.stopDrag()},_onSetDisabled:function(a){this.dd.set("disabled",a)}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","dd","node"]});
