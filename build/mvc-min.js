/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 13 19:04
*/
KISSY.add("mvc/model",function(e,g){var i="idAttribute,clientId,urlRoot,url,parse,sync".split(",");return g.extend({initializer:function(){this.collections={}},addToCollection:function(a){this.collections[e.stamp(a)]=a;this.addTarget(a)},removeFromCollection:function(a){delete this.collections[e.stamp(a)];this.removeTarget(a)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(a){return this.set(this.get("idAttribute"),a)},setInternal:function(){this.__isModified=1;return this.callSuper.apply(this,
arguments)},isNew:function(){return!this.getId()},isModified:function(){return!(!this.isNew()&&!this.__isModified)},destroy:function(a){var b=this,a=a||{},d=a.success;a.success=function(c){var f=b.collections;if(c){var h=b.get("parse").call(b,c);h&&b.set(h,a)}for(var e in f)f[e].remove(b,a);b.fire("destroy");d&&d.apply(this,arguments)};!b.isNew()&&a["delete"]?b.get("sync").call(b,b,"delete",a):(a.success(),a.complete&&a.complete());return b},load:function(a){var b=this,a=a||{},d=a.success;a.success=
function(c){if(c){var f=b.get("parse").call(b,c);f&&b.set(f,a)}b.__isModified=0;d&&d.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},save:function(a){var b=this,a=a||{},d=a.success;a.success=function(c){if(c){var f=b.get("parse").call(b,c);f&&b.set(f,a)}b.__isModified=0;d&&d.apply(this,arguments)};b.get("sync").call(b,b,b.isNew()?"create":"update",a);return b},toJSON:function(){var a=this.getAttrVals();e.each(i,function(b){delete a[b]});return a}},{ATTRS:{idAttribute:{value:"id"},
clientId:{valueFn:function(){return e.guid("mvc-client")}},url:{value:function(){var a,b,d=this.collections;for(a in d)if(d.hasOwnProperty(a)){b=d[a];break}a=b;var c;a=(a&&(c=a.get("url"))?"string"==typeof c?c:c.call(a):c)||this.get("urlRoot");if(this.isNew())return a;a+="/"==a.charAt(a.length-1)?"":"/";return a+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){e.require("mvc").sync.apply(this,arguments)}},parse:{value:function(a){return a}}}})},{requires:["base"]});
KISSY.add("mvc/collection",function(e,g,i){return i.extend({sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(b,d){return a(b)-a(d)})},toJSON:function(){return e.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,b){var d=this,c=!0;if(e.isArray(a)){var f=[].concat(a);e.each(f,function(a){a=d._add(a,b);c=c&&a})}else c=d._add(a,b);return c},remove:function(a,b){var d=this;if(e.isArray(a)){var c=[].concat(a);e.each(c,function(a){d._remove(a,b)})}else a&&
d._remove(a,b)},at:function(a){return this.get("models")[a]},_normModel:function(a){var b=!0;a instanceof g||(b=a,a=new (this.get("model")),b=a.set(b,{silent:1}));return b&&a},load:function(a){var b=this,a=a||{},d=a.success;a.success=function(c){if(c){var f=b.get("parse").call(b,c);f&&b.set("models",f,a)}e.each(b.get("models"),function(a){a.__isModified=0});d&&d.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},create:function(a,b){var d=this,b=b||{};if(a=this._normModel(a)){a.addToCollection(d);
var c=b.success;b.success=function(){d.add(a,b);c&&c()};a.save(b)}return a},_add:function(a,b){if(a=this._normModel(a)){var b=b||{},d=this.get("models"),c=this.get("comparator"),f=d.length;if(c)for(var e=c(a),f=0;f<d.length;f++){var g=c(d[f]);if(e<g)break}this.get("models").splice(f,0,a);a.addToCollection(this);b.silent||this.fire("add",{model:a})}return a},_remove:function(a,b){var b=b||{},d=e.indexOf(a,this.get("models"));-1!=d&&(this.get("models").splice(d,1),a.removeFromCollection(this));b.silent||
this.fire("remove",{model:a})},getById:function(a){for(var b=this.get("models"),d=0;d<b.length;d++){var c=b[d];if(c.getId()===a)return c}return null},getByCid:function(a){for(var b=this.get("models"),d=0;d<b.length;d++){var c=b[d];if(c.get("clientId")===a)return c}return null}},{ATTRS:{model:{value:g},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:""},comparator:{},sync:{value:function(){e.require("mvc").sync.apply(this,
arguments)}},parse:{value:function(a){return a}}}})},{requires:["./model","base"]});
KISSY.add("mvc/view",function(e,g,i){var a=g.all;return i.extend({initializer:function(){var a;(a=this.get("events"))&&this._afterEventsChange({newVal:a})},_afterEventsChange:function(a){var d=a.prevVal;d&&this._removeEvents(d);this._addEvents(a.newVal)},_removeEvents:function(a){var d=this.get("el"),c;for(c in a){var f=a[c],e;for(e in f)d.undelegate(e,c,"string"==typeof f[e]?this[f[e]]:f[e],this)}},_addEvents:function(a){var d=this.get("el"),c;for(c in a){var e=a[c],h;for(h in e)d.delegate(h,c,"string"==
typeof e[h]?this[e[h]]:e[h],this)}},render:function(){return this},destroy:function(){this.get("el").remove()}},{ATTRS:{el:{value:"<div />",getter:function(b){"string"==typeof b&&(b=a(b),this.setInternal("el",b));return b}},events:{}}})},{requires:["node","base"]});
KISSY.add("mvc/router",function(e,g,i,a){function b(a){var b,d;for(d=0;d<a.length;d++)if(b=a.charAt(d),"\\"==b)d++;else if("("==b)return d;throw Error("impossible to not to get capture group in kissy mvc route");}function d(a){a=a||location.href;if(Router.nativeHistory&&o){var a=new e.Uri(a),b=a.getQuery().toString();return a.getPath().substr(Router.urlRoot.length)+(b?"?"+b:"")}return(new e.Uri(a)).getFragment().replace(/^!/,"")}function c(a){e.endsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}
function f(a){a&&(e.startsWith(a,"/")&&(a=a.substring(1)),a="/"+a);return a}function h(a,b){a=c(a);b=c(b);return a==b}function k(){var c,n,f=0,u=-1,h="",g=-1,i=0,k="";c=new e.Uri(d());var t=0;n=c.clone();n.query.reset();n=n.toString();l(j,function(c){var d=0;l(c[p],function(e){var s=e.regStr,o=e.paramNames,j=-1,m,p=e.name,q=e.callback;if(m=n.match(e.reg)){m.shift();var r=function(){if(o){var a={};l(m,function(b,c){a[o[c]]=b});return a}return[].concat(m)},e=function(){h=s;g=j;i=q;t=r();f=c;k=p;u=m.length};
if(m.length)if(s)j=b(s),j>g?e():j==g&&u>=m.length?m.length<u?e():s.length>h.length&&e():f||e();else return e(),d=1,!1;else return e(),d=1,!1}return a});return d?!1:a});t&&(c=c.query.get(),i.apply(f,[t,c,{path:n,url:location.href}]),c={name:k,paths:t,path:n,url:location.href,query:c},f.fire("route:"+k,c),f.fire("route",c))}function z(b,c,d){var f=c,g=[];return"function"===typeof d?(c=e.escapeRegExp(c),c=c.replace(A,function(b,c,d,e,f){g.push(d||f);return d?"([^/]+)":f?"(.*)":a}),{name:f,paramNames:g,
reg:RegExp("^"+c+"$"),regStr:c,callback:d}):{name:f,reg:d.reg,callback:w(b,d.callback)}}function w(a,b){return"function"!==typeof b&&"string"==typeof b?a[b]:b}function x(a){this[p]={};this.addRoutes(a.newVal)}var l=e.each,A=/(:([\w\d]+))|(\\\*([\w\d]+))/g,j=[],v=e.Env.host,B=g.all,q=B(v),y=v.document.documentMode||e.UA.ie,r=v.history,o=!(!r||!r.pushState),p="__routerMap";return i.extend({initializer:function(){this.on("afterRoutesChange",x,this);x.call(this,{newVal:this.get("routes")});j.push(this)},
addRoutes:function(a){var b=this;l(a,function(a,c){b[p][c]=z(b,c,w(b,a))})}},{ATTRS:{routes:{}},hasRoute:function(b){var c=0;l(j,function(d){l(d[p],function(d){return b.match(d.reg)?(c=1,!1):a});return c?!1:a});return!!c},removeRoot:function(a){return(new e.Uri(a)).getPath().substr(Router.urlRoot.length)},navigate:function(a,b){var b=b||{},e=b.replaceHistory,h;d()!==a?Router.nativeHistory&&o?(r[e?"replaceState":"pushState"]({},"",location.protocol+"//"+location.host+c(Router.urlRoot)+f(a)),k()):(h=
"#!"+a,e?location.replace(h+(y&&8>y?g.REPLACE_HISTORY:"")):location.hash=h):b&&b.triggerRoute&&k()},start:function(b){b=b||{};if(Router.__started)return b.success&&b.success();b.urlRoot=(b.urlRoot||"").replace(/\/$/,"");var e,g=b.nativeHistory,i=location.pathname,j=d(),l=location.hash.match(/#!.+/);e=Router.urlRoot=b.urlRoot;if(Router.nativeHistory=g)if(o)l&&h(i,e)&&(r.replaceState({},"",location.protocol+"//"+location.host+c(Router.urlRoot)+f(j)),b.triggerRoute=1);else if(!h(i,e))return location.replace(c(e)+
"/#!"+j),a;setTimeout(function(){if(g&&o)q.on("popstate",k);else q.on("hashchange",k),b.triggerRoute=1;b.triggerRoute&&k();b.success&&b.success()},100);Router.__started=1;return a},stop:function(){Router.__started=0;q.detach("popstate",k);q.detach("hashchange",k);j=[]}})},{requires:["node","base"]});
KISSY.add("mvc/sync",function(e,g,i){var a={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(b,d,c){var c=e.merge({type:a[d],dataType:"json"},c),f,h;f=c.data=c.data||{};f._method=d;c.url||(h=b.get("url"),c.url="string"==typeof h?h:h.call(b));if("create"==d||"update"==d)f.model=i.stringify(b.toJSON());return g(c)}},{requires:["io","json"]});
KISSY.add("mvc",function(e,g,i,a,b,d){return{sync:d,Model:g,View:a,Collection:i,Router:b}},{requires:["mvc/model","mvc/collection","mvc/view","mvc/router","mvc/sync"]});
