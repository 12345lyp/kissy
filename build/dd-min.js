/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 24 14:19
*/
KISSY.add("dd/ddm",function(h,f,i){function c(){c.superclass.constructor.apply(this,arguments)}function j(d){var a;if(d.touches&&1<d.touches.length)o._end();else if(d.preventDefault(),a=this.__activeToDrag)a._move(d);else if(a=this.get("activeDrag"))a._move(d),this.__needDropCheck&&e(this,d,a)}function b(d){d.preventDefault();B.call(this,d)}function e(d,b,g){var c=d.get("validDrops"),k=g.get("mode"),e=0,f=0,n=l(g.get("node")),p=m(n);h.each(c,function(d){var c;if(c=d.getNodeFromTarget(b,g.get("dragNode")[0],
g.get("node")[0]))if("point"==k)a(l(c),g.mousePos)&&(c=m(l(c)),e?c<f&&(e=d,f=c):(e=d,f=c));else if("intersect"==k)c=m(v(n,l(c))),c>f&&(f=c,e=d);else if("strict"==k&&(c=m(v(n,l(c))),c==p))return e=d,!1});if((c=d.get("activeDrop"))&&c!=e)c._handleOut(b),g._handleOut(b);d.setInternal("activeDrop",e);e&&(c!=e?e._handleEnter(b):e._handleOver(b))}function g(d){d._shim=t('<div style="background-color:red;position:'+(u?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+o.get("dragCursor")+
";z-index:"+C+';"></div>').prependTo(r.body||r.documentElement).css("opacity",0);g=k;if(u)D.on("resize scroll",w,d);k(d)}function k(d){var a=d.get("activeDrag").get("activeHandler"),b="auto";a&&(b=a.css("cursor"));"auto"==b&&(b=d.get("dragCursor"));d._shim.css({cursor:b,display:"block"});u&&w.call(d)}function n(d){var a=d.get("drops");d.setInternal("validDrops",[]);a.length&&h.each(a,function(d){d._active()})}function s(d){var a=d.get("drops");d.setInternal("validDrops",[]);a.length&&h.each(a,function(d){d._deActive()})}
function l(d){var a=d.offset();return{left:a.left,right:a.left+(d.__dd_cached_width||d.outerWidth()),top:a.top,bottom:a.top+(d.__dd_cached_height||d.outerHeight())}}function a(d,a){return d.left<=a.left&&d.right>=a.left&&d.top<=a.top&&d.bottom>=a.top}function m(d){return d.top>=d.bottom||d.left>=d.right?0:(d.right-d.left)*(d.bottom-d.top)}function v(d,a){var b=Math.max(d.top,a.top),c=Math.min(d.right,a.right),m=Math.min(d.bottom,a.bottom);return{left:Math.max(d.left,a.left),right:c,top:b,bottom:m}}
function x(a){a&&(a.__dd_cached_width=a.outerWidth(),a.__dd_cached_height=a.outerHeight())}var p=h.UA,t=f.all,y=h.Env.host,r=y.document,q=t(r),D=t(y),u=6===p.ie,C=999999,f=f.Gesture,z=f.move,A=f.end;c.ATTRS={dragCursor:{value:"move"},clickPixelThresh:{value:3},bufferTime:{value:1},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}};var B=p.ie&&8>p.ie?h.throttle(j,30):j,w=h.throttle(function(){var a;(a=this.get("activeDrag"))&&a.get("shim")&&this._shim.css({width:q.width(),height:q.height()})},
30);h.extend(c,i,{__activeToDrag:0,_regDrop:function(a){this.get("drops").push(a)},_unRegDrop:function(a){var b=this.get("drops"),a=h.indexOf(a,b);-1!=a&&b.splice(a,1)},_regToDrag:function(a){this.__activeToDrag=a;q.on(A,this._end,this);q.on(z,b,this);6===p.ie&&r.body.setCapture()},_start:function(){this.get("drops");var a=this.__activeToDrag;this.setInternal("activeDrag",a);this.__activeToDrag=0;a.get("shim")&&g(this);this.__needDropCheck=0;a.get("groups")&&(n(this),this.get("validDrops").length&&
(x(a.get("node")),this.__needDropCheck=1))},_addValidDrop:function(a){this.get("validDrops").push(a)},_end:function(a){var c=this.__activeToDrag,m=this.get("activeDrag"),g=this.get("activeDrop");a&&(c&&c._move(a),m&&m._move(a));q.detach(z,b,this);q.detach(A,this._end,this);6===p.ie&&r.body.releaseCapture();c&&(c._end(a),this.__activeToDrag=0);this._shim&&this._shim.hide();m&&(m._end(a),s(this),g&&g._end(a),this.setInternal("activeDrag",null),this.setInternal("activeDrop",null))}});var o=new c;o.inRegion=
a;o.region=l;o.area=m;o.cacheWH=x;o.PREFIX_CLS="ks-dd-";return o},{requires:["node","base"]});
KISSY.add("dd/draggable",function(h,f,i,c){function j(){return!1}var b=f.all,e=h.each,g=h.UA.ie,k=c.PREFIX_CLS,n=h.Env.host.document,i=i.extend({initializer:function(){this.addTarget(c);this._allowMove=this.get("move")},_onSetNode:function(a){this.setInternal("dragNode",a);this.bindDragEvent()},bindDragEvent:function(){this.get("node").on(f.Gesture.start,l,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(a){a=this;a.get("node").detach(f.Gesture.start,l,a).detach("dragstart",a._fixDragStart)},
_bufferTimer:null,_onSetDisabledChange:function(a){this.get("dragNode")[a?"addClass":"removeClass"](k+"-disabled")},_fixDragStart:function(a){a.preventDefault()},_checkHandler:function(a){var b=this,c=b.get("handlers"),g=0;e(c,function(c){if(c[0]==a||c.contains(a))return g=1,b.setInternal("activeHandler",c),!1});return g},_checkDragStartValid:function(a){return this.get("primaryButtonOnly")&&1!=a.which||this.get("disabled")?0:1},_prepare:function(a){if(a){var b=this;g&&(s=n.body.onselectstart,n.body.onselectstart=
j);b.get("halt")&&a.stopPropagation();a.preventDefault();var e=a.pageX,k=a.pageY;b.setInternal("startMousePos",b.mousePos={left:e,top:k});if(b._allowMove){var f=b.get("node").offset();b.setInternal("startNodePos",f);b.setInternal("deltaPos",{left:e-f.left,top:k-f.top})}c._regToDrag(b);if(e=b.get("bufferTime"))b._bufferTimer=setTimeout(function(){b._start(a)},1E3*e)}},_clearBufferTimer:function(){this._bufferTimer&&(clearTimeout(this._bufferTimer),this._bufferTimer=0)},_move:function(a){var b=a.pageX,
c=a.pageY;if(!this.get("dragging")){var g=this.get("startMousePos"),e=0,k=this.get("clickPixelThresh");if(Math.abs(b-g.left)>=k||Math.abs(c-g.top)>=k)this._start(a),e=1;if(!e)return}this.mousePos={left:b,top:c};a={pageX:b,pageY:c,drag:this};if(g=this._allowMove)e=this.get("deltaPos"),b-=e.left,c-=e.top,a.left=b,a.top=c,this.setInternal("actualPos",{left:b,top:c}),this.fire("dragalign",a);c=1;!1===this.fire("drag",a)&&(c=0);c&&g&&this.get("node").offset(this.get("actualPos"))},stopDrag:function(){c._end()},
_end:function(a){var a=a||{},b;this._clearBufferTimer();g&&(n.body.onselectstart=s);this.get("dragging")&&(this.get("node").removeClass(k+"drag-over"),(b=c.get("activeDrop"))?this.fire("dragdrophit",{drag:this,drop:b}):this.fire("dragdropmiss",{drag:this}),this.setInternal("dragging",0),this.fire("dragend",{drag:this,pageX:a.pageX,pageY:a.pageY}))},_handleOut:function(){this.get("node").removeClass(k+"drag-over");this.fire("dragexit",{drag:this,drop:c.get("activeDrop")})},_handleEnter:function(a){this.get("node").addClass(k+
"drag-over");this.fire("dragenter",a)},_handleOver:function(a){this.fire("dragover",a)},_start:function(a){this._clearBufferTimer();this.setInternal("dragging",1);this.setInternal("dragStartMousePos",{left:a.pageX,top:a.pageY});c._start();this.fire("dragstart",{drag:this,pageX:a.pageX,pageY:a.pageY})},destructor:function(){this.detachDragEvent();this.detach()}},{name:"Draggable",ATTRS:{node:{setter:function(a){if(!(a instanceof f))return b(a)}},clickPixelThresh:{valueFn:function(){return c.get("clickPixelThresh")}},
bufferTime:{valueFn:function(){return c.get("bufferTime")}},dragNode:{},shim:{value:!1},handlers:{value:[],getter:function(a){var c=this;a.length||(a[0]=c.get("node"));e(a,function(g,e){"function"===typeof g&&(g=g.call(c));"string"==typeof g&&(g=c.get("node").one(g));g.nodeType&&(g=b(g));a[e]=g});c.setInternal("handlers",a);return a}},activeHandler:{},dragging:{value:!1,setter:function(a){this.get("dragNode")[a?"addClass":"removeClass"](k+"dragging")}},mode:{value:"point"},disabled:{value:!1},move:{value:!1},
primaryButtonOnly:{value:!0},halt:{value:!0},groups:{value:!0},startMousePos:{},dragStartMousePos:{},startNodePos:{},deltaPos:{},actualPos:{}}});i.DropMode={POINT:"point",INTERSECT:"intersect",STRICT:"strict"};h.mix(i,i.DropMode);var s,l=function(a){var b=a.target;this._checkDragStartValid(a)&&this._checkHandler(b)&&this._prepare(a)};return i},{requires:["node","rich-base","./ddm"]});
KISSY.add("dd/draggable-delegate",function(h,f,i,c){var j=f.PREFIX_CLS,b=c.all,e=function(c){var e,f;if(this._checkDragStartValid(c)){e=this.get("handlers");var h=b(c.target);(e=e.length?this._getHandler(h):h)&&(f=this._getNode(e));f&&(this.setInternal("activeHandler",e),this.setInternal("node",f),this.setInternal("dragNode",f),this._prepare(c))}};return i.extend({_onSetNode:function(){},_onSetContainer:function(){this.bindDragEvent()},_onSetDisabledChange:function(b){this.get("container")[b?"addClass":
"removeClass"](j+"-disabled")},bindDragEvent:function(){this.get("container").on(c.Gesture.start,e,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.get("container").detach(c.Gesture.start,e,this).detach("dragstart",this._fixDragStart)},_getHandler:function(b){for(var c=void 0,e=this.get("container"),f=this.get("handlers");b&&b[0]!==e[0];){h.each(f,function(e){if(b.test(e))return c=b,!1});if(c)break;b=b.parent()}return c},_getNode:function(b){return b.closest(this.get("selector"),
this.get("container"))}},{ATTRS:{container:{setter:function(c){return b(c)}},selector:{},handlers:{value:[],getter:0}}})},{requires:["./ddm","./draggable","node"]});
KISSY.add("dd/droppable",function(h,f,i,c){var j=c.PREFIX_CLS;return i.extend({initializer:function(){this.addTarget(c);c._regDrop(this)},getNodeFromTarget:function(b,c,g){var b=this.get("node"),f=b[0];return f==c||f==g?null:b},_active:function(){var b=c.get("activeDrag"),e=this.get("node"),g=this.get("groups"),b=b.get("groups");a:if(!0===b)g=1;else{for(var f in g)if(b[f]){g=1;break a}g=0}g?(c._addValidDrop(this),e&&(e.addClass(j+"drop-active-valid"),c.cacheWH(e))):e&&e.addClass(j+"drop-active-invalid")},
_deActive:function(){var b=this.get("node");b&&b.removeClass(j+"drop-active-valid").removeClass(j+"drop-active-invalid")},__getCustomEvt:function(b){return h.mix({drag:c.get("activeDrag"),drop:this},b)},_handleOut:function(){var b=this.__getCustomEvt();this.get("node").removeClass(j+"drop-over");this.fire("dropexit",b)},_handleEnter:function(b){b=this.__getCustomEvt(b);b.drag._handleEnter(b);this.get("node").addClass(j+"drop-over");this.fire("dropenter",b)},_handleOver:function(b){b=this.__getCustomEvt(b);
b.drag._handleOver(b);this.fire("dropover",b)},_end:function(){var b=this.__getCustomEvt();this.get("node").removeClass(j+"drop-over");this.fire("drophit",b)},destructor:function(){c._unRegDrop(this)}},{name:"Droppable",ATTRS:{node:{setter:function(b){if(b)return f.one(b)}},groups:{value:{}}}})},{requires:["node","rich-base","./ddm"]});
KISSY.add("dd/droppable-delegate",function(h,f,i,c){function j(){var b=this.get("container"),c=[],h=this.get("selector");b.all(h).each(function(b){f.cacheWH(b);c.push(b)});this.__allNodes=c}var b=i.extend({initializer:function(){f.on("dragstart",j,this)},getNodeFromTarget:function(b,c,k){var j={left:b.pageX,top:b.pageY},b=this.__allNodes,i=0,l=Number.MAX_VALUE;b&&h.each(b,function(a){var b=a[0];b===k||b===c||(b=f.region(a),f.inRegion(b,j)&&(b=f.area(b),b<l&&(l=b,i=a)))});i&&(this.setInternal("lastNode",
this.get("node")),this.setInternal("node",i));return i},_handleOut:function(){b.superclass._handleOut.apply(this,arguments);this.setInternal("node",0);this.setInternal("lastNode",0)},_handleOver:function(c){var g=this.get("node"),f=b.superclass._handleOut,h=b.superclass._handleOver,i=b.superclass._handleEnter,j=this.get("lastNode");j[0]!==g[0]?(this.setInternal("node",j),f.apply(this,arguments),this.setInternal("node",g),i.call(this,c)):h.call(this,c)},_end:function(){b.superclass._end.apply(this,
arguments);this.setInternal("node",0)}},{ATTRS:{lastNode:{},selector:{},container:{setter:function(b){return c.one(b)}}}});return b},{requires:["./ddm","./droppable","node"]});KISSY.add("dd",function(h,f,i,c,j,b){h={Draggable:i,DDM:f,Droppable:j,DroppableDelegate:b,DraggableDelegate:c};return KISSY.DD=h},{requires:["dd/ddm","dd/draggable","dd/draggable-delegate","dd/droppable","dd/droppable-delegate"]});
