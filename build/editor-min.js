/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 29 17:18
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/iframe-content-tpl",'<!doctype html> <html> <head>{doctype} <title>{title}</title> <style> {style} </style> {links} </head> <body class="ks-editor"> {data} {script} </body> </html>');KISSY.add("editor/render-tpl",'<div class="{{prefixCls}}editor-tools" id="ks-editor-tools-{{id}}"> </div> <\!-- http://johanbrook.com/browsers/native-momentum-scrolling-ios-5/ ios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01 --\> <div class="{{prefixCls}}editor-textarea-wrap" {{#if mobile}} style="overflow:scroll;-webkit-overflow-scrolling:touch;" {{/if}} id="ks-editor-textarea-wrap-{{id}}" > <textarea id="ks-editor-textarea-{{id}}" class="{{prefixCls}}editor-textarea" {{#each textareaAttrs}} {{xkey}}="{{.}}" {{/each}} {{#if mode}} style="display:none" {{/if}} >{{data}}</textarea> </div> <div class="{{prefixCls}}editor-status" id="ks-editor-status-{{id}}"> </div>');
KISSY.add("editor/render",function(a,s,t){return s.getDefaultRender().extend({beforeCreateDom:function(r,l){a.mix(r,{mobile:a.UA.mobile});a.mix(l,{textarea:"#ks-editor-textarea-{id}",toolBarEl:"#ks-editor-tools-{id}",statusBarEl:"#ks-editor-status-{id}"})}},{ATTRS:{contentTpl:{value:t}}})},{requires:["component/control","./render-tpl"]});
KISSY.add("editor/base",function(a,s,t,r){return t.extend({},{Config:{},XHTML_DTD:s.DTD,ATTRS:{textarea:{},textareaAttrs:{view:1},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{view:1},customStyle:{value:""},customLink:{value:[]},xrender:{value:r}},xclass:"editor",name:"EditorRender"})},{requires:["html-parser","component/control","./render"]});
KISSY.add("editor/utils",function(a,s){var t=a.Node,r=a.DOM,l=a.UA,w={debugUrl:function(f){var h=a.Config;h.debug||(f=f.replace(/\.(js|css)/i,"-min.$1"));-1==f.indexOf("?t")&&(f=-1!=f.indexOf("?")?f+"&":f+"?",f+="t="+encodeURIComponent(h.tag));return h.base+"editor/"+f},lazyRun:function(a,h,n){var q=a[h],l=a[n];a[h]=function(){q.apply(this,arguments);a[h]=a[n];return l.apply(this,arguments)}},getXY:function(a,h){var n=a.left,q=a.top,l=h.get("window")[0],n=n-r.scrollLeft(l),q=q-r.scrollTop(l),l=h.get("iframe").offset(),
n=n+l.left,q=q+l.top;return{left:n,top:q}},tryThese:function(a){for(var h,n=0,q=arguments.length;n<q;n++){var l=arguments[n];try{h=l();break}catch(o){}}return h},arrayCompare:function(a,h){if(!a&&!h)return!0;if(!a||!h||a.length!=h.length)return!1;for(var n=0;n<a.length;n++)if(a[n]!==h[n])return!1;return!0},clearAllMarkers:function(a){for(var h in a)a[h]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},isNumber:function(f){return/^\d+(.\d+)?$/.test(a.trim(f))},
verifyInputs:function(f){for(var h=0;h<f.length;h++){var n=new t(f[h]),q=a.trim(w.valInput(n)),l=n.attr("data-verify"),n=n.attr("data-warning");if(l&&!RegExp(l).test(q))return alert(n),!1}return!0},sourceDisable:function(a,h){a.on("sourceMode",h.disable,h);a.on("wysiwygMode",h.enable,h)},resetInput:function(a){var h=a.attr("placeholder");h&&l.ie?(a.addClass("ks-editor-input-tip"),a.val(h)):l.ie||a.val("")},valInput:function(a,h){if(void 0===h)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");
a.val(h)},placeholder:function(f,h){f.attr("placeholder",h);l.ie&&(f.on("blur",function(){a.trim(f.val())||(f.addClass("ks-editor-input-tip"),f.val(h))}),f.on("focus",function(){f.removeClass("ks-editor-input-tip");a.trim(f.val())==h&&f.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(f){var f=a.clone(f),h;for(h in f){var n=f[h];"function"===typeof n&&(f[h]=n())}return f},map:function(a,
h){for(var n=0;n<a.length;n++)a[n]=h(a[n]);return a},ieEngine:document.documentMode||l.ie,preventFocus:function(a){l.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(f){a.mix(r,f);for(var h in f)(function(h){t.prototype[h]=function(){var q=[].slice.call(arguments,0);q.unshift(this[0]);return(q=f[h].apply(null,q))&&(q.nodeType||a.isWindow(q))?new t(q):a.isArray(q)&&(q.__IS_NODELIST||q[0]&&q[0].nodeType)?new t(q):q}})(h)},addRes:function(){var f=this.__res=this.__res||[];
f.push.apply(f,a.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],h=0;h<a.length;h++){var n=a[h];"function"===typeof n?n():n.destroy?n.destroy():n.remove&&n.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,f){return f.toUpperCase()})+"Value"}};return s.Utils=w},{requires:["./base","node"]});
KISSY.add("editor/dom",function(a,s,t){function r(k,e){var a=k[e?"next":"prev"](l,1);if(a&&a[0].nodeType==h.ELEMENT_NODE){for(var b=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemovable(l);)if(b.push(a),a=e?a.next(l,1):a.prev(l,1),!a)return;if(k._4e_isIdentical(a,l)){for(var i=new q(e?k[0].lastChild:k[0].firstChild);b.length;)b.shift()._4e_move(k,!e,l);a._4e_moveChildren(k,!e,l);a.remove();i[0]&&i[0].nodeType==h.ELEMENT_NODE&&i._4e_mergeSiblings()}}}var l=l,w=s.XHTML_DTD,f=a.DOM,h=f.NodeType,n=
a.UA,q=a.Node,x={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};s.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var o=s.POSITION,v={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},y={hr:1},c=function(a){return a&&(a[0]||a)};t.injectDom({_4e_sameLevel:function(a,e){var e=c(e),m=a.parentNode;return m&&m==e.parentNode},_4e_isBlockBoundary:function(k,e){var c=a.merge(y,e);return!(!v[f.css(k,"display")]&&!c[f.nodeName(k)])},_4e_index:function(a,e){for(var c=a.parentNode.childNodes,b,i=-1,d=0;d<c.length;d++)if(b=c[d],!e||!(3==b.nodeType&&b.previousSibling&&3==b.previousSibling.nodeType))if(i++,b===a)return i;return-1},_4e_move:function(a,
e,m){e=c(e);m?e.insertBefore(a,e.firstChild):e.appendChild(a)},_4e_isIdentical:function(a,e){if(!e)return!1;e=c(e);if(f.nodeName(a)!=f.nodeName(e))return!1;var m=a.attributes,b=e.attributes,i=m.length,d=b.length;if(i!=d)return!1;for(var g=0;g<i;g++){var j=m[g],u=j.name;if(j.specified&&f.attr(a,u)!=f.attr(e,u))return!1}if(8>t.ieEngine)for(g=0;g<d;g++)if(j=b[g],u=j.name,j.specified&&f.attr(a,u)!=f.attr(e,u))return!1;return!0},_4e_isEmptyInlineRemovable:function(k){if(!w.$removeEmpty[f.nodeName(k)])return!1;
for(var k=k.childNodes,e=0,c=k.length;e<c;e++){var b=k[e],i=b.nodeType;if(!(i==h.ELEMENT_NODE&&b.getAttribute("_ke_bookmark"))&&(i==h.ELEMENT_NODE&&!f._4e_isEmptyInlineRemovable(b)||i==f.NodeType.TEXT_NODE&&a.trim(b.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,e,m){e=c(e);if(a!=e)if(m)for(;m=a.lastChild;)e.insertBefore(a.removeChild(m),e.firstChild);else for(;m=a.firstChild;)e.appendChild(a.removeChild(m))},_4e_mergeSiblings:function(a){a=new q(a);x[a.nodeName()]&&(r(a,!0),r(a))},_4e_splitText:function(a,
e){var c=a.ownerDocument;if(a.nodeType==f.NodeType.TEXT_NODE){if(n.ie&&e==a.nodeValue.length){var b=c.createTextNode("");f.insertAfter(b,a);return b}b=a.splitText(e);c.documentMode&&(c=c.createTextNode(""),f.insertAfter(c,b),f.remove(c));return b}},_4e_parents:function(a,e){var c=[];c.__IS_NODELIST=1;do c[e?"push":"unshift"](a);while(a=a.parentNode);return c},_4e_nextSourceNode:function(a,e,m,b){if(b&&!b.call)var i=c(b),b=function(a){return a!==i};var e=!e&&a.firstChild,d=a;if(!e){if(a.nodeType==
h.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.nextSibling}for(;!e&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;e=d.nextSibling}return!e||b&&!1===b(e)?null:m&&m!=e.nodeType?f._4e_nextSourceNode(e,!1,m,b):e},_4e_previousSourceNode:function(a,e,m,b){if(b&&!b.call)var i=c(b),b=function(a){return a!==i};var e=!e&&a.lastChild,d=a;if(!e){if(a.nodeType==h.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.previousSibling}for(;!e&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;e=d.previousSibling}return!e||
b&&!1===b(e)?null:m&&e.nodeType!=m?f._4e_previousSourceNode(e,!1,m,b):e},_4e_commonAncestor:function(a,e){e=c(e);if(a===e)return a;if(f.contains(e,a))return e;var m=a;do if(f.contains(m,e))return m;while(m=m.parentNode);return null},_4e_hasAttributes:9>t.ieEngine?function(a){for(var e=a.attributes,c=0;c<e.length;c++){var b=e[c];switch(b.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(a){n.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,e){var m=c(e);if(a.compareDocumentPosition)return a.compareDocumentPosition(m);if(a==m)return o.POSITION_IDENTICAL;if(a.nodeType==h.ELEMENT_NODE&&m.nodeType==h.ELEMENT_NODE){if(f.contains(a,m))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(f.contains(m,a))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>m.sourceIndex?o.POSITION_DISCONNECTED:a.sourceIndex<m.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}for(var b=
f._4e_address(a),m=f._4e_address(m),i=Math.min(b.length,m.length),d=0;d<=i-1;d++)if(b[d]!=m[d])return b[d]<m[d]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;return b.length<m.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(a,e){for(var c=[],b=a.ownerDocument.documentElement,i=a;i&&i!=b;)c.unshift(f._4e_index(i,e)),i=i.parentNode;return c},_4e_remove:function(a,e){var c=a.parentNode;if(c){if(e)for(var b;b=a.firstChild;)c.insertBefore(a.removeChild(b),
a);c.removeChild(a)}return a},_4e_trim:function(a){f._4e_ltrim(a);f._4e_rtrim(a)},_4e_ltrim:function(a){for(var e;e=a.firstChild;){if(e.nodeType==f.NodeType.TEXT_NODE){var c=t.ltrim(e.nodeValue),b=e.nodeValue.length;if(c)c.length<b&&(f._4e_splitText(e,b-c.length),a.removeChild(a.firstChild));else{a.removeChild(e);continue}}break}},_4e_rtrim:function(a){for(var e;e=a.lastChild;){if(e.type==f.NodeType.TEXT_NODE){var c=t.rtrim(e.nodeValue),b=e.nodeValue.length;if(c)c.length<b&&(f._4e_splitText(e,c.length),
a.removeChild(a.lastChild));else{a.removeChild(e);continue}}break}!n.ie&&!n.opera&&(e=a.lastChild)&&1==e.nodeType&&"br"==f.nodeName(e)&&a.removeChild(e)},_4e_appendBogus:function(c){for(var e=c.lastChild;e&&e.nodeType==f.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==f.NodeType.TEXT_NODE||"br"!==f.nodeName(e))e=n.opera?c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br"),c.appendChild(e)},_4e_setMarker:function(c,e,f,b){var c=new q(c),i=c.data("list_marker_id")||
c.data("list_marker_id",a.guid()).data("list_marker_id"),d=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");e[i]=c;d[f]=1;return c.data(f,b)},_4e_clearMarkers:function(a,e,c){var a=new q(a),b=a.data("list_marker_names"),i=a.data("list_marker_id"),d;for(d in b)a.removeData(d);a.removeData("list_marker_names");c&&(a.removeData("list_marker_id"),delete e[i])},_4e_copyAttributes:function(a,e,c){for(var e=new q(e),b=a.attributes,c=c||{},i=0;i<b.length;i++){var d=b[i],
g=d.name.toLowerCase(),j;if(!(g in c))if("checked"==g&&(j=f.attr(a,g)))e.attr(g,j);else if(d.specified||n.ie&&d.value&&"value"==g)j=f.attr(a,g),null===j&&(j=d.nodeValue),e.attr(g,j)}""!==a.style.cssText&&(e[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=f.nodeName(a);return(a=!w.$nonEditable[a]&&(w[a]||w.span))&&a["#text"]},_4e_getByAddress:function(a,e,c){for(var a=a.documentElement,b=0;a&&b<e.length;b++){var i=e[b];if(c)for(var d=-1,g=0;g<a.childNodes.length;g++){var j=a.childNodes[g];
if(!(!0===c&&3==j.nodeType&&j.previousSibling&&3==j.previousSibling.nodeType)&&(d++,d==i)){a=j;break}}else a=a.childNodes[i]}return a}})},{requires:["./base","./utils","node"]});
KISSY.add("editor/focusManager",function(a,s){function t(){var a=this;a.__iframeFocus=n;f=a;w&&clearTimeout(w);w=setTimeout(function(){a.fire("focus")},30)}function r(){var a=this;a.__iframeFocus=q;f=x;w&&clearTimeout(w);w=setTimeout(function(){a.fire("blur")},30)}var l={},w,f,h={refreshAll:function(){for(var a in l){var f=l[a].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return f},getInstance:function(a){return l[a]},add:function(a){a.get("window").on("focus",
t,a).on("blur",r,a)},register:function(a){l[a.get("id")]=a},remove:function(a){delete l[a.get("id")];a.get("window").detach("focus",t,a).detach("blur",r,a)}},n=!0,q=!1,x=null;h.refreshAll=h.refreshAll;s.focusManager=h;s.getInstances=function(){return l};return h},{requires:["./base","./dom"]});
KISSY.add("editor/walker",function(a,s){function t(a,c){if(this._.end)return h;var b,i=this.range,d,g=this.guard,j=this.type,u=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,i.trim(),i.collapsed))return this.end(),h;if(!a&&!this._.guardLTR){var k=i.endContainer[0],n=k.childNodes[i.endOffset];this._.guardLTR=function(a,b){return b&&(k==a||"body"==q.nodeName(a))?!1:a!=n}}if(a&&!this._.guardRTL){var l=i.startContainer[0],r=0<i.startOffset&&l.childNodes[i.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(l==a||"body"==q.nodeName(a))?!1:a!=r}}var J=a?this._.guardRTL:this._.guardLTR;d=g?function(a,b){return J(a,b)===f?f:g(a,b)}:J;this.current?b=this.current[u](f,j,d):a?(b=i.endContainer,0<i.endOffset?(b=new o(b[0].childNodes[i.endOffset-1]),d(b[0])===f&&(b=h)):b=d(b,w)===f?h:b._4e_previousSourceNode(w,j,d,void 0)):(b=i.startContainer,b=new o(b[0].childNodes[i.startOffset]),b.length?d(b[0])===f&&(b=h):b=d(i.startContainer,w)===f?h:i.startContainer._4e_nextSourceNode(w,
j,d,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==f){if(!c)return b}else if(c&&this.evaluator)return f;b=b[u](f,j,d)}this.end();return this.current=h}function r(a){for(var c,b=h;c=t.call(this,a);)b=c;return b}function l(a){this.range=a;this.guard=this.evaluator=h;this._={}}var w=!0,f=!1,h=null,n=a.UA,q=a.DOM,x=s.XHTML_DTD,o=a.Node;a.augment(l,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,w)},checkForward:function(){return t.call(this,
f,w)!==f},checkBackward:function(){return t.call(this,w,w)!==f},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,w)},reset:function(){delete this.current;this._={}},_iterator:t});a.mix(l,{blockBoundary:function(a){return function(c){return!(c.nodeType==q.NodeType.ELEMENT_NODE&&q._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function b(a){return"span"==q.nodeName(a)&&q.attr(a,"_ke_bookmark")}return function(i){var d,g;d=i.nodeType==q.NodeType.TEXT_NODE&&(g=
i.parentNode)&&b(g);d=a?d:d||b(i);return!!(c^d)}},whitespaces:function(c){return function(f){f=f.nodeType==q.NodeType.TEXT_NODE&&!a.trim(f.nodeValue);return!!(c^f)}},invisible:function(a){var c=l.whitespaces();return function(b){b=c(b)||b.nodeType==q.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(a^b)}}});var v=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,y=l.whitespaces(),c=l.bookmark(),k=function(a){var f=q.nodeName(a);return c(a)||y(a)||1==a.nodeType&&f in x.$inline&&!(f in x.$empty)};s.Utils.injectDom({_4e_getBogus:function(a){a=
new o(a);do a=a._4e_previousSourceNode();while(a&&k(a[0]));return a&&(!n.ie?"br"==a.nodeName():3==a[0].nodeType&&v.test(a.text()))?a[0]:!1}});return s.Walker=l},{requires:["./base","./utils","./dom","node"]});
KISSY.add("editor/elementPath",function(a,s){function t(a){for(var q=w,s=w,o=[];a;){if(a[0].nodeType==r.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var v=a.nodeName();if(!s&&(!q&&f[v]&&(q=a),h[v])){var t;if(t=!q)if(t="div"==v){a:{t=a[0].childNodes;for(var c=0,k=t.length;c<k;c++){var e=t[c];if(e.nodeType==r.NodeType.ELEMENT_NODE&&l.$block[e.nodeName.toLowerCase()]){t=!0;break a}}t=!1}t=!t}t?q=a:s=a}o.push(a);if("body"==v)break}a=a.parent()}this.block=q;this.blockLimit=s;this.elements=
o}var r=a.DOM,l=s.XHTML_DTD,w=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},h={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};t.prototype={constructor:t,compare:function(a){var f=this.elements,a=a&&a.elements;if(!a||f.length!=a.length)return!1;for(var h=0;h<f.length;h++)if(!r.equals(f[h],a[h]))return!1;return!0},contains:function(a){for(var f=this.elements,h=0;h<f.length;h++)if(f[h].nodeName()in a)return f[h];return w},toString:function(){var a=
this.elements,f,h=[];for(f=0;f<a.length;f++)h.push(a[f].nodeName());return h.toString()}};return s.ElementPath=t},{requires:["./base","./dom","node"]});
KISSY.add("editor/range",function(a,s,t,r,l){function w(c){var d=c.nodeType!=e.NodeType.TEXT_NODE&&e.nodeName(c)in b.$removeEmpty,i=c.nodeType==e.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return d||i||c}function f(a){return!u(a)&&!C(a)}function h(b){var c=v;return function(d){if(C(d))return o;if(d.nodeType==e.NodeType.TEXT_NODE){if(a.trim(d.nodeValue).length)return v}else if(d.nodeType==e.NodeType.ELEMENT_NODE&&(d=e.nodeName(d),!G[d]))if(!b&&!m.ie&&"br"==
d&&!c)c=o;else return v;return o}}function n(a,b){var c=a.startContainer,p=a.endContainer,d=a.startOffset,j=a.endOffset,f,u=v,h=v,k=void 0,m=a.document,R;0<b&&(k=m.createDocumentFragment());if(a.collapsed)return k;a.optimizeBookmark();p[0].nodeType==e.NodeType.TEXT_NODE?(h=o,p=p._4e_splitText(j)):0<p[0].childNodes.length&&(j>=p[0].childNodes.length?(p=new i(p[0].appendChild(m.createTextNode(""))),R=o):p=new i(p[0].childNodes[j]));c[0].nodeType==e.NodeType.TEXT_NODE?(u=o,c._4e_splitText(d)):d?d>=c[0].childNodes.length?
(c=new i(c[0].appendChild(m.createTextNode(""))),f=o):c=new i(c[0].childNodes[d].previousSibling):(f=new i(m.createTextNode("")),c.prepend(f),c=f,f=o);var H=c._4e_parents(),K=p._4e_parents();H.each(function(a,b){H[b]=a});K.each(function(a,b){K[b]=a});for(var F,O,m=0;m<H.length&&!(F=H[m],O=K[m],!F.equals(O));m++);for(var d=k,A,l,n=m;n<H.length;n++){A=H[n];j=0<b&&!A.equals(c)?d.appendChild(A.clone()[0]):null;A=A[0].nextSibling;l=K[n];for(var C=p[0],q=l&&l[0];A&&!(q==A||C==A);){l=A.nextSibling;if(2==
b)d.appendChild(A.cloneNode(o));else{if(g[A.nodeName.toLowerCase()]){var s=A.cloneNode(o);A.innerHTML="";A=s}else e._4e_remove(A);1==b&&d.appendChild(A)}A=l}j&&(d=j)}for(d=k;m<K.length;m++){A=K[m];j=0<b&&!A.equals(p)?d.appendChild(A.clone()[0]):null;if(!H[m]||!A._4e_sameLevel(H[m]))for(A=A[0].previousSibling;A;)l=A.previousSibling,2==b?d.insertBefore(A.cloneNode(o),d.firstChild):(e._4e_remove(A),1==b&&d.insertBefore(A,d.firstChild)),A=l;j&&(d=j)}if(2==b){if(u&&(F=c[0],F.nodeType==e.NodeType.TEXT_NODE&&
F.nextSibling&&F.nextSibling.nodeType==e.NodeType.TEXT_NODE&&(F.data+=F.nextSibling.data,F.parentNode.removeChild(F.nextSibling))),h)h=p[0],h.nodeType==e.NodeType.TEXT_NODE&&h.previousSibling&&h.previousSibling.nodeType==e.NodeType.TEXT_NODE&&(h.previousSibling.data+=h.data,h.parentNode.removeChild(h))}else{if(F&&O&&(!c._4e_sameLevel(F)||!p._4e_sameLevel(O)))h=F._4e_index(),f&&F._4e_sameLevel(c)&&h--,a.setStart(F.parent(),h+1);a.collapse(o)}f&&c.remove();R&&p.remove();return k}function q(a){a.collapsed=
a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function x(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=y;this.collapsed=o;this.document=a}s.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,v=!1,y=null,c=s.RANGE,k=s.POSITION,e=a.DOM,m=a.UA,b=s.XHTML_DTD,
i=a.Node,d=i.all,g={td:1},j={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},u=new r.whitespaces,C=new r.bookmark,E=r.whitespaces(o),B=r.bookmark(!1,!0),G={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(x,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+
":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},
setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&j[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||
(this.endContainer=a,this.endOffset=b);q(this)},setEnd:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&j[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=b;this.startContainer||(this.startContainer=a,this.startOffset=b);q(this)},setStartAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;
case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}q(this)},setEndAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}q(this)},cloneContents:function(){return n(this,2)},deleteContents:function(){return n(this,
0)},extractContents:function(){return n(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var a=new x(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();
if(a.startContainer[0].nodeType!=e.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!=e.NodeType.ELEMENT_NODE)return y;var b=new r(a);b.evaluator=function(a){return E(a)&&B(a)};a=b.next();b.reset();b=b.previous();return a&&a.equals(b)?a:y},shrink:function(a,b){if(!this.collapsed){var a=a||c.SHRINK_TEXT,d=this.clone(),p=this.startContainer,i=this.endContainer,g=this.startOffset,j=this.endOffset,f=o,h,u,k=o;p&&p[0].nodeType==e.NodeType.TEXT_NODE&&(g?g>=p[0].nodeValue.length?d.setStartAfter(p):(d.setStartBefore(p),
f=v):d.setStartBefore(p));i&&i[0].nodeType==e.NodeType.TEXT_NODE&&(j?j>=i[0].nodeValue.length?d.setEndAfter(i):(d.setEndAfter(i),k=v):d.setEndBefore(i));if(f||k)u=new r(d),u.evaluator=function(b){return b.nodeType==(a==c.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)},u.guard=function(b,d){if(a==c.SHRINK_ELEMENT&&b.nodeType==e.NodeType.TEXT_NODE||d&&b==h)return v;!d&&b.nodeType==e.NodeType.ELEMENT_NODE&&(h=b);return o};f&&(d=u[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(d,
b?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);k&&(u.reset(),(u=u[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(u,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_END));return f||k}},createBookmark2:function(a){var b=this.startContainer,c=this.endContainer,d=this.startOffset,g=this.endOffset,j,f;if(!b||!c)return{start:0,end:0};if(a){if(b[0].nodeType==e.NodeType.ELEMENT_NODE&&(j=new i(b[0].childNodes[d]))&&j[0]&&j[0].nodeType==e.NodeType.TEXT_NODE&&0<d&&j[0].previousSibling.nodeType==
e.NodeType.TEXT_NODE)b=j,d=0;for(;b[0].nodeType==e.NodeType.TEXT_NODE&&(f=b.prev(void 0,1))&&f[0].nodeType==e.NodeType.TEXT_NODE;)b=f,d+=f[0].nodeValue.length;if(!this.collapsed){if(c[0].nodeType==e.NodeType.ELEMENT_NODE&&(j=new i(c[0].childNodes[g]))&&j[0]&&j[0].nodeType==e.NodeType.TEXT_NODE&&0<g&&j[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)c=j,g=0;for(;c[0].nodeType==e.NodeType.TEXT_NODE&&(f=c.prev(void 0,1))&&f[0].nodeType==e.NodeType.TEXT_NODE;)c=f,g+=f[0].nodeValue.length}}return{start:b._4e_address(a),
end:this.collapsed?y:c._4e_address(a),startOffset:d,endOffset:g,normalized:a,is2:o}},createBookmark:function(b){var d,e,p,g,j=this.collapsed;d=new i("<span>",y,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");b&&(p=a.guid("ke_bm_"),d.attr("id",p+"S"));j||(e=d.clone(),e.html("&nbsp;"),b&&e.attr("id",p+"E"),g=this.clone(),g.collapse(),g.insertNode(e));g=this.clone();g.collapse(o);g.insertNode(d);e?(this.setStartAfter(d),this.setEndBefore(e)):this.moveToPosition(d,c.POSITION_AFTER_END);
return{startNode:b?p+"S":d,endNode:b?p+"E":e,serializable:b,collapsed:j}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(o)},trim:function(a,b){var d=this.startContainer,c=this.startOffset,i=this.collapsed;if((!a||i)&&d[0]&&d[0].nodeType==e.NodeType.TEXT_NODE){if(c)if(c>=d[0].nodeValue.length)c=d._4e_index()+1,d=d.parent();else{var g=d._4e_splitText(c),c=d._4e_index()+1,d=d.parent();e.equals(this.startContainer,this.endContainer)?this.setEnd(g,this.endOffset-this.startOffset):e.equals(d,
this.endContainer)&&(this.endOffset+=1)}else c=d._4e_index(),d=d.parent();this.setStart(d,c);if(i){this.collapse(o);return}}d=this.endContainer;c=this.endOffset;!b&&!i&&d[0]&&d[0].nodeType==e.NodeType.TEXT_NODE&&(c?(c>=d[0].nodeValue.length||d._4e_splitText(c),c=d._4e_index()+1):c=d._4e_index(),d=d.parent(),this.setEnd(d,c))},insertNode:function(a){this.optimizeBookmark();this.trim(v,o);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&
this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(b){var c=d(this.document);if(b.is2){var i=c._4e_getByAddress(b.start,b.normalized),p=b.startOffset,c=b.end&&c._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(i,p);c?this.setEnd(c,b):this.collapse(o)}else i=(p=b.serializable)?a.one("#"+b.startNode,c):b.startNode,b=p?a.one("#"+b.endNode,c):b.endNode,this.setStartBefore(i),i._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(o)},getCommonAncestor:function(a,
b){var d=this.startContainer,c=this.endContainer,d=d[0]==c[0]?a&&d[0].nodeType==e.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new i(d[0].childNodes[this.startOffset]):d:d._4e_commonAncestor(c);return b&&d[0].nodeType==e.NodeType.TEXT_NODE?d.parent():d},enlarge:function(){function a(b,c,p,i){var g=b[c?"startContainer":"endContainer"],j,f=c?0:1,h=0,k=c?"previousSibling":"nextSibling";j=b[c?"startOffset":"endOffset"];if(g[0].nodeType==e.NodeType.TEXT_NODE){if(c){if(j)return}else if(j<g[0].nodeValue.length)return;
j=g[0][k];g=g[0].parentNode}else j=g[0].childNodes[j+(c?-1:1)]||null,g=g[0];for(;g;){for(;j;)if(u(j)||C(j))j=j[k];else break;if(j){if(!h)b[c?"setStartAfter":"setEndBefore"](d(j));break}g=d(g);if("body"==g.nodeName())break;if(h||g.equals(i))p[f]=g,h=1;else b[c?"setStartBefore":"setEndAfter"](g);j=g[0][k];g=g[0].parentNode}}return function(b){switch(b){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),g=[];a(this,1,g,b);a(this,0,g,b);g[0]&&g[1]&&(b=g[0].contains(g[1])?g[1]:
g[0],this.setStartBefore(b),this.setEndAfter(b));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var p=new x(this.document),g=new i(this.document.body);p.setStartAt(g,c.POSITION_AFTER_START);p.setEnd(this.startContainer,this.startOffset);var p=new r(p),j,f,h=r.blockBoundary(b==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:y),u=function(a){var b=h(a);b||(j=d(a));return b},k=function(a){var b=u(a);!b&&"br"==e.nodeName(a)&&(f=d(a));return b};p.guard=u;p=p.lastBackward();j=j||g;this.setStartAt(j,
"br"!=j.nodeName()&&(!p&&this.checkStartOfBlock()||p&&j.contains(p))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);p=this.clone();p.collapse();p.setEndAt(g,c.POSITION_BEFORE_END);p=new r(p);p.guard=b==c.ENLARGE_LIST_ITEM_CONTENTS?k:u;j=y;p=p.lastForward();j=j||g;this.setEndAt(j,!p&&this.checkEndOfBlock()||p&&j.contains(p)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);f&&this.setEndAfter(f)}}}(),checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==e.NodeType.TEXT_NODE&&
a.trim(b[0].nodeValue.substring(0,d)).length)return v;this.trim();b=new l(this.startContainer);d=this.clone();d.collapse(o);d.setStartAt(b.block||b.blockLimit,c.POSITION_AFTER_START);b=new r(d);b.evaluator=h(o);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(d)).length)return v;this.trim();b=new l(this.endContainer);d=this.clone();d.collapse(v);d.setEndAt(b.block||b.blockLimit,c.POSITION_BEFORE_END);
b=new r(d);b.evaluator=h(v);return b.checkForward()},checkBoundaryOfElement:function(a,b){var d=this.clone();d[b==c.START?"setStartAt":"setEndAt"](a,b==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);d=new r(d);d.evaluator=w;return d[b==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,p=this.endOffset,g;if(a[0].nodeType==e.NodeType.ELEMENT_NODE)if(g=a[0].childNodes.length,g>c)a=d(a[0].childNodes[c]);else if(0==
g)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=d(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==e.NodeType.ELEMENT_NODE)if(g=b[0].childNodes.length,g>p)b=d(b[0].childNodes[p])._4e_previousSourceNode(o);else if(0==g)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=d(b)}a._4e_position(b)&k.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var g=this.createBookmark(),p=d(this.document.createElement(b));this.collapse(a);
this.enlarge(c.ENLARGE_BLOCK_CONTENTS);p[0].appendChild(this.extractContents());p._4e_trim();m.ie||p._4e_appendBogus();this.insertNode(p);this.moveToBookmark(g);return p},splitBlock:function(b){var d=new l(this.startContainer),g=new l(this.endContainer),p=d.block,i=g.block,e=y;if(!d.blockLimit.equals(g.blockLimit))return y;"br"!=b&&(p||(p=this.fixBlock(o,b),i=(new l(this.endContainer)).block),i||(i=this.fixBlock(v,b)));b=p&&this.checkStartOfBlock();d=i&&this.checkEndOfBlock();this.deleteContents();
p&&p[0]==i[0]&&(d?(e=new l(this.startContainer),this.moveToPosition(i,c.POSITION_AFTER_END),i=y):b?(e=new l(this.startContainer),this.moveToPosition(p,c.POSITION_BEFORE_START),p=y):(i=this.splitElement(p),!m.ie&&!a.inArray(p.nodeName(),["ul","ol"])&&p._4e_appendBogus()));return{previousBlock:p,nextBlock:i,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:e}},splitElement:function(a){if(!this.collapsed)return y;this.setEndAt(a,c.POSITION_BEFORE_END);var b=this.extractContents(),d=a.clone(v);d[0].appendChild(b);
d.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(a,b){for(var d=0;a;){if(a[0].nodeType==e.NodeType.TEXT_NODE){this.moveToPosition(a,b?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);d=1;break}a[0].nodeType==e.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_START),d=1);var g=a,i=d,j=void 0;g[0].nodeType==e.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(j=g[b?"last":"first"](f,1));!i&&
!j&&(j=g[b?"prev":"next"](f,1));a=j}return!!d},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==e.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var d,c,g,i=a.nodeName();d=b.$block[i];this.deleteContents();if(d){for(d=this.getCommonAncestor(v,o);(c=b[d.nodeName()])&&(!c||!c[i]);){var e=d.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(d),this.collapse(o),d.remove()):g=d;d=e}g&&this.splitElement(g)}this.insertNode(a)}});
t.injectDom({_4e_breakParent:function(a,b){var b=d(b),a=d(a),c,g=new s.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(b);c=g.extractContents();g.insertNode(a.remove());a.after(c)}});return s.Range=x},{requires:"./base,./utils,./walker,./elementPath,./dom,node".split(",")});
KISSY.add("editor/selection",function(a,s){function t(a){this.document=a;this._={cache:{}};if(o)try{var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=a||c.parentElement&&c.parentElement().ownerDocument!=a)this.isInvalid=l}catch(d){this.isInvalid=l}}function r(a){a=new t(a);return!a||a.isInvalid?w:a}s.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var l=!0,w=null,f=a.UA,h=a.DOM,n=a.Node,q=s.SELECTION,x=s.RANGE,o=f.ie,v=s.Walker,y=s.Range,c={img:1,hr:1,
li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(t,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=h.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var a=this._.cache;if(a.type)return a.type;var i=q.SELECTION_TEXT,d=this.getNative();if(d){if(1==d.rangeCount){var d=d.getRangeAt(0),
g=d.startContainer;g==d.endContainer&&g.nodeType==h.NodeType.ELEMENT_NODE&&1==Number(d.endOffset-d.startOffset)&&c[g.childNodes[d.startOffset].nodeName.toLowerCase()]&&(i=q.SELECTION_ELEMENT)}}else i=q.SELECTION_NONE;return a.type=i}:function(){var a=this._.cache;if(a.type)return a.type;var c=q.SELECTION_NONE;try{var d=this.getNative(),g=d.type;"Text"==g&&(c=q.SELECTION_TEXT);"Control"==g&&(c=q.SELECTION_ELEMENT);d.createRange().parentElement&&(c=q.SELECTION_TEXT)}catch(e){}return a.type=c},getRanges:o?
function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),e=c.childNodes,f,k=0;k<e.length;k++){var m=e[k];if(m.nodeType==h.NodeType.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(m);var m=f.compareEndPoints("StartToStart",a),o=f.compareEndPoints("EndToStart",a);f.collapse();if(0<m)break;else{if(!m||1==o&&-1==m)return{container:c,offset:k};if(!o)return{container:c,offset:k+1}}f=w}}f||(f=a.duplicate(),f.moveToElementText(c),f.collapse(!1));f.setEndPoint("StartToStart",
a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<f;)f-=e[--k].nodeValue.length}catch(l){f=0}return 0===f?{container:c,offset:k}:{container:e[k],offset:-f}};return function(c){var d=this._.cache;if(d.ranges&&!c)return d.ranges;var g=this.getNative(),c=g&&g.createRange(),e=this.getType();if(!g)return[];if(e==q.SELECTION_TEXT)return g=new y(this.document),e=a(c,l),g.setStart(new n(e.container),e.offset),e=a(c),g.setEnd(new n(e.container),e.offset),d.ranges=[g];if(e==q.SELECTION_ELEMENT){d=
d.ranges=[];for(e=0;e<c.length;e++){for(var f=c.item(e),h=f.parentNode,k=0,g=new y(this.document);k<h.childNodes.length&&h.childNodes[k]!=f;k++);g.setStart(new n(h),k);g.setEnd(new n(h),k+1);d.push(g)}return d}return d.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],d=this.getNative();if(!d)return[];for(var g=0;g<d.rangeCount;g++){var e=d.getRangeAt(g),f=new y(this.document);f.setStart(new n(e.startContainer),e.startOffset);f.setEnd(new n(e.endContainer),e.endOffset);
a.push(f)}return c.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var c,d=this.getNative();switch(this.getType()){case q.SELECTION_ELEMENT:return this.getSelectedElement();case q.SELECTION_TEXT:var g=this.getRanges()[0];if(g&&!g.collapsed){for(g.optimize();l;)if(c=g.startContainer,g.startOffset==(c[0].nodeType===h.NodeType.ELEMENT_NODE?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())g.setStartAfter(c);else break;c=g.startContainer;
if(c[0].nodeType!=h.NodeType.ELEMENT_NODE)return c.parent();c=new n(c[0].childNodes[g.startOffset]);if(!c[0]||c[0].nodeType!=h.NodeType.ELEMENT_NODE)return g.startContainer;for(g=c[0].firstChild;g&&g.nodeType==h.NodeType.ELEMENT_NODE;)c=new n(g),g=g.firstChild;return c}if(o)g=d.createRange(),g.collapse(l),c=new n(g.parentElement());else{if((c=d.anchorNode)&&c.nodeType!=h.NodeType.ELEMENT_NODE)c=c.parentNode;c&&(c=new n(c))}}return a.startElement=c},getSelectedElement:function(){var a,e=this._.cache;
if(void 0!==e.selectedElement)return e.selectedElement;o&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var d;if(a)d=new n(a);else{a=this.getRanges()[0];for(var g,f=2;f&&(!(d=a.getEnclosedNode())||!(d[0].nodeType==h.NodeType.ELEMENT_NODE&&c[d.nodeName()]&&(g=d)));f--)a.shrink(x.SHRINK_ELEMENT);d=g}return e.selectedElement=d},reset:function(){this._.cache={}},selectElement:function(a){var c,d=this.document;if(o)try{c=d.body.createControlRange(),c.addElement(a[0]),c.select()}catch(g){c=d.body.createTextRange(),
c.moveToElementText(a[0]),c.select()}finally{}else c=d.createRange(),c.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(c);this.reset()},selectRanges:function(a){if(o){if(1<a.length){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset);a.length=1}a[0]&&a[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var d=0;d<a.length;d++){var g=a[d],e=this.document.createRange(),k=g.startContainer;if(g.collapsed&&(f.gecko&&1.09>f.gecko||f.opera||f.webkit)&&k[0].nodeType==
h.NodeType.ELEMENT_NODE&&!k[0].childNodes.length)k[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),g.startOffset++,g.endOffset++;e.setStart(k[0],g.startOffset);e.setEnd(g.endContainer[0],g.endOffset);c.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var c=[],d=this.getRanges(),g=0;g<d.length;g++)c.push(d[g].createBookmark2(a));return c},createBookmarks:function(c,e){for(var d=[],g=this.document,f,e=e||this.getRanges(),k=e.length,m=0;m<k;m++){d.push(f=e[m].createBookmark(c,
l));var o=(c=f.serializable)?a.one("#"+f.startNode,g):f.startNode;f=c?a.one("#"+f.endNode,g):f.endNode;for(var n=m+1;n<k;n++){var q=e[n],s=q.startContainer,r=q.endContainer;h.equals(s,o.parent())&&q.startOffset++;h.equals(s,f.parent())&&q.startOffset++;h.equals(r,o.parent())&&q.endOffset++;h.equals(r,f.parent())&&q.endOffset++}}return d},selectBookmarks:function(a){for(var c=[],d=0;d<a.length;d++){var e=new y(this.document);e.moveToBookmark(a[d]);c.push(e)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var k={table:1,tbody:1,tr:1},e=v.whitespaces(l),m=/\ufeff|\u00a0/;y.prototype.select=y.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
h.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var c=this.document.createRange();c.setStart(a[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(l),c.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=r(this.document).getNative();a.removeAllRanges();a.addRange(c)}:function(a){var c=this.collapsed,
d,g;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==h.NodeType.ELEMENT_NODE){(new t(this.document)).selectElement(new n(f));return}}(this.startContainer[0].nodeType==h.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in k||this.endContainer[0].nodeType==h.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in k)&&this.shrink(x.SHRINK_ELEMENT,l);var u=this.createBookmark(),f=u.startNode,
o;c||(o=u.endNode);u=this.document.body.createTextRange();u.moveToElementText(f[0]);u.moveStart("character",1);if(o)a=this.document.body.createTextRange(),a.moveToElementText(o[0]),u.setEndPoint("EndToEnd",a),u.moveEnd("character",-1);else{for(d=f[0].nextSibling;d&&!e(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(m))&&(a||!f[0].previousSibling||f[0].previousSibling&&"br"==h.nodeName(f[0].previousSibling));g=new n(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(f);
d&&h.insertBefore(this.document.createTextNode("\ufeff"),f[0]||f)}this.setStartBefore(f);f._4e_remove();if(c){if(d?(u.moveStart("character",-1),u.select(),this.document.selection.clear()):u.select(),g)this.moveToPosition(g,x.POSITION_BEFORE_START),g._4e_remove()}else this.setEndBefore(o),o._4e_remove(),u.select()};t.getSelection=r;return s.Selection=t},{requires:["./base","./walker","./range","./dom","node"]});
KISSY.add("editor/domIterator",function(a,s){function t(a){1>arguments.length||(this.range=a,this.forceBrBreak=l,this.enlargeBr=r,this.enforceRealBlocks=l,this._||(this._={}))}var r=!0,l=!1,w=a.UA,f=s.Walker,h=s.Range,n=s.RANGE,q=s.ElementPath,x=a.Node,o=a.DOM,v=/^[\r\n\t ]*$/;a.augment(t,{getNextParagraph:function(s){var c,k,e,m,b;if(!this._.lastNode){k=this.range.clone();k.shrink(n.SHRINK_ELEMENT,r);k.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var i=new f(k),d=f.bookmark(r,r);i.evaluator=d;this._.nextNode=i.next();i=new f(k);i.evaluator=d;i=i.previous();this._.lastNode=i._4e_nextSourceNode(r);this._.lastNode&&this._.lastNode[0].nodeType==o.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(d=new h(k.document),d.moveToPosition(this._.lastNode,n.POSITION_AFTER_END),d.checkEndOfBlock()&&(d=new q(d.endContainer),this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(r)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new x(k.document.createTextNode("")),o.insertAfter(this._.lastNode[0],i[0]));k=null}d=this._.nextNode;i=this._.lastNode;for(this._.nextNode=null;d;){var g=l,j=d[0].nodeType!=o.NodeType.ELEMENT_NODE,u=l;if(j)d[0].nodeType==o.NodeType.TEXT_NODE&&v.test(d[0].nodeValue)&&(j=l);else{var t=d.nodeName();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==t)j=r;else if(!k&&!d[0].childNodes.length&&"hr"!=t){c=d;e=d.equals(i);break}k&&(k.setEndAt(d,n.POSITION_BEFORE_START),
"br"!=t&&(this._.nextNode=d));g=r}else{if(d[0].firstChild){k||(k=new h(this.range.document),k.setStartAt(d,n.POSITION_BEFORE_START));d=new x(d[0].firstChild);continue}j=r}}j&&!k&&(k=new h(this.range.document),k.setStartAt(d,n.POSITION_BEFORE_START));e=(!g||j)&&d.equals(i);if(k&&!g)for(;!d[0].nextSibling&&!e;){t=d.parent();if(t._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){g=r;e||t.equals(i);break}d=t;j=r;e=d.equals(i);u=r}j&&k.setEndAt(d,n.POSITION_AFTER_END);d=d._4e_nextSourceNode(u,null,i);if((e=
!d)||g&&k)break}if(!c){if(!k)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new q(k.startContainer);d=c.blockLimit;g={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&g[d.nodeName()]&&k.checkStartOfBlock()&&k.checkEndOfBlock())c=d;else if(!c||this.enforceRealBlocks&&"li"==c.nodeName())c=new x(this.range.document.createElement(s||"p")),c[0].appendChild(k.extractContents()),c._4e_trim(),k.insertNode(c),m=b=r;else if("li"!=c.nodeName()){if(!k.checkStartOfBlock()||
!k.checkEndOfBlock())c=c.clone(l),c[0].appendChild(k.extractContents()),c._4e_trim(),b=k.splitBlock(),m=!b.wasStartOfBlock,b=!b.wasEndOfBlock,k.insertNode(c)}else e||(this._.nextNode=c.equals(i)?null:k.getBoundaryNodes().endNode._4e_nextSourceNode(r,null,i))}m&&(k=new x(c[0].previousSibling),k[0]&&k[0].nodeType==o.NodeType.ELEMENT_NODE&&("br"==k.nodeName()?k._4e_remove():k[0].lastChild&&"br"==o.nodeName(k[0].lastChild)&&o._4e_remove(k[0].lastChild)));b&&(k=f.bookmark(l,r),m=new x(c[0].lastChild),
m[0]&&m[0].nodeType==o.NodeType.ELEMENT_NODE&&"br"==m.nodeName()&&(w.ie||m.prev(k,1)||m.next(k,1))&&m.remove());this._.nextNode||(this._.nextNode=e||c.equals(i)?null:c._4e_nextSourceNode(r,null,i));return c}});h.prototype.createIterator=function(){return new t(this)};return t},{requires:["./base","./range","./elementPath","./walker","node"]});
KISSY.add("editor/styles",function(a,s){function t(a){return!E.attr(a,"_ke_bookmark")}function r(a,c){for(var d in a)"string"==typeof a[d]?a[d]=a[d].replace(S,function(a,d){return c[d]}):r(a[d],c)}function l(c,d){d&&(c=a.clone(c),r(c,d));var b=this.element=this.element=(c.element||"*").toLowerCase();this.type=this.type="#text"==b||I[b]?B.STYLE_BLOCK:P[b]?B.STYLE_OBJECT:B.STYLE_INLINE;this._={definition:c}}function w(a,c){var d=c?this.removeFromRange:this.applyToRange;a.body.focus();for(var b=new J(a),
e=b.getRanges(),g=0;g<e.length;g++)d.call(this,e[g]);b.selectRanges(e)}function f(a,c,d){var b=a.element;"*"==b&&(b="span");c=new p(c.createElement(b));d&&d._4e_copyAttributes(c);d=a._.definition;a=d.attributes;d=l.getStyleText(d);if(a)for(var e in a)c.attr(e,a[e]);d&&(c[0].style.cssText=d);return c}function h(a){var c=a.createBookmark(g),d=a.createIterator();d.enforceRealBlocks=g;d.enlargeBr=g;for(var b,e=a.document;b=d.getNextParagraph();){var j=f(this,e,b),i=j,j="pre"==i.nodeName,k="pre"==b.nodeName,
h=!j&&k;j&&!k?(k=b,h=k.html(),h=n(h,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),h=h.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),h=h.replace(/([ \t\n\r]+|&nbsp;)/g," "),h=h.replace(/<br\b[^>]*>/gi,"\n"),N.ie?(k=k[0].ownerDocument.createElement("div"),k.appendChild(i[0]),i.outerHtml("<pre>"+h+"</pre>"),i=new p(k.firstChild),i._4e_remove()):i.html(h)):h?i=x(q(b),i):b._4e_moveChildren(i);b[0].parentNode.replaceChild(i[0],b[0]);if(j&&(b=i,j=void 0,(j=b._4e_previousSourceNode(g,E.NodeType.ELEMENT_NODE))&&
"pre"==j.nodeName()))i=n(j.html(),/\n$/,"")+"\n\n"+n(b.html(),/^\n/,""),N.ie?b.outerHtml("<pre>"+i+"</pre>"):b.html(i),j._4e_remove()}a.moveToBookmark(c)}function n(a,c,d){var b="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,d){c&&(b=c);d&&(e=d);return""});return b+a.replace(c,d)+e}function q(a){var c=[];n(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,c,d){return c+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,d){c.push(d)});return c}function x(a,c){for(var d=c[0].ownerDocument.createDocumentFragment(),b=0;b<a.length;b++){var e=a[b],e=e.replace(/(\r\n|\r)/g,"\n"),e=n(e,/^[ \t]*\n/,""),e=n(e,/\n$/,""),e=n(e,/^[ \t]+|[ \t]+$/g,function(a,c){return 1==a.length?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),g=c.clone();g.html(e);d.appendChild(g[0])}return d}
function o(a){var c=a.document;if(a.collapsed)c=f(this,c,void 0),a.insertNode(c),a.moveToPosition(c,G.POSITION_BEFORE_END);else{var d=this.element,e=this._.definition,i,h=L[d];h||(i=g,h=L.span);var k=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var m=a.createBookmark(),o=m.startNode,m=m.endNode,l=o,n;l&&l[0];){var z=j;if(E.equals(l,m))l=u,z=g;else{var q=l[0].nodeType,s=q==E.NodeType.ELEMENT_NODE?l.nodeName():u;if(s&&l.attr("_ke_bookmark")){l=l._4e_nextSourceNode(g);continue}if(!s||
h[s]&&(l._4e_position(m)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(l))){var r=l.parent();if(r&&"a"==d&&r.nodeName()==d)q=f(this,c,void 0),r._4e_moveChildren(q),r[0].parentNode.replaceChild(q[0],r[0]),q._4e_mergeSiblings();else if(r&&r[0]&&((L[r.nodeName()]||L.span)[d]||i)&&(!e.parentRule||e.parentRule(r))){if(!n&&(!s||!L.$removeEmpty[s]||(l._4e_position(m)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|
D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED))n=new M(c),n.setStartBefore(l);if(q==E.NodeType.TEXT_NODE||q==E.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){r=l;for(q=null;(z=!r.next(t,1))&&(q=r.parent())&&h[q.nodeName()]&&(q._4e_position(o)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(q));)r=q;n.setEndAfter(r)}}else z=g}else z=g;l=l._4e_nextSourceNode()}if(z&&
n&&!n.collapsed){for(var z=f(this,c,void 0),r=n.getCommonAncestor(),q={},s={},I,v=null,C;z&&r&&z[0]&&r[0];){if(r.nodeName()==d){for(I in e.attributes)if(!s[I]&&(C=r.attr(v)))z.attr(I)==C?z.removeAttr(I):s[I]=1;for(v in e.styles)if(!q[v]&&(C=r.style(v)))z.style(v)==C?z.style(v,""):q[v]=1;if(!z._4e_hasAttributes()){z=u;break}}r=r.parent()}z?(z[0].appendChild(n.extractContents()),b(this,z),n.insertNode(z),z._4e_mergeSiblings(),N.ie||z[0].normalize()):(z=new p(c.createElement("span")),z[0].appendChild(n.extractContents()),
n.insertNode(z),b(this,z),z._4e_remove(!0));n=u}}o._4e_remove();m._4e_remove();a.moveToBookmark(k);a.shrink(G.SHRINK_TEXT)}}function v(a){a.enlarge(G.ENLARGE_ELEMENT);var c=a.createBookmark(),d=c.startNode;if(a.collapsed){for(var b=new z(d.parent()),g,f=0,j;f<b.elements.length&&(j=b.elements[f])&&!(j==b.block||j==b.blockLimit);f++)if(this.checkElementRemovable(j)){var h=a.checkBoundaryOfElement(j,G.END),m=!h&&a.checkBoundaryOfElement(j,G.START);m||h?(g=j,g.match=m?"start":"end"):(j._4e_mergeSiblings(),
j.nodeName()!=this.element?(h=k(this),i(j,h[j.nodeName()]||h["*"])):e(this,j))}if(g){j=d;for(f=0;;f++){h=b.elements[f];if(h.equals(g))break;else if(h.match)continue;else h=h.clone();h[0].appendChild(j[0]);j=h}j["start"==g.match?"insertBefore":"insertAfter"](g);b=g.html();!b||"\u200b"==b?g.remove():N.webkit&&C(a.document.createTextNode("\u200b")).insertBefore(j)}}else{var o=c.endNode,l=this;g=function(){for(var a=new z(d.parent()),c=new z(o.parent()),b=u,e=u,g=0;g<a.elements.length;g++){var f=a.elements[g];
if(f==a.block||f==a.blockLimit)break;l.checkElementRemovable(f)&&(b=f)}for(g=0;g<c.elements.length;g++){f=c.elements[g];if(f==c.block||f==c.blockLimit)break;l.checkElementRemovable(f)&&(e=f)}e&&o._4e_breakParent(e);b&&d._4e_breakParent(b)};g();for(b=new p(d[0].nextSibling);b[0]!==o[0];){f=b._4e_nextSourceNode();if(b[0]&&b[0].nodeType==E.NodeType.ELEMENT_NODE&&this.checkElementRemovable(b)&&(b.nodeName()==this.element?e(this,b):(j=k(this),i(b,j[b.nodeName()]||j["*"])),f[0].nodeType==E.NodeType.ELEMENT_NODE&&
f.contains(d)))g(),f=new p(d[0].nextSibling);b=f}}a.moveToBookmark(c)}function y(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,d,b){c[d]=b});return c}function c(a,c){var d="";c!==j?(d=document.createElement("span"),d.style.cssText=a,d=d.style.cssText||""):d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function k(c){if(c._.overrides)return c._.overrides;var d=c._.overrides={},b=c._.definition.overrides;
if(b){a.isArray(b)||(b=[b]);for(var e=0;e<b.length;e++){var g=b[e],f,p,j;"string"==typeof g?f=g.toLowerCase():(f=g.element?g.element.toLowerCase():c.element,p=g.attributes,j=g.styles);g=d[f]||(d[f]={});if(p){f=g.attributes=g.attributes||[];for(var h in p)f.push([h.toLowerCase(),p[h]])}if(j){var g=g.styles=g.styles||[],i;for(i in j)g.push([i.toLowerCase(),j[i]])}}}return d}function e(c,b){var e=c._.definition,f=k(c),p=a.merge(e.attributes,(f[b.nodeName()]||f["*"]||{}).attributes),e=a.merge(e.styles,
(f[b.nodeName()]||f["*"]||{}).styles),f=a.isEmptyObject(p)&&a.isEmptyObject(e),j;for(j in p)("class"==j||c._.definition.fullMatch)&&b.attr(j)!=m(j,p[j])||(f=f||!!b.hasAttr(j),b.removeAttr(j));for(var h in e)c._.definition.fullMatch&&b.style(h)!=m(h,e[h],g)||(f=f||!!b.style(h),b.style(h,""));d(b)}function m(a,c,d){var b=new p("<span>");b[d?"style":"attr"](a,c);return b[d?"style":"attr"](a)}function b(a,c){for(var d=k(a),b=c.all(a.element),g=b.length;0<=--g;)e(a,new p(b[g]));for(var f in d)if(f!=a.element){b=
c.all(f);for(g=b.length-1;0<=g;g--){var j=new p(b[g]);i(j,d[f])}}}function i(a,c){var b,e=c&&c.attributes;if(e)for(b=0;b<e.length;b++){var g=e[b][0],f;if(f=a.attr(g)){var p=e[b][1];(p===u||p.test&&p.test(f)||"string"==typeof p&&f==p)&&a[0].removeAttribute(g)}}if(e=c&&c.styles)for(b=0;b<e.length;b++)if(g=e[b][0],p=a.css(g)){var j=e[b][1];(j===u||j.test&&j.test(f)||"string"==typeof j&&p==j)&&a.css(g,"")}d(a)}function d(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(g);
c&&(c.nodeType==E.NodeType.ELEMENT_NODE&&E._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==E.NodeType.ELEMENT_NODE&&E._4e_mergeSiblings(b))}}var g=!0,j=!1,u=null,C=a.all,E=a.DOM,B={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=s.RANGE,J=s.Selection,D=s.POSITION,M=s.Range,p=a.Node,N=a.UA,z=s.ElementPath,I={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=s.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;s.STYLE=
B;l.prototype={constructor:l,apply:function(a){w.call(this,a,j)},remove:function(a){w.call(this,a,g)},applyToRange:function(a){return(this.applyToRange=this.type==B.STYLE_INLINE?o:this.type==B.STYLE_BLOCK?h:u).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==B.STYLE_INLINE?v:u).call(this,a)},checkElementRemovable:function(a,b){if(!a)return j;var d=this._.definition,e;if(a.nodeName()==this.element){if(!b&&!a._4e_hasAttributes())return g;var f=d._AC;if(f)d=f;else{var f=
{},p=0,h=d.attributes;if(h)for(var i in h)p++,f[i]=h[i];if(h=l.getStyleText(d))f.style||p++,f.style=h;f._length=p;d=d._AC=f}if(d._length){for(var m in d)if("_length"!=m){p=a.attr(m)||"";if("style"==m)a:{f=d[m];p=c(p,j);"string"==typeof f&&(f=y(f));"string"==typeof p&&(p=y(p));h=void 0;for(h in f)if(!(h in p&&(p[h]==f[h]||"inherit"==f[h]||"inherit"==p[h]))){f=j;break a}f=g}else f=d[m]==p;if(f){if(!b)return g}else if(b)return j}if(b)return g}else return g}m=k(this);if(m=m[a.nodeName()]||m["*"]){if(!(d=
m.attributes)&&!(e=m.styles))return g;if(d)for(f=0;f<d.length;f++)if(m=d[f][0],m=a.attr(m))if(p=d[f][1],p===u||"string"==typeof p&&m==p||p.test&&p.test(m))return g;if(e)for(f=0;f<e.length;f++)if(m=a.css(e[f][0]))if(d=e[f][1],d===u||"string"==typeof d&&m==d||d.test&&d.test(m))return g}return j},checkActive:function(a){switch(this.type){case B.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,g);case B.STYLE_OBJECT:case B.STYLE_INLINE:for(var c=a.elements,b=0,d;b<c.length;b++)if(d=
c[b],!(this.type==B.STYLE_INLINE&&(E.equals(d,a.block)||E.equals(d,a.blockLimit))))if((this.type!=B.STYLE_OBJECT||d.nodeName()in P)&&this.checkElementRemovable(d,g))return g}return j}};l.getStyleText=function(a){var d=a._ST;if(d)return d;var d=a.styles,b=a.attributes&&a.attributes.style||"",e="";b.length&&(b=b.replace(Q,";"));for(var g in d){var f=d[g],p=(g+":"+f).replace(Q,";");"inherit"==f?e+=p:b+=p}b.length&&(b=c(b));return a._ST=b+e};return s.Style=l},{requires:"./base,./range,./selection,./domIterator,./elementPath,node".split(",")});
KISSY.add("editor/zIndexManager",function(a,s){var t=s.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};s.baseZIndex=function(a){return(s.Config.baseZIndex||1E4)+a};return t},{requires:["./base"]});
KISSY.add("editor/clipboard",function(a,s,t,r){function l(a){this.editor=a;this._init()}function w(a){var h=a.get("document")[0],e=a.getSelection(),m;if(e.getType()==r.SELECTION_ELEMENT&&(m=e.getSelectedElement())){var a=e.getRanges()[0],b=f(h.createTextNode(""));b.insertBefore(m);a.setStartBefore(b);a.setEndAfter(m);e.selectRanges([a]);setTimeout(function(){m.parent()&&(b.remove(),e.selectElement(m))},0)}}var f=a.all,h=a.UA,n=h.ie?"beforepaste":"paste",q=s.RANGE;a.augment(l,{_init:function(){var a=
this,f=a.editor,e=f.get("document"),m=e.one("body"),b=function(a){this.type=a};b.prototype={exec:function(b){var d=this.type;b.focus();setTimeout(function(){h.ie&&("cut"==d?w(b):"paste"==d&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));o(b,d)||alert(v[d])},0)}};m.on(n,a._getClipboardDataFromPasteBin,a);h.ie&&(m.on("paste",a._iePaste,a),e.on("keydown",a._onKeyDown,a),e.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));f.addCommand("copy",
new b("copy"));f.addCommand("cut",new b("cut"));f.addCommand("paste",new b("paste"))},_onKeyDown:function(a){this.editor.get("mode")==s.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var f,e=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{f=e.get("document")[0].queryCommandEnabled(a)}catch(h){}this._isPreventBeforePaste=0}else f=(a=(a=e.getSelection())&&a.getRanges())&&!(1==a.length&&a[0].collapsed);
return f},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var f=this.editor;this._isPreventPaste||(a.preventDefault(),f.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var c=this.editor,k=c.get("document")[0];if(!k.getElementById("ke_pastebin")){var e=c.getSelection(),m=new t(k),b=f(h.webkit?
"<body></body>":"<div></div>",k);b.attr("id","ke_pastebin");h.webkit&&b[0].appendChild(k.createTextNode("\u200b"));k.body.appendChild(b[0]);b.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});b.css("left","-1000px");var i=e.createBookmarks();m.setStartAt(b,q.POSITION_AFTER_START);m.setEndAt(b,q.POSITION_BEFORE_END);m.select(!0);setTimeout(function(){var d,f=b;b=h.webkit&&(d=b.first())&&d.hasClass("Apple-style-span")?d:b;e.selectBookmarks(i);
var j=b.html();f.remove();if(j=a.trim(j.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,"")))d=c.fire("paste",{html:j}),!1!==d&&(void 0!==d&&(j=d),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(j)?a.use("editor/plugin/word-filter",function(a,b){c.insertHtml(b.toDataFormat(j,c))}):c.insertHtml(j))},0)}}}});var x=function(a,k){var e=a.get("document")[0],m=f(e.body),b=!1,i=function(){b=!0};m.on(k,i);(7<h.ie?e:e.selection.createRange()).execCommand(k);m.detach(k,i);return b},o=h.ie?
function(a,f){return x(a,f)}:function(a,f){try{return a.get("document")[0].execCommand(f)}catch(e){return!1}},v={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},y={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var f;a.docReady(function(){f=new l(a)});var e={copy:1,cut:1,paste:1},h=["copy","cut","paste"];a.on("contextmenu",function(b){var i=b.contextmenu;if(!i.__copy_fix){i.__copy_fix=
1;for(b=0;b<h.length;b++)i.addChild({content:y[h[b]],value:h[b]});i.on("click",function(b){var d=b.target.get("value");e[d]&&(i.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(d);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var d=i.get("children"),b=d.length-1;b--;0<=b){var g=d[b],j;j=g.get?g.get("value"):g.value;e[j]&&(j=!f._stateFromNamedCommand(j),g.set?g.set("disabled",j):g.disabled=j)}})}}},{requires:["./base","./range","./selection","node"]});
KISSY.add("editor/enterKey",function(a,s,t,r){function l(o){var l;l=o.getSelection().getRanges();for(var s=l.length-1;0<s;s--)l[s].deleteContents();l=l[0];s=l.document;if(l.checkStartOfBlock()&&l.checkEndOfBlock()){var c=(new r(l.startContainer)).block;if(c&&("li"==c.nodeName()||"li"==c.parent().nodeName()))return o.hasCommand("outdent")?(o.execCommand("save"),o.execCommand("outdent"),o.execCommand("save"),!0):!1}var k=l.splitBlock("p");if(!k)return!0;var o=k.previousBlock,c=k.nextBlock,e=k.wasStartOfBlock,
m=k.wasEndOfBlock,b;if(c)b=c.parent(),"li"==b.nodeName()&&(c._4e_breakParent(b),c._4e_move(c.next(),!0));else if(o&&(b=o.parent())&&"li"==b.nodeName())o._4e_breakParent(b),l.moveToElementEditablePosition(o.next()),o._4e_move(o.prev());if(!e&&!m){if("li"==c.nodeName()&&(b=c.first(t.invisible(!0)))&&a.inArray(b.nodeName(),["ul","ol"]))(f.ie?new q(s.createTextNode("\u00a0")):new q(s.createElement("br"))).insertBefore(b);c&&l.moveToElementEditablePosition(c)}else{var i;if(o){if("li"==o.nodeName()||!h.test(o.nodeName()))i=
o.clone()}else c&&(i=c.clone());i||(i=new q("<p>",null,s));if(b=k.elementPath)for(var k=0,d=b.elements.length;k<d;k++){var g=b.elements[k];if(g.equals(b.block)||g.equals(b.blockLimit))break;n.$removeEmpty[g.nodeName()]&&(g=g.clone(),i._4e_moveChildren(g),i.append(g))}f.ie||i._4e_appendBogus();l.insertNode(i);if(f.ie&&e&&(!m||!o[0].childNodes.length))l.moveToElementEditablePosition(m?o:i),l.select();l.moveToElementEditablePosition(e&&!m?c:i)}f.ie||(c?(i=new q(s.createElement("span")),i.html("&nbsp;"),
l.insertNode(i),i.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),l.deleteContents()):i.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));l.select();return!0}function w(a){var f=a.get("document")[0];x.on(f,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){a.execCommand("save");var c=a.execCommand("enterBlock");a.execCommand("save");!1!==c&&f.preventDefault()}})}var f=a.UA,h=/^h[1-6]$/,n=s.XHTML_DTD,
q=a.Node,x=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:l});a.docReady(function(){w(a)})}}},{requires:["./base","./walker","./elementPath","node"]});
KISSY.add("editor/htmlDataProcessor",function(a,s,t){return{init:function(r){function l(b){var b=b.childNodes,c,e,f,h=b.length;if(h){f=1;for(c=0;c<h;c++)if(e=b[c],e.nodeType!=a.DOM.NodeType.TEXT_NODE||e.nodeValue){f=0;break}return f?!1:void 0}return!1}function w(a){return a.replace(v,function(a,b,d){return"<"+b+d.replace(y,function(a,b){return-1==d.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function f(a){return a.replace(k,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function h(b){return b.replace(e,function(b,d){return a.urlDecode(d)})}var n=a.Node,q=a.UA,x=new t.Filter,o=new t.Filter;(function(){function b(a){a=t.serialize(a);return new t.Comment(c+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var e={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:l}},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=["name","href","src"],
d,c=0;c<b.length;c++)d="_ke_saved_"+b[c],a.getAttribute(d)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var d=b.getAttribute("width"),b=b.getAttribute("height");d&&a.setAttribute("width",d);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:l,strong:l,em:l,del:l,u:l},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,c.length)==c)return b=a.trim(a.urlDecode(b.substr(c.length))),t.parse(b).childNodes[0]}};q.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});x.addRules(f);o.addRules(e)})();(function(){function b(d){for(var d=d.childNodes,c=d.length,e=d[c-1];e&&3==e.nodeType&&!a.trim(e.nodeValue);)e=d[--c];return e}function c(a){var e=b(a);e&&(1==e.nodeType&&"br"==e.nodeName?a.removeChild(e):3==e.nodeType&&
i.test(e.nodeValue)&&a.removeChild(e))}function e(a){var c=b(a);return!c||"form"==a.nodeName&&"input"==c.nodeName}function f(a){c(a);e(a)&&(q.ie||a.appendChild(new t.Tag("br")))}function h(a){c(a);e(a)&&a.appendChild(new t.Text("\u00a0"))}var i=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,k=s.XHTML_DTD,m=a.merge(k.$block,k.$listItem,k.$tableContent),l;for(l in m)"br"in k[l]||delete m[l];delete m.pre;var k={tags:{}},n={tags:{}};for(l in m)k.tags[l]=f,n.tags[l]=h;o.addRules(k);x.addRules(n)})();x.addRules({text:function(a){return a.replace(/\xa0/g,
"&nbsp;")}});var v=/<(a|area|img|input)\b([^>]*)>/gi,y=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",k=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,e=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,m=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,b=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,i=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;
r.htmlDataProcessor={dataFilter:o,htmlFilter:x,toHtml:function(a){q.webkit&&(a=a.replace(/\u200b/g,""));var b=new t.BeautifyWriter;(new t.Parser(a)).parse().writeHtml(b,x);return a=b.getHtml()},toDataFormat:function(a,c){var c=c||o,a=f(a),a=w(a),a=a.replace(m,"$1ke:$2"),a=a.replace(i,"<ke:$1$2></ke:$1>"),e=new n("<div>");e.html("a"+a);a=e.html().substr(1);a=a.replace(b,"$1$2");a=h(a);e=new t.BasicWriter;(new t.Parser(a)).parse().writeHtml(e,c);return a=e.getHtml()},toServer:function(a){var b=new t.MinifyWriter;
(new t.Parser(a)).parse().writeHtml(b,x);return b.getHtml()}}}}},{requires:["./base","html-parser"]});
KISSY.add("editor/selectionFix",function(a,s){function t(a){function f(a,b){var c=d.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=n}return c}function e(){var a=d.selection.createRange();g&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&g.select();x.remove(d,"mouseup",e);x.remove(d,"mousemove",h);g=b=0}function h(a){if(a.button){if(a=f(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",g)?a.setEndPoint("StartToStart",g):a.setEndPoint("EndToEnd",g),a.select()}else e()}var b,i=a.get("window")[0],
d=a.get("document")[0],g;x.on(d,"mousedown contextmenu",function(a){var c=d.documentElement;if(a.target===c&&(b&&e(),!(c.scrollHeight>c.clientHeight)&&(b=1,g=f(a.pageX,a.pageY))))x.on(d,"mouseup",e),x.on(d,"mousemove",h),i.focus(),g.select()})}function r(a){function k(b){if(d){var g=a.getSelection(),h=g&&g.getType(),m=g&&e.selection;if(b&&m&&h==y.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){k(f)},50);else{var l;if(!m||!m.type||!("Control"!=m.type&&(l=m.createRange())&&
(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))i=m&&g.getRanges()[0],a.checkSelectionChange()}}}var e=a.get("document")[0],m=new v(e.body),b=new v(e.documentElement);if(8>s.Utils.ieEngine)b.on("click",function(b){"html"===(new v(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var i,d,g=f;b.on("mousedown",function(){g=h});b.on("mouseup",function(){g=f});m.on("focusin",function(a){if("body"==(new v(a.target)).nodeName()&&i){try{g&&i.select()}catch(b){}i=
n}});m.on("focus",function(){d=f;k()});m.on("beforedeactivate",function(a){a.relatedTarget||(d=h,g=f)});m.on("mousedown",function(){d=h});m.on("mouseup",function(){d=f;setTimeout(function(){k(f)},0)});m.on("keydown",function(){d=h});m.on("keyup",function(){d=f;setTimeout(function(){k()},0)})}function l(a){var f=a.get("document")[0];x.on(f,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function w(a){function k(a){var b=s.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function e(a){return b(a)&&i(a)}var m=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=s.Walker.whitespaces(f),i=s.Walker.bookmark(h,f),d=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var i=b.path,l=new v(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],n=i.blockLimit;if(q.gecko){var r=i.block||i.blockLimit,t=r&&r.last(e);r&&r._4e_isBlockBoundary()&&(!t||!(1==t[0].nodeType&&
t._4e_isBlockBoundary()))&&"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(b&&b.collapsed&&!i.block){if("body"==n.nodeName()){if((i=b.fixBlock(f,"p"))&&i[0]!=l[0].lastChild&&i.outerHtml().match(m))if((n=i.next(d,1))&&n[0].nodeType==o.NodeType.ELEMENT_NODE&&!k[n])b.moveToElementEditablePosition(n),i._4e_remove();else if((n=i.prev(d,1))&&n[0].nodeType==o.NodeType.ELEMENT_NODE&&!k[n])b.moveToElementEditablePosition(n,n.outerHtml().match(m)?h:f),i._4e_remove();b.select();a.notifySelectionChange()}i=
a.get("document")[0];b=new s.Range(i);b.moveToElementEditablePosition(l,f);"body"!==(new s.ElementPath(b.startContainer)).blockLimit.nodeName()&&(l=(new v(i.createElement("p"))).appendTo(l),q.ie||l._4e_appendBogus())}})}var f=!0,h=!1,n=null,q=a.UA,x=a.Event,o=a.DOM,v=a.Node,y=s.SELECTION;return{init:function(a){a.docReady(function(){q.ie?(t(a),r(a)):l(a)});w(a)}}},{requires:["./base","./selection","node"]});
KISSY.add("editor/plugin-meta",function(){(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});
a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});
a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor","html-parser"]}});a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-size/cmd"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor",
"editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});
a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/link/utils","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});
a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor","editor/plugin/maximize/cmd"]}});a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,overlay,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor",
"editor/plugin/outdent/cmd"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});a({"editor/plugin/resize":{requires:["editor",
"dd"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader","editor/plugin/contextmenu"]}});
a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui","editor/plugin/underline/cmd"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});
a({"editor/plugin/unordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["html-parser"]}});
a({"editor/plugin/xiami-music":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor",function(a,s,t,r,l,w,f,h,n,q,x,o){function v(a,c){var d=a.body;G(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";d.setAttribute("contentEditable",!1);d.setAttribute("contentEditable",!0);!c&&v(a,1)})}function y(b){b.get("iframe");var c=b.get("textarea")[0],e=b.get("window"),f=b.get("document"),g=f[0];u.webkit&&(f.on("click",function(b){var c=new s(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),f.on("mouseup",function(b){var c=new s(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(u.gecko||C||u.opera){var h;h=(new s('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);h.on("focus",function(){b.focus()});b.activateGecko=function(){u.gecko&&b.__iframeFocus&&h[0].focus()};b.on("destroy",function(){h.detach();h.remove()})}e.on("focus",function(){u.gecko?v(g,d):u.opera&&
g.body.focus();b.notifySelectionChange()});if(u.gecko)f.on("mousedown",function(){b.__iframeFocus||v(g,d)});if(C&&(f.on("keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==g.compatMode)){var i={33:1,34:1};f.on("keydown",function(a){a.keyCode in i&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(u.webkit)f.on("mousedown",function(c){c=new s(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(u.gecko)f.on("dragstart",function(a){var b=new s(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});w.add(b)}function c(b,c,d,e){var f="",h;h=l.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(h);for(h=0;h<d.length;h++)f+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});
return a.substitute(t,{doctype:8===j.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:f,style:c,data:e||"",script:b?'<script id="ke_active_script">'+(B(g).isCustomDomain()?'document.domain="'+j.domain+'";':"")+'parent.KISSY.require("editor")._initIframe("'+b+'");<\/script>':""})}function k(a,b){function d(){i=h.document;a.setInternal("document",new s(i));a.setInternal("window",new s(h));e.detach();i.open("text/html","replace");i.write(f);i.close()}var e=
a.get("iframe"),f=c(a.get("id"),a.get("customStyle"),a.get("customLink"),b),g=e[0],h=g.contentWindow,i;e.__loaded=1;try{i=h.document}catch(j){if(g.src=g.src,7>C){setTimeout(d,10);return}}d()}function e(b,c){var d=B(g).getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new s(a.substitute(J,{iframeSrc:d,prefixCls:b.get("prefixCls")})),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabindex",u.webkit?-1:e.attr("tabindex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(u.gecko&&!d.__loaded)d.on("load",
function(){k(b,c)},b);else k(b,c)}function m(b){if(b.get("iframe")){var c=b.get("iframe"),d=b.get("window"),b=b.get("document"),e=b[0],f=B(e.documentElement),e=B(e.body);a.each([b,f,e,d],function(a){a.detach()});c.remove()}}var b=!0,i=i,d=!1,g=a.Env.host,j=g.document,u=a.UA,C=u.ie,E=s.NodeType,B=s.all,G=l.tryThese,J='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',D=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;
r.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};a.augment(r,{initializer:function(){this.__commands={};this.__controls={};w.register(this)},renderUI:function(){n.init(this);q.init(this);x.init(this);o.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form)&&(c=B(c)))c.on("submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.$el.removeClass(d+
"editor-focused")});b.on("focus",function(){b.$el.addClass(d+"editor-focused")})},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){var b=this.get("iframe"),c=this.get("textarea");1==a?(this.setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this.getFormatData(1)),b.hide()),c.show(),this.fire("sourceMode"))},
_onSetFocused:function(a){a&&this.__docReady&&this.focus()},setData:function(a){var b,c=a;if(1!=this.get("mode"))this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);m(this);e(this,c)}},destructor:function(){var b,c=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(b=c[0].form)&&(b=B(b))&&b.detach("submit",this.sync,this);if(d){b=B(d[0].body);var c=B(d[0].documentElement),e=this.get("window");w.remove(this);d.detach();c.detach();b.detach();e.detach()}a.each(this.__controls,
function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],
d=a.makeArray(arguments);d.shift();d.unshift(this);return c?c.exec.apply(c,d):i},queryCommandValue:function(a){return this.execCommand(l.getQueryCmd(a))},getData:function(b,c){var d=this.htmlDataProcessor,e;c==i&&(c=this.get("mode"));e=1==c&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());e=b?d.toHtml(e):d.toServer(e);e=a.trim(e);D.test(e)&&(e="");return e},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return c(0,this.get("customStyle"),
this.get("customLink"),this.getFormatData())},getSelection:function(){return r.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b;a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];u.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},
blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&c.addStyleSheet(c,a,b)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);
b.href=a},removeCustomLink:function(b){this.get("document").all("link").each(function(a){a.attr("href")==b&&a.remove()});var c=this.get("customLink"),d=a.indexOf(b,c);-1!=d&&c.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=
b.getStartElement(),d=new r.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(1!==this.get("mode"))return i;this.focus();var c,d=a.nodeName(),e=r.XHTML_DTD,f=e.$block[d],g=r.RANGE,h=(d=this.getSelection())&&d.getRanges(),j,l,k;if(!h||0==h.length)return i;this.execCommand("save");for(l=
h.length-1;0<=l;l--)j=h[l],c=!l&&a||a.clone(b),j.insertNodeByDtd(c),k||(k=c);if(!k)return i;j.moveToPosition(k,g.POSITION_AFTER_END);f&&(a=r.Walker.whitespaces(!0),(a=(k=k.next(a,1))&&k[0].nodeType==E.ELEMENT_NODE&&k.nodeName())&&e.$block[a]&&e[a]["#text"]&&j.moveToElementEditablePosition(k));d.selectRanges([j]);this.focus();c&&1==c[0].nodeType&&c.scrollIntoView(i,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});M.call(this);return c},insertHtml:function(a,b){var c=this,e,f=c.get("document")[0];
if(1===c.get("mode")){if(e=c.htmlDataProcessor)a=e.toDataFormat(a,b);c.focus();c.execCommand("save");if(C){e=f.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(a)}catch(g){}}else try{f.execCommand("inserthtml",d,a)}catch(h){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new r.Range(f),e=B(f.body).first(function(a){return 1==a.nodeType&&"br"!=a.nodeName.toLowerCase()});e||(e=B(f.createElement("p")),e._4e_appendBogus().appendTo(f.body));b.setStartAt(e,r.RANGE.POSITION_AFTER_START);
b.select()}f.execCommand("inserthtml",d,a)},50)}setTimeout(function(){c.getSelection().scrollIntoView()},50);M.call(c)}}});r.decorate=function(a,b){var b=b||{},a=B(a),c=b.textareaAttrs=b.textareaAttrs||{},d=a.style("width"),e=a.style("height"),f=a.attr("name");d&&(b.width=b.width||d);e&&(b.height=b.height||e);f&&(c.name=f);b.data=b.data||a.val();b.elBefore=a;c=(new r(b)).render();a.remove();return c};r._initIframe=function(a){var c=w.getInstance(a),a=c.get("document"),e=a[0];a.one("#ke_active_script").remove();
y(c);var f=e.body,g=B(f);C?(f.hideFocus=b,f.disabled=b,f.contentEditable=b,f.removeAttribute("disabled")):setTimeout(function(){u.gecko||u.opera?f.contentEditable=b:u.webkit?f.parentNode.contentEditable=b:e.designMode="on"},0);if(u.gecko||u.opera){var h=e.documentElement;B(h).on("mousedown",function(a){if(a.target==h){u.gecko&&v(e,d);c.activateGecko()}})}setTimeout(function(){C&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=
1;c.fire("docReady");var a=c.get("disableObjectResizing"),b=c.get("disableInlineTableEditing");if(a||b)try{e.execCommand("enableObjectResizing",d,!a);e.execCommand("enableInlineTableEditing",d,!b)}catch(f){g.on(C?"resizestart":"resize",function(c){var d=new s(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var M=a.buffer(function(){this.execCommand("save")},50);return r},{requires:"node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focusManager,editor/styles,editor/zIndexManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/plugin-meta".split(",")});
