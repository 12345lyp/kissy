/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(u,G,N){G=N.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:G.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:false},focusable:{value:false},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(L){return this._setData(L)}},formatData:{getter:function(){return this._getData(1)},setter:function(L){return this._setData(L)}},
customStyle:{value:""},customLink:{value:[]}}},{xclass:"editor"});G.HTML_PARSER={textarea:function(L){return L.one("."+this.get("prefixCls")+"editor-textarea")}};u.mix(G,u.EventTarget);return KISSY.Editor=G},{requires:["htmlparser","component/base","core"]});
KISSY.add("editor/core/clipboard",function(u,G,N,L){function I(j){this.editor=j;this._init()}function T(j){var c=j.get("document")[0],b=j.getSelection(),m;if(b.getType()==L.SELECTION_ELEMENT&&(m=b.getSelectedElement())){j=b.getRanges()[0];var a=k(c.createTextNode(""));a.insertBefore(m);j.setStartBefore(a);j.setEndAfter(m);b.selectRanges([j]);setTimeout(function(){if(m.parent()){a.remove();b.selectElement(m)}},0)}}var k=u.all,w=u.UA,y=w.ie?"beforepaste":"paste",C=G.RANGE;u.augment(I,{_init:function(){var j=
this,c=j.editor,b=c.get("document"),m=b.one("body"),a=function(f){this.type=f};a.prototype={exec:function(f){var d=this.type;f.focus();setTimeout(function(){if(w.ie)if(d=="cut")T(f);else if(d=="paste"){j._preventPasteEvent();j._getClipboardDataFromPasteBin()}t(f,d)||alert(H[d])},0)}};m.on(y,j._getClipboardDataFromPasteBin,j);if(w.ie){m.on("paste",j._iePaste,j);b.on("keydown",j._onKeyDown,j);b.on("contextmenu",function(){j._isPreventBeforePaste=1;setTimeout(function(){j._isPreventBeforePaste=0},0)})}c.addCommand("copy",
new a("copy"));c.addCommand("cut",new a("cut"));c.addCommand("paste",new a("paste"))},_onKeyDown:function(j){if(this.editor.get("mode")==G.WYSIWYG_MODE)if(j.ctrlKey&&j.keyCode==86||j.shiftKey&&j.keyCode==45)this._preventPasteEvent()},_stateFromNamedCommand:function(j){var c,b=this.editor;if(j=="paste"){this._isPreventBeforePaste=1;try{c=b.get("document")[0].queryCommandEnabled(j)}catch(m){}this._isPreventBeforePaste=0}else c=(j=(j=b.getSelection())&&j.getRanges())&&!(j.length==1&&j[0].collapsed);
return c},_preventPasteEvent:function(){var j=this;j._preventPasteTimer&&clearTimeout(j._preventPasteTimer);j._isPreventPaste=1;j._preventPasteTimer=setTimeout(function(){j._isPreventPaste=0},70)},_iePaste:function(j){var c=this.editor;if(!this._isPreventPaste){j.preventDefault();c.execCommand("paste")}},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){u.log(y+":  paste event happen");var j=this.editor,c=j.get("document")[0];if(c.getElementById("ke_pastebin"))u.log(y+": trigger more than once ...");
else{var b=j.getSelection(),m=new N(c),a=k(w.webkit?"<body></body>":"<div></div>",c);a.attr("id","ke_pastebin");w.webkit&&a[0].appendChild(c.createTextNode("\u200b"));c.body.appendChild(a[0]);a.css({position:"absolute",top:b.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});a.css("left","-1000px");var f=b.createBookmarks();m.setStartAt(a,C.POSITION_AFTER_START);m.setEndAt(a,C.POSITION_BEFORE_END);m.select(true);setTimeout(function(){var d,h=a;a=w.webkit&&(d=a.first())&&d.hasClass("Apple-style-span")?
d:a;b.selectBookmarks(f);var l=a.html();h.remove();if(l=u.trim(l.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){u.log("paste "+l);d=j.fire("paste",{html:l});if(d!==false){if(d!==undefined)l=d;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(l)?u.use("editor/plugin/word-filter/dynamic/",function(v,D){j.insertHtml(D.toDataFormat(l,j))}):j.insertHtml(l)}}},0)}}}});var J=function(j,c){var b=j.get("document")[0],m=k(b.body),a=false,f=function(){a=true};m.on(c,f);(w.ie>7?b:b.selection.createRange()).execCommand(c);
m.detach(c,f);return a},t=w.ie?function(j,c){return J(j,c)}:function(j,c){try{return j.get("document")[0].execCommand(c)}catch(b){return false}},H={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},M={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(j){var c;j.docReady(function(){c=new I(j)});var b={copy:1,cut:1,paste:1},m=["copy","cut","paste"];j.on("contextmenu",function(a){var f=
a.contextmenu;if(!f.__copy_fix){f.__copy_fix=1;for(a=0;a<m.length;a++)f.addChild({content:M[m[a]],value:m[a]});f.on("click",function(v){var D=v.target.get("value");if(b[D]){f.hide();setTimeout(function(){j.execCommand("save");j.execCommand(D);setTimeout(function(){j.execCommand("save")},10)},30)}})}var d=f.get("children");for(a=d.length-1;a--;){var h=d[a],l;l=h.get?h.get("value"):h.value;if(b[l]){l=!c._stateFromNamedCommand(l);if(h.set)h.set("disabled",l);else h.disabled=l}}})}}},{requires:["./base",
"./range","./selection","node"]});
KISSY.add("editor/core/dom",function(u,G,N){function L(c,b){var m=c[b?"next":"prev"](I,1);if(m&&m[0].nodeType==w.ELEMENT_NODE){for(var a=[];m.attr("_ke_bookmark")||m._4e_isEmptyInlineRemovable(I);){a.push(m);m=b?m.next(I,1):m.prev(I,1);if(!m)return}if(c._4e_isIdentical(m,I)){for(var f=new C(b?c[0].lastChild:c[0].firstChild);a.length;)a.shift()._4e_move(c,!b,I);m._4e_moveChildren(c,!b,I);m.remove();f[0]&&f[0].nodeType==w.ELEMENT_NODE&&f._4e_mergeSiblings()}}}var I=I,T=G.XHTML_DTD,k=u.DOM,w=k.NodeType,
y=u.UA,C=u.Node,J={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};G.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var t=G.POSITION,H={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},M={hr:1},j=function(c){return c&&(c[0]||c)};N.injectDom({_4e_sameLevel:function(c,b){b=j(b);var m=c.parentNode;return m&&m==b.parentNode},_4e_isBlockBoundary:function(c,b){var m=u.merge(M,b);return!!(H[k.css(c,"display")]||m[k.nodeName(c)])},_4e_index:function(c,b){for(var m=c.parentNode.childNodes,a,f=-1,d=0;d<m.length;d++){a=m[d];if(!(b&&a.nodeType==3&&a.previousSibling&&a.previousSibling.nodeType==3)){f++;if(a===c)return f}}return-1},_4e_move:function(c,
b,m){b=j(b);m?b.insertBefore(c,b.firstChild):b.appendChild(c)},_4e_isIdentical:function(c,b){if(!b)return false;b=j(b);if(k.nodeName(c)!=k.nodeName(b))return false;var m=c.attributes,a=b.attributes,f=m.length,d=a.length;if(f!=d)return false;for(var h=0;h<f;h++){var l=m[h],v=l.name;if(l.specified&&k.attr(c,v)!=k.attr(b,v))return false}if(N.ieEngine<8)for(h=0;h<d;h++){l=a[h];v=l.name;if(l.specified&&k.attr(c,v)!=k.attr(b,v))return false}return true},_4e_isEmptyInlineRemovable:function(c){if(!T.$removeEmpty[k.nodeName(c)])return false;
c=c.childNodes;for(var b=0,m=c.length;b<m;b++){var a=c[b],f=a.nodeType;if(!(f==w.ELEMENT_NODE&&a.getAttribute("_ke_bookmark")))if(f==w.ELEMENT_NODE&&!k._4e_isEmptyInlineRemovable(a)||f==k.NodeType.TEXT_NODE&&u.trim(a.nodeValue))return false}return true},_4e_moveChildren:function(c,b,m){b=j(b);if(c!=b)if(m)for(;m=c.lastChild;)b.insertBefore(c.removeChild(m),b.firstChild);else for(;m=c.firstChild;)b.appendChild(c.removeChild(m))},_4e_mergeSiblings:function(c){c=new C(c);if(J[c.nodeName()]){L(c,true);
L(c)}},_4e_splitText:function(c,b){var m=c.ownerDocument;if(c.nodeType==k.NodeType.TEXT_NODE){if(y.ie&&b==c.nodeValue.length){var a=m.createTextNode("");k.insertAfter(a,c);return a}a=c.splitText(b);if(m.documentMode){m=m.createTextNode("");k.insertAfter(m,a);k.remove(m)}return a}},_4e_parents:function(c,b){var m=[];m.__IS_NODELIST=1;do m[b?"push":"unshift"](c);while(c=c.parentNode);return m},_4e_nextSourceNode:function(c,b,m,a){if(a&&!a.call){var f=j(a);a=function(h){return h!==f}}b=!b&&c.firstChild;
var d=c;if(!b){if(c.nodeType==w.ELEMENT_NODE&&a&&a(c,true)===false)return null;b=c.nextSibling}for(;!b&&(d=d.parentNode);){if(a&&a(d,true)===false)return null;b=d.nextSibling}if(!b)return null;if(a&&a(b)===false)return null;if(m&&m!=b.nodeType)return k._4e_nextSourceNode(b,false,m,a);return b},_4e_previousSourceNode:function(c,b,m,a){if(a&&!a.call){var f=j(a);a=function(h){return h!==f}}b=!b&&c.lastChild;var d=c;if(!b){if(c.nodeType==w.ELEMENT_NODE&&a&&a(c,true)===false)return null;b=c.previousSibling}for(;!b&&
(d=d.parentNode);){if(a&&a(d,true)===false)return null;b=d.previousSibling}if(!b)return null;if(a&&a(b)===false)return null;if(m&&b.nodeType!=m)return k._4e_previousSourceNode(b,false,m,a);return b},_4e_commonAncestor:function(c,b){b=j(b);if(c===b)return c;if(k.contains(b,c))return b;var m=c;do if(k.contains(m,b))return m;while(m=m.parentNode);return null},_4e_hasAttributes:N.ieEngine<9?function(c){for(var b=c.attributes,m=0;m<b.length;m++){var a=b[m];switch(a.name){case "class":if(c.getAttribute("class"))return true;
break;default:if(a.specified)return true}}return false}:function(c){y.gecko&&c.removeAttribute("_moz_dirty");return c.hasAttributes()},_4e_position:function(c,b){var m=j(b);if(c.compareDocumentPosition)return c.compareDocumentPosition(m);if(c==m)return t.POSITION_IDENTICAL;if(c.nodeType==w.ELEMENT_NODE&&m.nodeType==w.ELEMENT_NODE){if(k.contains(c,m))return t.POSITION_CONTAINS+t.POSITION_PRECEDING;if(k.contains(m,c))return t.POSITION_IS_CONTAINED+t.POSITION_FOLLOWING;if("sourceIndex"in c)return c.sourceIndex<
0||m.sourceIndex<0?t.POSITION_DISCONNECTED:c.sourceIndex<m.sourceIndex?t.POSITION_PRECEDING:t.POSITION_FOLLOWING}var a=k._4e_address(c);m=k._4e_address(m);for(var f=Math.min(a.length,m.length),d=0;d<=f-1;d++)if(a[d]!=m[d])return a[d]<m[d]?t.POSITION_PRECEDING:t.POSITION_FOLLOWING;return a.length<m.length?t.POSITION_CONTAINS+t.POSITION_PRECEDING:t.POSITION_IS_CONTAINED+t.POSITION_FOLLOWING},_4e_address:function(c,b){for(var m=[],a=c.ownerDocument.documentElement,f=c;f&&f!=a;){m.unshift(k._4e_index(f,
b));f=f.parentNode}return m},_4e_remove:function(c,b){var m=c.parentNode;if(m){if(b)for(var a;a=c.firstChild;)m.insertBefore(c.removeChild(a),c);m.removeChild(c)}return c},_4e_trim:function(c){k._4e_ltrim(c);k._4e_rtrim(c)},_4e_ltrim:function(c){for(var b;b=c.firstChild;){if(b.nodeType==k.NodeType.TEXT_NODE){var m=N.ltrim(b.nodeValue),a=b.nodeValue.length;if(m){if(m.length<a){k._4e_splitText(b,a-m.length);c.removeChild(c.firstChild)}}else{c.removeChild(b);continue}}break}},_4e_rtrim:function(c){for(var b;b=
c.lastChild;){if(b.type==k.NodeType.TEXT_NODE){var m=N.rtrim(b.nodeValue),a=b.nodeValue.length;if(m){if(m.length<a){k._4e_splitText(b,m.length);c.removeChild(c.lastChild)}}else{c.removeChild(b);continue}}break}if(!y.ie&&!y.opera)(b=c.lastChild)&&b.nodeType==1&&k.nodeName(b)=="br"&&c.removeChild(b)},_4e_appendBogus:function(c){for(var b=c.lastChild;b&&b.nodeType==k.NodeType.TEXT_NODE&&!u.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==k.NodeType.TEXT_NODE||k.nodeName(b)!=="br"){b=y.opera?
c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br");c.appendChild(b)}},_4e_setMarker:function(c,b,m,a){c=new C(c);var f=c.data("list_marker_id")||c.data("list_marker_id",u.guid()).data("list_marker_id"),d=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");b[f]=c;d[m]=1;return c.data(m,a)},_4e_clearMarkers:function(c,b,m){c=new C(c);var a=c.data("list_marker_names"),f=c.data("list_marker_id"),d;for(d in a)c.removeData(d);c.removeData("list_marker_names");
if(m){c.removeData("list_marker_id");delete b[f]}},_4e_copyAttributes:function(c,b,m){b=new C(b);var a=c.attributes;m=m||{};for(var f=0;f<a.length;f++){var d=a[f],h=d.name.toLowerCase(),l;if(!(h in m))if(h=="checked"&&(l=k.attr(c,h)))b.attr(h,l);else if(d.specified||y.ie&&d.value&&h=="value"){l=k.attr(c,h);if(l===null)l=d.nodeValue;b.attr(h,l)}}if(c.style.cssText!=="")b[0].style.cssText=c.style.cssText},_4e_isEditable:function(c){c=k.nodeName(c);return(c=!T.$nonEditable[c]&&(T[c]||T.span))&&c["#text"]},
_4e_getByAddress:function(c,b,m){c=c.documentElement;for(var a=0;c&&a<b.length;a++){var f=b[a];if(m)for(var d=-1,h=0;h<c.childNodes.length;h++){var l=c.childNodes[h];if(!(m===true&&l.nodeType==3&&l.previousSibling&&l.previousSibling.nodeType==3)){d++;if(d==f){c=l;break}}}else c=c.childNodes[f]}return c}})},{requires:["./base","./utils","node"]});
KISSY.add("editor/core/domIterator",function(u,G){function N(M){if(!(arguments.length<1)){this.range=M;this.forceBrBreak=I;this.enlargeBr=L;this.enforceRealBlocks=I;this._||(this._={})}}var L=true,I=false,T=u.UA,k=G.Walker,w=G.Range,y=G.RANGE,C=G.ElementPath,J=u.Node,t=u.DOM,H=/^[\r\n\t ]*$/;u.augment(N,{getNextParagraph:function(M){var j,c,b,m,a;if(!this._.lastNode){c=this.range.clone();c.shrink(y.SHRINK_ELEMENT,L);c.enlarge(this.forceBrBreak||!this.enlargeBr?y.ENLARGE_LIST_ITEM_CONTENTS:y.ENLARGE_BLOCK_CONTENTS);
var f=new k(c),d=k.bookmark(L,L);f.evaluator=d;this._.nextNode=f.next();f=new k(c);f.evaluator=d;f=f.previous();this._.lastNode=f._4e_nextSourceNode(L);if(this._.lastNode&&this._.lastNode[0].nodeType==t.NodeType.TEXT_NODE&&!u.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){d=new w(c.document);d.moveToPosition(this._.lastNode,y.POSITION_AFTER_END);if(d.checkEndOfBlock()){d=new C(d.endContainer);this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(L)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new J(c.document.createTextNode(""));t.insertAfter(this._.lastNode[0],f[0])}c=null}d=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;d;){var h=I,l=d[0].nodeType!=t.NodeType.ELEMENT_NODE,v=I;if(l){if(d[0].nodeType==t.NodeType.TEXT_NODE)if(H.test(d[0].nodeValue))l=I}else{var D=d.nodeName();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(D=="br")l=L;else if(!c&&!d[0].childNodes.length&&D!="hr"){j=d;b=d.equals(f);break}if(c){c.setEndAt(d,y.POSITION_BEFORE_START);
if(D!="br")this._.nextNode=d}h=L}else{if(d[0].firstChild){if(!c){c=new w(this.range.document);c.setStartAt(d,y.POSITION_BEFORE_START)}d=new J(d[0].firstChild);continue}l=L}}if(l&&!c){c=new w(this.range.document);c.setStartAt(d,y.POSITION_BEFORE_START)}b=(!h||l)&&d.equals(f);if(c&&!h)for(;!d[0].nextSibling&&!b;){D=d.parent();if(D._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){h=L;b||D.equals(f);break}d=D;l=L;b=d.equals(f);v=L}l&&c.setEndAt(d,y.POSITION_AFTER_END);d=d._4e_nextSourceNode(v,null,f);
if((b=!d)||h&&c)break}if(!j){if(!c){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}j=new C(c.startContainer);d=j.blockLimit;h={div:1,th:1,td:1};j=j.block;if((!j||!j[0])&&!this.enforceRealBlocks&&h[d.nodeName()]&&c.checkStartOfBlock()&&c.checkEndOfBlock())j=d;else if(!j||this.enforceRealBlocks&&j.nodeName()=="li"){j=new J(this.range.document.createElement(M||"p"));j[0].appendChild(c.extractContents());j._4e_trim();c.insertNode(j);m=a=L}else if(j.nodeName()!="li"){if(!c.checkStartOfBlock()||
!c.checkEndOfBlock()){j=j.clone(I);j[0].appendChild(c.extractContents());j._4e_trim();a=c.splitBlock();m=!a.wasStartOfBlock;a=!a.wasEndOfBlock;c.insertNode(j)}}else if(!b)this._.nextNode=j.equals(f)?null:c.getBoundaryNodes().endNode._4e_nextSourceNode(L,null,f)}if(m){c=new J(j[0].previousSibling);if(c[0]&&c[0].nodeType==t.NodeType.ELEMENT_NODE)if(c.nodeName()=="br")c._4e_remove();else c[0].lastChild&&t.nodeName(c[0].lastChild)=="br"&&t._4e_remove(c[0].lastChild)}if(a){c=k.bookmark(I,L);m=new J(j[0].lastChild);
if(m[0]&&m[0].nodeType==t.NodeType.ELEMENT_NODE&&m.nodeName()=="br")if(T.ie||m.prev(c,1)||m.next(c,1))m.remove()}if(!this._.nextNode)this._.nextNode=b||j.equals(f)?null:j._4e_nextSourceNode(L,null,f);return j}});w.prototype.createIterator=function(){return new N(this)};return N},{requires:["./base","./range","./elementPath","./walker","node"]});
KISSY.add("editor",function(u,G,N,L,I,T,k,w,y,C){function J(g,o){var r=g.body;S(function(){g.designMode="on";setTimeout(function(){g.designMode="off";r.focus();if(!arguments.callee.retry)arguments.callee.retry=c},50)},function(){g.designMode="off";l.attr(r,"contentEditable",a);l.attr(r,"contentEditable",c);!o&&J(g,1)})}function t(g){g.get("iframe");var o=g.get("textarea")[0],r=g.get("window")[0],E=g.get("document")[0];if(d.webkit){K.on(E,"click",function(O){var p=new D(O.target);u.inArray(p.nodeName(),
["input","select"])&&O.preventDefault()});K.on(E,"mouseup",function(O){var p=new D(O.target);u.inArray(p.nodeName(),["input","textarea"])&&O.preventDefault()})}if(d.gecko||h||d.opera){var Q;Q=(new D('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(o);Q.on("focus",function(){g.focus()});g.activateGecko=function(){d.gecko&&g.__iframeFocus&&Q[0].focus()};g.on("destroy",function(){Q.detach();Q.remove()})}K.on(r,"focus",function(){if(d.gecko)J(E,a);
else d.opera&&E.body.focus();g.notifySelectionChange()});d.gecko&&K.on(E,"mousedown",function(){g.__iframeFocus||J(E,a)});if(h){K.on(E,"keydown",function(O){if(O.keyCode in{8:1,46:1}){var p=g.getSelection(),z=p.getSelectedElement();if(z){g.execCommand("save");var q=p.getRanges()[0].createBookmark();z.remove();p.selectBookmarks([q]);g.execCommand("save");O.preventDefault()}}});if(E.compatMode=="CSS1Compat"){var P={33:1,34:1};K.on(E,"keydown",function(O){O.keyCode in P&&setTimeout(function(){g.getSelection().scrollIntoView()},
0)})}}d.webkit&&K.on(E,"mousedown",function(O){O=new D(O.target);u.inArray(O.nodeName(),["img","hr","input","textarea","select"])&&g.getSelection().selectElement(O)});d.gecko&&K.on(E,"dragstart",function(O){var p=new D(O.target);p.nodeName()==="img"&&/ke_/.test(p[0].className)&&O.preventDefault()});L.add(g)}function H(g,o,r,E){var Q="",P,O=N.debugUrl("theme/editor-iframe.css");for(P=0;P<r.length;P++)Q+=u.substitute('<link href="{href}" rel="stylesheet" />',{href:r[P]});return u.substitute(Z,{doctype:f.documentMode===
8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:Q,href:O,style:o,data:E||"&nbsp;",script:g?'<script id="ke_active_script">'+(l.isCustomDomain()?'document.domain="'+f.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+g+'");<\/script>':""})}function M(g,o){function r(){p=O.document;g.setInternal("document",new D(p));g.setInternal("window",new D(O));E.detach();p.open("text/html","replace");p.write(Q);p.close()}var E=g.get("iframe"),Q=H(g._UUID,g.get("customStyle"),
g.get("customLink"),o),P=E[0],O=P.contentWindow,p;E.__loaded=1;try{p=O.document}catch(z){P.src=P.src;if(h<7){setTimeout(r,10);return}}r()}function j(g,o){var r=l.getEmptyIframeSrc()||"";if(r)r=' src="'+r+'" ';r=new D(u.substitute(e,{iframeSrc:r}));var E=g.get("textarea");if(E.hasAttr("tabindex"))r.attr("tabIndex",d.webkit?-1:E.attr("tabIndex"));E.parent().prepend(r);g.set("iframe",r);g.__docReady=0;d.gecko&&!r.__loaded?r.on("load",function(){M(g,o)},g):M(g,o)}var c=true,b=b,m=u.all,a=false,f=document,
d=u.UA,h=d.ie,l=u.DOM,v=l.NodeType,D=u.Node,K=u.Event,S=N.tryThese,Z="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor' >{data}{script}</body></html>",e='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',i='<div class="'+".{prefixCls}editor-tools".substring(1)+'"></div><div class="'+".{prefixCls}editor-textarea-wrap".substring(1)+
'" '+(d.mobile?'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+"></div><div class='"+".{prefixCls}editor-status".substring(1)+"'></div>";u.mix(G,{SOURCE_MODE:0,WYSIWYG_MODE:1});var n=G.WYSIWYG_MODE;u.augment(G,{createDom:function(){var g,o=this.get("prefixCls"),r=this.get("textarea"),E;if(r){this.set("textarea",r=m(r));r[0].parentNode&&r[0].parentNode.removeChild(r[0])}else this.set("textarea",r=m("<textarea class='"+o+"-editor-textarea'></textarea>"));E=this.get("el");E.html(u.substitute(i,
{prefixCls:o}));g=E.one(u.substitute(".{prefixCls}editor-textarea-wrap",{prefixCls:o}));this._UUID=u.guid();this.set({toolBarEl:E.one(u.substitute(".{prefixCls}editor-tools",{prefixCls:o})),statusBarEl:E.one(u.substitute(".{prefixCls}editor-status",{prefixCls:o}))},{silent:1});r.css("width","100%");r.css("display","none");g.append(r);L.register(this)},renderUI:function(){k.init(this);w.init(this);y.init(this);C.init(this)},bindUI:function(){function g(){o.detach("docReady",g);if(o.get("focused"))o.focus();
else{var P=o.getSelection();P&&P.removeAllRanges()}}var o=this,r,E=o.get("prefixCls"),Q=o.get("textarea");if(o.get("attachForm")&&(r=Q[0].form)){K.on(r,"submit",o.sync,o);o.on("destroy",function(){K.detach(r,"submit",o.sync,o)})}o.on("docReady",g);o.on("blur",function(){o.get("el").removeClass(E+"editor-focused")});o.on("focus",function(){o.get("el").addClass(E+"editor-focused")})},_onSetHeight:function(g){var o=this.get("textarea"),r=this.get("toolBarEl"),E=this.get("statusBarEl");g=parseInt(g,10);
g-=(r&&r.outerHeight()||0)+(E&&E.outerHeight()||0);o.parent().css("height",g);o.css("height",g)},_onSetMode:function(g){var o=this,r,E=o.get("rendered"),Q=o.get("iframe"),P=o.get("textarea");if(g==n){E&&o.execCommand("save");o.on("docReady",r=function(){E&&o.execCommand("save");o.detach("docReady",r)});o._setData(P.val());P.hide();o.fire("wysiwygMode")}else{if(Q){P.val(o._getData(1,n));Q.hide()}P.show();o.fire("sourceMode")}},_onSetFocused:function(g){g&&this.__docReady&&this.focus()},destructor:function(){var g=
this.get("document")[0],o=this.get("window");this.sync();L.remove(this);K.remove([g,g.documentElement,g.body,o[0]]);u.each(this.__controls,function(r){r.destroy&&r.destroy()});this.__commands={};this.__controls={}},getControl:function(g){return this.__controls[g]},getControls:function(){return this.__controls},addControl:function(g,o){this.__controls[g]=o},showDialog:function(g,o){g+="/dialog";var r=this.__controls[g];r.show(o);this.fire("dialogShow",{dialog:r.dialog,pluginDialog:r,dialogName:g})},
addCommand:function(g,o){this.__commands[g]=o},hasCommand:function(g){return this.__commands[g]},execCommand:function(g){var o=this.__commands[g],r=u.makeArray(arguments);r.shift();r.unshift(this);if(o)return o.exec.apply(o,r);else{u.log(g+": command not found");return b}},queryCommandValue:function(g){return this.execCommand(N.getQueryCmd(g))},_getData:function(g,o){var r=this.htmlDataProcessor,E;if(o==b)o=this.get("mode");E=o==n?this.get("document")[0].body.innerHTML:r.toDataFormat(this.get("textarea").val());
E=g?r.toHtml(E):r.toServer(E);E=u.trim(E);if(/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(E))E="";return E},_setData:function(g){var o,r=g;if(this.get("mode")!=n)this.get("textarea").val(g);else{if(o=this.htmlDataProcessor)r=o.toDataFormat(g);if(this.get("iframe")){g=this.get("iframe");o=this.get("window")[0];var E=this.get("document")[0];K.remove([E,E.documentElement,E.body,o]);g.remove()}j(this,r)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return H(0,
this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return G.Selection.getSelection(this.get("document")[0])},focus:function(){var g=this.get("window");if(g){var o=this.get("document")[0];g=g[0];d.ie||g&&g.parent&&g.parent.focus();g&&g.focus();try{o.body.focus()}catch(r){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(g,o){var r=this.get("window"),E=this.get("customStyle")||
"";E+="\n"+g;this.set("customStyle",E);r&&l.addStyleSheet(r,g,o)},removeCustomStyle:function(g){l.remove(l.get("#"+g,this.get("window")[0]))},addCustomLink:function(g){var o=this.get("customLink")||[],r=this.get("document")[0];o.push(g);this.set("customLink",o);o=r.createElement("link");o.rel="stylesheet";r.getElementsByTagName("head")[0].appendChild(o);o.href=g},removeCustomLink:function(g){var o=this.get("document")[0];o=l.query("link",o);for(var r=0;r<o.length;r++)l.attr(o[r],"href")==g&&l.remove(o[r]);
o=this.get("customLink")||[];g=u.indexOf(g,o);g!=-1&&o.splice(g,1)},docReady:function(g){this.on("docReady",g);this.__docReady&&g.call(this)},checkSelectionChange:function(){var g=this;g.__checkSelectionChangeId&&clearTimeout(g.__checkSelectionChangeId);g.__checkSelectionChangeId=setTimeout(function(){var o=g.getSelection();if(o&&!o.isInvalid){var r=o.getStartElement(),E=new G.ElementPath(r);if(!g.__previousPath||!g.__previousPath.compare(E)){g.__previousPath=E;g.fire("selectionChange",{selection:o,
path:E,element:r})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(g){if(this.get("mode")!==n)return b;this.focus();var o,r=g.nodeName(),E=G.XHTML_DTD,Q=E.$block[r],P=G.RANGE,O=(r=this.getSelection())&&r.getRanges(),p,z,q;if(!O||O.length==0)return b;this.execCommand("save");for(z=O.length-1;z>=0;z--){p=O[z];o=!z&&g||g.clone(c);p.insertNodeByDtd(o);q||(q=o)}if(!q)return b;p.moveToPosition(q,P.POSITION_AFTER_END);if(Q){g=G.Walker.whitespaces(true);
(g=(q=q.next(g,1))&&q[0].nodeType==v.ELEMENT_NODE&&q.nodeName())&&E.$block[g]&&E[g]["#text"]&&p.moveToElementEditablePosition(q)}r.selectRanges([p]);this.focus();o&&o[0].nodeType==1&&o.scrollIntoView(b,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});s.call(this);return o},insertHtml:function(g,o){var r=this,E,Q=r.get("document")[0];if(r.get("mode")===n){if(E=r.htmlDataProcessor)g=E.toDataFormat(g,o);r.focus();r.execCommand("save");if(h){E=Q.selection;E.type=="Control"&&E.clear();
try{E.createRange().pasteHTML(g)}catch(P){u.log("insertHtml error in ie")}}else try{Q.execCommand("inserthtml",a,g)}catch(O){setTimeout(function(){if(r.getSelection().getRanges().length==0){var p=new G.Range(Q),z=l.first(Q.body,function(q){return q.nodeType==1&&l.nodeName(q)!="br"});if(!z){z=new D(Q.createElement("p"));z._4e_appendBogus(b);Q.body.appendChild(z[0])}p.setStartAt(z,G.RANGE.POSITION_AFTER_START);p.select()}Q.execCommand("inserthtml",a,g)},50)}setTimeout(function(){r.getSelection().scrollIntoView()},
50);s.call(r)}},insertHTML:function(g,o){return this.insertHtml(g,o)}});G._initIFrame=function(g){var o=L.getInstance(g),r=o.get("document")[0];g=r.getElementById("ke_active_script");l.remove(g);t(o);var E=r.body;if(h){E.hideFocus=c;E.disabled=c;E.contentEditable=c;E.removeAttribute("disabled")}else setTimeout(function(){if(d.gecko||d.opera)E.contentEditable=c;else if(d.webkit)E.parentNode.contentEditable=c;else r.designMode="on"},0);if(d.gecko||d.opera){var Q=r.documentElement;K.on(Q,"mousedown",
function(P){if(P.target==Q){d.gecko&&J(r,a);o.activateGecko()}})}setTimeout(function(){h&&setTimeout(function(){if(r){E.runtimeStyle.marginBottom="0px";E.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){o.__docReady=1;o.fire("docReady");var P=o.get("disableObjectResizing"),O=o.get("disableInlineTableEditing");if(P||O)try{r.execCommand("enableObjectResizing",a,!P);r.execCommand("enableInlineTableEditing",a,!O)}catch(p){K.on(E,h?"resizestart":"resize",function(z){var q=new D(z.target);
if(P||q.nodeName()==="table"&&O)z.preventDefault()})}},10)};var s=u.buffer(function(){this.execCommand("save")},50);return G},{requires:["editor/core/base","editor/core/utils","editor/core/focusManager","editor/core/styles","editor/core/zIndexManager","editor/core/clipboard","editor/core/enterKey","editor/core/htmlDataProcessor","editor/core/selectionFix"]});
KISSY.add("editor/core/elementPath",function(u,G){function N(y){var C=T,J=T,t=[];for(y=y;y;){if(y[0].nodeType==L.NodeType.ELEMENT_NODE){if(!this.lastElement)this.lastElement=y;var H=y.nodeName();if(!J){if(!C&&k[H])C=y;if(w[H]){var M;if(M=!C){if(M=H=="div"){a:{M=y[0].childNodes;for(var j=0,c=M.length;j<c;j++){var b=M[j];if(b.nodeType==L.NodeType.ELEMENT_NODE&&I.$block[b.nodeName.toLowerCase()]){M=true;break a}}M=false}M=!M}M=M}if(M)C=y;else J=y}}t.push(y);if(H=="body")break}y=y.parent()}this.block=
C;this.blockLimit=J;this.elements=t}var L=u.DOM,I=G.XHTML_DTD,T=null,k={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},w={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};N.prototype={constructor:N,compare:function(y){var C=this.elements;y=y&&y.elements;if(!y||C.length!=y.length)return false;for(var J=0;J<C.length;J++)if(!L.equals(C[J],y[J]))return false;return true},contains:function(y){for(var C=this.elements,J=0;J<C.length;J++)if(C[J].nodeName()in
y)return C[J];return T},toString:function(){var y=this.elements,C,J=[];for(C=0;C<y.length;C++)J.push(y[C].nodeName());return J.toString()}};return G.ElementPath=N},{requires:["./base","./dom","node"]});
KISSY.add("editor/core/enterKey",function(u,G,N,L){function I(t){var H;H=t.getSelection().getRanges();for(var M=H.length-1;M>0;M--)H[M].deleteContents();H=H[0];M=H.document;if(H.checkStartOfBlock()&&H.checkEndOfBlock()){var j=(new L(H.startContainer)).block;if(j&&(j.nodeName()=="li"||j.parent().nodeName()=="li"))if(t.hasCommand("outdent")){t.execCommand("save");t.execCommand("outdent");t.execCommand("save");return true}else return false}var c=H.splitBlock("p");if(!c)return true;t=c.previousBlock;
j=c.nextBlock;var b=c.wasStartOfBlock,m=c.wasEndOfBlock,a;if(j){a=j.parent();if(a.nodeName()=="li"){j._4e_breakParent(a);j._4e_move(j.next(),true)}}else if(t&&(a=t.parent())&&a.nodeName()=="li"){t._4e_breakParent(a);H.moveToElementEditablePosition(t.next());t._4e_move(t.prev())}if(!b&&!m){if(j.nodeName()=="li"&&(a=j.first(N.invisible(true)))&&u.inArray(a.nodeName(),["ul","ol"]))(k.ie?new C(M.createTextNode("\u00a0")):new C(M.createElement("br"))).insertBefore(a);j&&H.moveToElementEditablePosition(j)}else{var f;
if(t){if(t.nodeName()=="li"||!w.test(t.nodeName()))f=t.clone()}else if(j)f=j.clone();f||(f=new C("<p>",null,M));if(a=c.elementPath){c=0;for(var d=a.elements.length;c<d;c++){var h=a.elements[c];if(h.equals(a.block)||h.equals(a.blockLimit))break;if(y.$removeEmpty[h.nodeName()]){h=h.clone();f._4e_moveChildren(h);f.append(h)}}}k.ie||f._4e_appendBogus();H.insertNode(f);if(k.ie&&b&&(!m||!t[0].childNodes.length)){H.moveToElementEditablePosition(m?t:f);H.select()}H.moveToElementEditablePosition(b&&!m?j:f)}if(!k.ie)if(j){f=
new C(M.createElement("span"));f.html("&nbsp;");H.insertNode(f);f.scrollIntoView(undefined,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});H.deleteContents()}else f.scrollIntoView(undefined,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});H.select();return true}function T(t){var H=t.get("document")[0];J.on(H,"keydown",function(M){if(M.keyCode===13)if(!(M.shiftKey||M.ctrlKey||M.metaKey)){t.execCommand("save");var j=t.execCommand("enterBlock");t.execCommand("save");
j!==false&&M.preventDefault()}})}var k=u.UA,w=/^h[1-6]$/,y=G.XHTML_DTD,C=u.Node,J=u.Event;return{init:function(t){t.addCommand("enterBlock",{exec:I});t.docReady(function(){T(t)})}}},{requires:["./base","./walker","./elementPath","node"]});
KISSY.add("editor/core/focusManager",function(u){function G(){var t=this;t.__iframeFocus=y;w=t;k&&clearTimeout(k);k=setTimeout(function(){t.fire("focus")},100)}function N(){var t=this;t.__iframeFocus=C;w=J;k&&clearTimeout(k);k=setTimeout(function(){t.fire("blur")},100)}var L=u.Editor,I=u.Event,T={},k,w;u={refreshAll:function(){for(var t in T){var H=T[t].get("document")[0];H.designMode="off";H.designMode="on"}},currentInstance:function(){return w},getInstance:function(t){return T[t]},add:function(t){var H=
t.get("window")[0];I.on(H,"focus",G,t);I.on(H,"blur",N,t)},register:function(t){T[t._UUID]=t},remove:function(t){delete T[t._UUID];var H=t.get("window")[0];I.remove(H,"focus",G,t);I.remove(H,"blur",N,t)}};var y=true,C=false,J=null;u.refreshAll=u.refreshAll;L.focusManager=u;L.getInstances=function(){return T};return u},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(u,G,N){return{init:function(L){function I(d){d=d.childNodes;var h,l,v,D=d.length;if(D){v=1;for(h=0;h<D;h++){l=d[h];if(!(l.nodeType==u.DOM.NodeType.TEXT_NODE&&!l.nodeValue)){v=0;break}}return v?false:undefined}else return false}function T(d){return d.replace(H,function(h,l,v){return"<"+l+v.replace(M,function(D,K){if(v.indexOf("_ke_saved_"+K)==-1)return" _ke_saved_"+D+" "+D;return D})+">"})}function k(d){return d.replace(c,function(h){return"<ke:encoded>"+
encodeURIComponent(h)+"</ke:encoded>"})}function w(d){return d.replace(b,function(h,l){return u.urlDecode(l)})}var y=u.Node,C=u.UA,J=new N.Filter,t=new N.Filter;(function(){function d(v){v=N.serialize(v);return new N.Comment(j+encodeURIComponent(v).replace(/--/g,"%2D%2D"))}var h={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:d,noscript:d,span:I}},l={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(v){if(v.attributes.length)for(var D=
["name","href","src"],K,S=0;S<D.length;S++){K="_ke_saved_"+D[S];v.getAttribute(K)&&v.removeAttribute(D[S])}return v},embed:function(v){var D=v.parentNode;if(D&&D.nodeName=="object"){var K=D.getAttribute("width");D=D.getAttribute("height");K&&v.setAttribute("width",K);D&&v.setAttribute("width",D)}},a:function(v){if(!v.childNodes.length&&!v.attributes.length)return false},span:I,strong:I,em:I,del:I,u:I},attributes:{style:function(v){if(!u.trim(v))return false}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,
"on"],[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(v){if(v.substr(0,j.length)==j){v=u.trim(u.urlDecode(v.substr(j.length)));return N.parse(v).childNodes[0]}}};if(C.ie)l.attributes.style=function(v){return v.replace(/(^|;)([^:]+)/g,function(D){return D.toLowerCase()})};J.addRules(l);t.addRules(h)})();(function(){function d(n){n=n.childNodes;for(var s=n.length,g=n[s-1];g&&g.nodeType==3&&!u.trim(g.nodeValue);)g=n[--s];return g}function h(n){var s=d(n);if(s)if(s.nodeType==1&&s.nodeName==
"br")n.removeChild(s);else s.nodeType==3&&K.test(s.nodeValue)&&n.removeChild(s)}function l(n){var s=d(n);return!s||n.nodeName=="form"&&s.nodeName=="input"}function v(n){h(n);if(l(n))C.ie||n.appendChild(new N.Tag("br"))}function D(n){h(n);l(n)&&n.appendChild(new N.Text("\u00a0"))}var K=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,S=G.XHTML_DTD,Z=u.merge(S.$block,S.$listItem,S.$tableContent),e;for(e in Z)"br"in S[e]||delete Z[e];delete Z.pre;S={tags:{}};var i={tags:{}};for(e in Z){S.tags[e]=v;i.tags[e]=D}t.addRules(S);
J.addRules(i)})();J.addRules({text:function(d){return d.replace(/\xa0/g,"&nbsp;")}});var H=/<(a|area|img|input)\b([^>]*)>/gi,M=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,j="{ke_protected}",c=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,b=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,m=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,a=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,
f=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;L.htmlDataProcessor={dataFilter:t,htmlFilter:J,toHtml:function(d){if(C.webkit)d=d.replace(/\u200b/g,"");var h=new N.BeautifyWriter;(new N.Parser(d)).parse().writeHtml(h,J);return d=h.getHtml()},toDataFormat:function(d,h){h=h||t;d=k(d);d=T(d);d=d.replace(m,"$1ke:$2");d=d.replace(f,"<ke:$1$2></ke:$1>");var l=new y("<div>");l.html("a"+d);d=l.html().substr(1);d=d.replace(a,"$1$2");d=w(d);l=new N.BasicWriter;(new N.Parser(d)).parse().writeHtml(l,h);return d=
l.getHtml()},toServer:function(d){var h=new N.MinifyWriter;(new N.Parser(d)).parse().writeHtml(h,J);return h.getHtml()}}}}},{requires:["./base","htmlparser"]});
KISSY.config("modules",{"editor/plugin/heading/cmd":{requires:["editor"]},"editor/plugin/page-break/index":{requires:["editor","editor/plugin/fake-objects/"]},"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/image/dialog":{requires:["ajax","editor","editor/plugin/overlay/","tabs","editor/plugin/menubutton/"]},"editor/plugin/underline/index":{requires:["editor","editor/plugin/font/ui",
"editor/plugin/underline/cmd"]},"editor/plugin/maximize/cmd":{requires:["editor"]},"editor/plugin/contextmenu/index":{requires:["editor","menu","editor/plugin/focus-fix/"]},"editor/plugin/heading/index":{requires:["editor","editor/plugin/heading/cmd"]},"editor/plugin/drag-upload/index":{requires:["editor"]},"editor/plugin/color/cmd":{requires:["editor"]},"editor/plugin/code/index":{requires:["editor","editor/plugin/dialog-loader/"]},"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils",
"editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/unordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]},"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-utils/cmd"]},"editor/plugin/italic/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]},"editor/plugin/remove-format/cmd":{requires:["editor"]},
"editor/plugin/font-size/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-size/cmd"]},"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-utils/cmd"]},"editor/plugin/table/index":{requires:["editor","editor/plugin/dialog-loader/","editor/plugin/contextmenu/"]},"editor/plugin/word-filter/dynamic/index":{requires:["htmlparser"]},"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/resize/index":{requires:["editor","dd/base"]},
"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/focus-fix/index":{requires:["editor"]},"editor/plugin/xiami-music/index":{requires:["editor","editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/maximize/index":{requires:["editor","editor/plugin/maximize/cmd"]},"editor/plugin/color/color-picker/dialog":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/smiley/index":{requires:["editor",
"editor/plugin/overlay/"]},"editor/plugin/separator/index":{requires:["editor"]},"editor/plugin/video/index":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/baseClass","editor/plugin/fake-objects/"]},"editor/plugin/multiple-upload/index":{requires:["editor","editor/plugin/dialog-loader/"]},"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/menubutton/index":{requires:["editor","menubutton"]},"editor/plugin/flash/index":{requires:["editor",
"editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/overlay/index":{requires:["editor","overlay","editor/plugin/focus-fix/","dd/plugin/constrain","component/plugin/drag"]},"editor/plugin/link/utils":{requires:["editor"]},"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/button/index":{requires:["editor",
"button"]},"editor/plugin/checkbox-source-area/index":{requires:["editor"]},"editor/plugin/strike-through/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]},"editor/plugin/fore-color/index":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]},"editor/plugin/flash-bridge/index":{requires:["swf","editor"]},"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/table/dialog":{requires:["editor","editor/plugin/overlay/",
"editor/plugin/menubutton/"]},"editor/plugin/justify-utils/cmd":{requires:["editor"]},"editor/plugin/undo/index":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]},"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/image/index":{requires:["editor","editor/plugin/button/","editor/plugin/bubble/","editor/plugin/contextmenu/","editor/plugin/dialog-loader/"]},"editor/plugin/dent-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},
"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]},"editor/plugin/list-utils/index":{requires:["editor"]},"editor/plugin/dialog-loader/index":{requires:["overlay","editor"]},"editor/plugin/flash-common/utils":{requires:["swf"]},"editor/plugin/font-family/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]},"editor/plugin/undo/cmd":{requires:["editor"]},"editor/plugin/indent/index":{requires:["editor","editor/plugin/indent/cmd"]},"editor/plugin/font/cmd":{requires:["editor"]},
"editor/plugin/ordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]},"editor/plugin/color/btn":{requires:["editor","editor/plugin/button/","editor/plugin/overlay/","editor/plugin/dialog-loader/"]},"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/local-storage/index":{requires:["editor","overlay","editor/plugin/flash-bridge/"]},"editor/plugin/bubble/index":{requires:["overlay","editor"]},"editor/plugin/underline/cmd":{requires:["editor",
"editor/plugin/font/cmd"]},"editor/plugin/bold/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]},"editor/plugin/back-color/index":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]},"editor/plugin/draft/index":{requires:["editor","editor/plugin/local-storage/","overlay","editor/plugin/menubutton/"]},"editor/plugin/link/index":{requires:["editor","editor/plugin/bubble/","editor/plugin/link/utils","editor/plugin/dialog-loader/","editor/plugin/button/"]},
"editor/plugin/remove-format/index":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button/"]},"editor/plugin/font/ui":{requires:["editor","editor/plugin/button/","editor/plugin/menubutton/"]},"editor/plugin/element-path/index":{requires:["editor"]},"editor/plugin/source-area/index":{requires:["editor","editor/plugin/button/"]},"editor/plugin/justify-right/index":{requires:["editor","editor/plugin/justify-right/cmd"]},"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button/",
"editor/plugin/menubutton/"]},"editor/plugin/justify-left/index":{requires:["editor","editor/plugin/justify-left/cmd"]},"editor/plugin/outdent/index":{requires:["editor","editor/plugin/outdent/cmd"]},"editor/plugin/fake-objects/index":{requires:["editor"]},"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/link/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/link/utils"]},
"editor/plugin/multiple-upload/dialog":{requires:["editor","component/plugin/drag","editor/plugin/progressbar/","editor/plugin/overlay/","editor/plugin/flash-bridge/","editor/plugin/local-storage/","swf"]},"editor/plugin/code/dialog":{requires:["editor","editor/plugin/overlay/","menubutton"]},"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/flash-common/baseClass":{requires:["editor","editor/plugin/contextmenu/","editor/plugin/bubble/","editor/plugin/dialog-loader/",
"editor/plugin/flash-common/utils"]},"editor/plugin/justify-center/index":{requires:["editor","editor/plugin/justify-center/cmd"]},"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});
KISSY.add("editor/core/range",function(u,G,N,L,I){function T(e){var i=e.nodeType!=b.NodeType.TEXT_NODE&&b.nodeName(e)in a.$removeEmpty,n=e.nodeType==b.NodeType.TEXT_NODE&&!u.trim(e.nodeValue);e=!!e.parentNode.getAttribute("_ke_bookmark");return i||n||e}function k(e){return!v(e)&&!D(e)}function w(e){var i=H;return function(n){if(D(n))return t;if(n.nodeType==b.NodeType.TEXT_NODE){if(u.trim(n.nodeValue).length)return H}else if(n.nodeType==b.NodeType.ELEMENT_NODE){n=b.nodeName(n);if(!Z[n])if(!e&&!m.ie&&
n=="br"&&!i)i=t;else return H}return t}}function y(e,i){var n=e.startContainer,s=e.endContainer,g=e.startOffset,o=e.endOffset,r,E=H,Q=H,P=undefined,O=e.document,p;if(i>0)P=O.createDocumentFragment();if(e.collapsed)return P;e.optimizeBookmark();if(s[0].nodeType==b.NodeType.TEXT_NODE){Q=t;s=s._4e_splitText(o)}else if(s[0].childNodes.length>0)if(o>=s[0].childNodes.length){s=new f(s[0].appendChild(O.createTextNode("")));p=t}else s=new f(s[0].childNodes[o]);if(n[0].nodeType==b.NodeType.TEXT_NODE){E=t;
n._4e_splitText(g)}else if(g)if(g>=n[0].childNodes.length){n=new f(n[0].appendChild(O.createTextNode("")));r=t}else n=new f(n[0].childNodes[g].previousSibling);else{r=new f(O.createTextNode(""));n.prepend(r);n=r;r=t}var z=n._4e_parents(),q=s._4e_parents();z.each(function(V,W){z[W]=V});q.each(function(V,W){q[W]=V});var x,A;for(O=0;O<z.length;O++){x=z[O];A=q[O];if(!x.equals(A))break}g=P;for(var B,F,R=O;R<z.length;R++){B=z[R];o=i>0&&!B.equals(n)?g.appendChild(B.clone()[0]):null;B=B[0].nextSibling;F=
q[R];for(var U=s[0],X=F&&F[0];B;){if(X==B||U==B)break;F=B.nextSibling;if(i==2)g.appendChild(B.cloneNode(t));else{if(h[B.nodeName.toLowerCase()]){var $=B.cloneNode(t);B.innerHTML="";B=$}else b._4e_remove(B);i==1&&g.appendChild(B)}B=F}if(o)g=o}g=P;for(O=O;O<q.length;O++){B=q[O];o=i>0&&!B.equals(s)?g.appendChild(B.clone()[0]):null;if(!z[O]||!B._4e_sameLevel(z[O]))for(B=B[0].previousSibling;B;){F=B.previousSibling;if(i==2)g.insertBefore(B.cloneNode(t),g.firstChild);else{b._4e_remove(B);i==1&&g.insertBefore(B,
g.firstChild)}B=F}if(o)g=o}if(i==2){if(E){x=n[0];if(x.nodeType==b.NodeType.TEXT_NODE&&x.nextSibling&&x.nextSibling.nodeType==b.NodeType.TEXT_NODE){x.data+=x.nextSibling.data;x.parentNode.removeChild(x.nextSibling)}}if(Q){Q=s[0];if(Q.nodeType==b.NodeType.TEXT_NODE&&Q.previousSibling&&Q.previousSibling.nodeType==b.NodeType.TEXT_NODE){Q.previousSibling.data+=Q.data;Q.parentNode.removeChild(Q)}}}else{if(x&&A&&(!n._4e_sameLevel(x)||!s._4e_sameLevel(A))){Q=x._4e_index();r&&x._4e_sameLevel(n)&&Q--;e.setStart(x.parent(),
Q+1)}e.collapse(t)}r&&n.remove();p&&s.remove();return P}function C(e){e.collapsed=e.startContainer&&e.endContainer&&e.startContainer[0]==e.endContainer[0]&&e.startOffset==e.endOffset}function J(e){this.endOffset=this.endContainer=this.startOffset=this.startContainer=M;this.collapsed=t;this.document=e}G.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,
SHRINK_TEXT:2};var t=true,H=false,M=null,j=G.RANGE,c=G.POSITION,b=u.DOM,m=u.UA,a=G.XHTML_DTD,f=u.Node,d=f.all,h={td:1},l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},v=new L.whitespaces,D=new L.bookmark,K=L.whitespaces(t),S=L.bookmark(false,true),Z={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};u.augment(J,{toString:function(){var e=[],i=this.startContainer[0],
n=this.endContainer[0];e.push((i.id||i.nodeName)+":"+this.startOffset);e.push((n.id||n.nodeName)+":"+this.endOffset);return e.join("<br/>")},optimize:function(){var e=this.startContainer,i=this.startOffset;if(e[0].nodeType!=b.NodeType.ELEMENT_NODE)if(i)i>=e[0].nodeValue.length&&this.setStartAfter(e);else this.setStartBefore(e);e=this.endContainer;i=this.endOffset;if(e[0].nodeType!=b.NodeType.ELEMENT_NODE)if(i)i>=e[0].nodeValue.length&&this.setEndAfter(e);else this.setEndBefore(e)},setStartAfter:function(e){this.setStart(e.parent(),
e._4e_index()+1)},setStartBefore:function(e){this.setStart(e.parent(),e._4e_index())},setEndAfter:function(e){this.setEnd(e.parent(),e._4e_index()+1)},setEndBefore:function(e){this.setEnd(e.parent(),e._4e_index())},optimizeBookmark:function(){var e=this.startContainer,i=this.endContainer;e&&e.nodeName()=="span"&&e.attr("_ke_bookmark")&&this.setStartBefore(e);i&&i.nodeName()=="span"&&i.attr("_ke_bookmark")&&this.setEndAfter(i)},setStart:function(e,i){if(e[0].nodeType==b.NodeType.ELEMENT_NODE&&l[e.nodeName()]){e=
e.parent();i=e._4e_index()}this.startContainer=e;this.startOffset=i;if(!this.endContainer){this.endContainer=e;this.endOffset=i}C(this)},setEnd:function(e,i){if(e[0].nodeType==b.NodeType.ELEMENT_NODE&&l[e.nodeName()]){e=e.parent();i=e._4e_index()+1}this.endContainer=e;this.endOffset=i;if(!this.startContainer){this.startContainer=e;this.startOffset=i}C(this)},setStartAt:function(e,i){switch(i){case j.POSITION_AFTER_START:this.setStart(e,0);break;case j.POSITION_BEFORE_END:e[0].nodeType==b.NodeType.TEXT_NODE?
this.setStart(e,e[0].nodeValue.length):this.setStart(e,e[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(e);break;case j.POSITION_AFTER_END:this.setStartAfter(e)}C(this)},setEndAt:function(e,i){switch(i){case j.POSITION_AFTER_START:this.setEnd(e,0);break;case j.POSITION_BEFORE_END:e[0].nodeType==b.NodeType.TEXT_NODE?this.setEnd(e,e[0].nodeValue.length):this.setEnd(e,e[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(e);break;case j.POSITION_AFTER_END:this.setEndAfter(e)}C(this)},
cloneContents:function(){return y(this,2)},deleteContents:function(){return y(this,0)},extractContents:function(){return y(this,1)},collapse:function(e){if(e){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=t},clone:function(){var e=new J(this.document);e.startContainer=this.startContainer;e.startOffset=this.startOffset;e.endContainer=this.endContainer;e.endOffset=this.endOffset;e.collapsed=
this.collapsed;return e},getEnclosedNode:function(){var e=this.clone();e.optimize();if(e.startContainer[0].nodeType!=b.NodeType.ELEMENT_NODE||e.endContainer[0].nodeType!=b.NodeType.ELEMENT_NODE)return M;var i=new L(e);i.evaluator=function(n){return K(n)&&S(n)};e=i.next();i.reset();i=i.previous();return e&&e.equals(i)?e:M},shrink:function(e,i){if(!this.collapsed){e=e||j.SHRINK_TEXT;var n=this.clone(),s=this.startContainer,g=this.endContainer,o=this.startOffset,r=this.endOffset,E=t,Q,P,O=t;if(s&&s[0].nodeType==
b.NodeType.TEXT_NODE)if(o)if(o>=s[0].nodeValue.length)n.setStartAfter(s);else{n.setStartBefore(s);E=H}else n.setStartBefore(s);if(g&&g[0].nodeType==b.NodeType.TEXT_NODE)if(r)if(r>=g[0].nodeValue.length)n.setEndAfter(g);else{n.setEndAfter(g);O=H}else n.setEndBefore(g);if(E||O){P=new L(n);P.evaluator=function(p){return p.nodeType==(e==j.SHRINK_ELEMENT?b.NodeType.ELEMENT_NODE:b.NodeType.TEXT_NODE)};P.guard=function(p,z){if(e==j.SHRINK_ELEMENT&&p.nodeType==b.NodeType.TEXT_NODE)return H;if(z&&p==Q)return H;
if(!z&&p.nodeType==b.NodeType.ELEMENT_NODE)Q=p;return t}}if(E)if(n=P[e==j.SHRINK_ELEMENT?"lastForward":"next"]())this.setStartAt(n,i?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);if(O){P.reset();if(P=P[e==j.SHRINK_ELEMENT?"lastBackward":"previous"]())this.setEndAt(P,i?j.POSITION_BEFORE_END:j.POSITION_AFTER_END)}return E||O}},createBookmark2:function(e){var i=this.startContainer,n=this.endContainer,s=this.startOffset,g=this.endOffset,o,r;if(!i||!n)return{start:0,end:0};if(e){if(i[0].nodeType==b.NodeType.ELEMENT_NODE)if((o=
new f(i[0].childNodes[s]))&&o[0]&&o[0].nodeType==b.NodeType.TEXT_NODE&&s>0&&o[0].previousSibling.nodeType==b.NodeType.TEXT_NODE){i=o;s=0}for(;i[0].nodeType==b.NodeType.TEXT_NODE&&(r=i.prev(undefined,1))&&r[0].nodeType==b.NodeType.TEXT_NODE;){i=r;s+=r[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==b.NodeType.ELEMENT_NODE)if((o=new f(n[0].childNodes[g]))&&o[0]&&o[0].nodeType==b.NodeType.TEXT_NODE&&g>0&&o[0].previousSibling.nodeType==b.NodeType.TEXT_NODE){n=o;g=0}for(;n[0].nodeType==b.NodeType.TEXT_NODE&&
(r=n.prev(undefined,1))&&r[0].nodeType==b.NodeType.TEXT_NODE;){n=r;g+=r[0].nodeValue.length}}}return{start:i._4e_address(e),end:this.collapsed?M:n._4e_address(e),startOffset:s,endOffset:g,normalized:e,is2:t}},createBookmark:function(e){var i,n,s,g,o=this.collapsed;i=new f("<span>",M,this.document);i.attr("_ke_bookmark",1);i.css("display","none");i.html("&nbsp;");if(e){s=u.guid("ke_bm_");i.attr("id",s+"S")}if(!o){n=i.clone();n.html("&nbsp;");e&&n.attr("id",s+"E");g=this.clone();g.collapse();g.insertNode(n)}g=
this.clone();g.collapse(t);g.insertNode(i);if(n){this.setStartAfter(i);this.setEndBefore(n)}else this.moveToPosition(i,j.POSITION_AFTER_END);return{startNode:e?s+"S":i,endNode:e?s+"E":n,serializable:e,collapsed:o}},moveToPosition:function(e,i){this.setStartAt(e,i);this.collapse(t)},trim:function(e,i){var n=this.startContainer,s=this.startOffset,g=this.collapsed;if((!e||g)&&n[0]&&n[0].nodeType==b.NodeType.TEXT_NODE){if(s)if(s>=n[0].nodeValue.length){s=n._4e_index()+1;n=n.parent()}else{var o=n._4e_splitText(s);
s=n._4e_index()+1;n=n.parent();if(b.equals(this.startContainer,this.endContainer))this.setEnd(o,this.endOffset-this.startOffset);else if(b.equals(n,this.endContainer))this.endOffset+=1}else{s=n._4e_index();n=n.parent()}this.setStart(n,s);if(g){this.collapse(t);return}}n=this.endContainer;s=this.endOffset;if(!(i||g)&&n[0]&&n[0].nodeType==b.NodeType.TEXT_NODE){if(s){s>=n[0].nodeValue.length||n._4e_splitText(s);s=n._4e_index()+1}else s=n._4e_index();n=n.parent();this.setEnd(n,s)}},insertNode:function(e){this.optimizeBookmark();
this.trim(H,t);var i=this.startContainer;i[0].insertBefore(e[0],i[0].childNodes[this.startOffset]||null);i[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(e)},moveToBookmark:function(e){var i=d(this.document);if(e.is2){var n=i._4e_getByAddress(e.start,e.normalized),s=e.startOffset;i=e.end&&i._4e_getByAddress(e.end,e.normalized);e=e.endOffset;this.setStart(n,s);i?this.setEnd(i,e):this.collapse(t)}else{n=(s=e.serializable)?u.one("#"+e.startNode,i):e.startNode;e=s?u.one("#"+e.endNode,
i):e.endNode;this.setStartBefore(n);n._4e_remove();if(e&&e[0]){this.setEndBefore(e);e._4e_remove()}else this.collapse(t)}},getCommonAncestor:function(e,i){var n=this.startContainer,s=this.endContainer;n=n[0]==s[0]?e&&n[0].nodeType==b.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new f(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(s);return i&&n[0].nodeType==b.NodeType.TEXT_NODE?n.parent():n},enlarge:function(){function e(i,n,s,g){var o=i[n?"startContainer":"endContainer"],
r,E=n?0:1,Q=0,P=n?"previousSibling":"nextSibling";r=i[n?"startOffset":"endOffset"];if(o[0].nodeType==b.NodeType.TEXT_NODE){if(n){if(r)return}else if(r<o[0].nodeValue.length)return;r=o[0][P];o=o[0].parentNode}else{r=o[0].childNodes[r+(n?-1:1)]||null;o=o[0]}for(;o;){for(;r;)if(v(r)||D(r))r=r[P];else break;if(r){Q||i[n?"setStartAfter":"setEndBefore"](d(r));break}o=d(o);if(o.nodeName()=="body")break;if(Q||o.equals(g)){s[E]=o;Q=1}else i[n?"setStartBefore":"setEndAfter"](o);r=o[0][P];o=o[0].parentNode}}
return function(i){switch(i){case j.ENLARGE_ELEMENT:if(this.collapsed)break;i=this.getCommonAncestor();var n=[];e(this,1,n,i);e(this,0,n,i);if(n[0]&&n[1]){i=n[0].contains(n[1])?n[1]:n[0];this.setStartBefore(i);this.setEndAfter(i)}break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:var s=new J(this.document);n=new f(this.document.body);s.setStartAt(n,j.POSITION_AFTER_START);s.setEnd(this.startContainer,this.startOffset);s=new L(s);var g,o,r=L.blockBoundary(i==j.ENLARGE_LIST_ITEM_CONTENTS?
{br:1}:M),E=function(P){var O=r(P);O||(g=d(P));return O},Q=function(P){var O=E(P);if(!O&&b.nodeName(P)=="br")o=d(P);return O};s.guard=E;s=s.lastBackward();g=g||n;this.setStartAt(g,g.nodeName()!="br"&&(!s&&this.checkStartOfBlock()||s&&g.contains(s))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);s=this.clone();s.collapse();s.setEndAt(n,j.POSITION_BEFORE_END);s=new L(s);s.guard=i==j.ENLARGE_LIST_ITEM_CONTENTS?Q:E;g=M;s=s.lastForward();g=g||n;this.setEndAt(g,!s&&this.checkEndOfBlock()||s&&g.contains(s)?
j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);o&&this.setEndAfter(o)}}}(),checkStartOfBlock:function(){var e=this.startContainer,i=this.startOffset;if(i&&e[0].nodeType==b.NodeType.TEXT_NODE)if(u.trim(e[0].nodeValue.substring(0,i)).length)return H;this.trim();e=new I(this.startContainer);i=this.clone();i.collapse(t);i.setStartAt(e.block||e.blockLimit,j.POSITION_AFTER_START);e=new L(i);e.evaluator=w(t);return e.checkBackward()},checkEndOfBlock:function(){var e=this.endContainer,i=this.endOffset;if(e[0].nodeType==
b.NodeType.TEXT_NODE)if(u.trim(e[0].nodeValue.substring(i)).length)return H;this.trim();e=new I(this.endContainer);i=this.clone();i.collapse(H);i.setEndAt(e.block||e.blockLimit,j.POSITION_BEFORE_END);e=new L(i);e.evaluator=w(H);return e.checkForward()},checkBoundaryOfElement:function(e,i){var n=this.clone();n[i==j.START?"setStartAt":"setEndAt"](e,i==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);n=new L(n);n.evaluator=T;return n[i==j.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var e=
this.startContainer,i=this.endContainer,n=this.startOffset,s=this.endOffset,g;if(e[0].nodeType==b.NodeType.ELEMENT_NODE){g=e[0].childNodes.length;if(g>n)e=d(e[0].childNodes[n]);else if(g==0)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=d(e);e=e._4e_nextSourceNode()||e}}if(i[0].nodeType==b.NodeType.ELEMENT_NODE){g=i[0].childNodes.length;if(g>s)i=d(i[0].childNodes[s])._4e_previousSourceNode(t);else if(g==0)i=i._4e_previousSourceNode();else{for(i=i[0];i.lastChild;)i=i.lastChild;
i=d(i)}}if(e._4e_position(i)&c.POSITION_FOLLOWING)e=i;return{startNode:e,endNode:i}},fixBlock:function(e,i){var n=this.createBookmark(),s=d(this.document.createElement(i));this.collapse(e);this.enlarge(j.ENLARGE_BLOCK_CONTENTS);s[0].appendChild(this.extractContents());s._4e_trim();m.ie||s._4e_appendBogus();this.insertNode(s);this.moveToBookmark(n);return s},splitBlock:function(e){var i=new I(this.startContainer),n=new I(this.endContainer),s=i.block,g=n.block,o=M;if(!i.blockLimit.equals(n.blockLimit))return M;
if(e!="br"){if(!s){s=this.fixBlock(t,e);g=(new I(this.endContainer)).block}g||(g=this.fixBlock(H,e))}e=s&&this.checkStartOfBlock();i=g&&this.checkEndOfBlock();this.deleteContents();if(s&&s[0]==g[0])if(i){o=new I(this.startContainer);this.moveToPosition(g,j.POSITION_AFTER_END);g=M}else if(e){o=new I(this.startContainer);this.moveToPosition(s,j.POSITION_BEFORE_START);s=M}else{g=this.splitElement(s);!m.ie&&!u.inArray(s.nodeName(),["ul","ol"])&&s._4e_appendBogus()}return{previousBlock:s,nextBlock:g,wasStartOfBlock:e,
wasEndOfBlock:i,elementPath:o}},splitElement:function(e){if(!this.collapsed)return M;this.setEndAt(e,j.POSITION_BEFORE_END);var i=this.extractContents(),n=e.clone(H);n[0].appendChild(i);n.insertAfter(e);this.moveToPosition(e,j.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(e,i){function n(g,o){var r;if(g[0].nodeType==b.NodeType.ELEMENT_NODE&&g._4e_isEditable())r=g[i?"last":"first"](k,1);if(!o&&!r)r=g[i?"prev":"next"](k,1);return r}for(var s=0;e;){if(e[0].nodeType==b.NodeType.TEXT_NODE){this.moveToPosition(e,
i?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);s=1;break}if(e[0].nodeType==b.NodeType.ELEMENT_NODE&&e._4e_isEditable()){this.moveToPosition(e,i?j.POSITION_BEFORE_END:j.POSITION_AFTER_START);s=1}e=n(e,s)}return!!s},selectNodeContents:function(e){var i=e[0];this.setStart(e,0);this.setEnd(e,i.nodeType==b.NodeType.TEXT_NODE?i.nodeValue.length:i.childNodes.length)},insertNodeByDtd:function(e){var i,n,s,g=e.nodeName();i=a.$block[g];this.deleteContents();if(i){for(i=this.getCommonAncestor(H,t);(n=a[i.nodeName()])&&
!(n&&n[g]);){var o=i.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(i);this.collapse(t);i.remove()}else s=i;i=o}s&&this.splitElement(s)}this.insertNode(e)}});N.injectDom({_4e_breakParent:function(e,i){i=d(i);e=d(e);var n,s=new G.Range(e[0].ownerDocument);s.setStartAfter(e);s.setEndAfter(i);n=s.extractContents();s.insertNode(e.remove());e.after(n)}});return G.Range=J},{requires:["./base","./utils","./walker","./elementPath","./dom","node"]});
KISSY.add("editor/core/selection",function(u,G){function N(a){this.document=a;this._={cache:{}};if(t)try{var f=this.getNative().createRange();if(!f||f.item&&f.item(0).ownerDocument!=a||f.parentElement&&f.parentElement().ownerDocument!=a)this.isInvalid=I}catch(d){this.isInvalid=I}}function L(a){a=new N(a);return!a||a.isInvalid?T:a}G.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var I=true,T=null,k=u.UA,w=u.DOM,y=u.Node,C=G.SELECTION,J=G.RANGE,t=k.ie,H=G.Walker,M=G.Range,j={img:1,
hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};u.augment(N,{getNative:!t?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=w.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!t?function(){var a=this._.cache;if(a.type)return a.type;var f=C.SELECTION_TEXT,d=this.getNative();if(d){if(d.rangeCount==1){d=d.getRangeAt(0);
var h=d.startContainer;if(h==d.endContainer&&h.nodeType==w.NodeType.ELEMENT_NODE&&Number(d.endOffset-d.startOffset)==1&&j[h.childNodes[d.startOffset].nodeName.toLowerCase()])f=C.SELECTION_ELEMENT}}else f=C.SELECTION_NONE;return a.type=f}:function(){var a=this._.cache;if(a.type)return a.type;var f=C.SELECTION_NONE;try{var d=this.getNative(),h=d.type;if(h=="Text")f=C.SELECTION_TEXT;if(h=="Control")f=C.SELECTION_ELEMENT;if(d.createRange().parentElement)f=C.SELECTION_TEXT}catch(l){}return a.type=f},getRanges:t?
function(){var a=function(f,d){f=f.duplicate();f.collapse(d);for(var h=f.parentElement(),l=h.childNodes,v,D=0;D<l.length;D++){var K=l[D];if(K.nodeType==w.NodeType.ELEMENT_NODE){v=f.duplicate();v.moveToElementText(K);K=v.compareEndPoints("StartToStart",f);var S=v.compareEndPoints("EndToStart",f);v.collapse();if(K>0)break;else if(!K||S==1&&K==-1)return{container:h,offset:D};else if(!S)return{container:h,offset:D+1};v=T}}if(!v){v=f.duplicate();v.moveToElementText(h);v.collapse(false)}v.setEndPoint("StartToStart",
f);v=String(v.text).replace(/\r\n|\r/g,"\n").length;try{for(;v>0;)v-=l[--D].nodeValue.length}catch(Z){v=0}return v===0?{container:h,offset:D}:{container:l[D],offset:-v}};return function(f){var d=this._.cache;if(d.ranges&&!f)return d.ranges;var h=this.getNative();f=h&&h.createRange();var l=this.getType();if(!h)return[];if(l==C.SELECTION_TEXT){h=new M(this.document);l=a(f,I);h.setStart(new y(l.container),l.offset);l=a(f);h.setEnd(new y(l.container),l.offset);return d.ranges=[h]}else if(l==C.SELECTION_ELEMENT){d=
d.ranges=[];for(l=0;l<f.length;l++){var v=f.item(l),D=v.parentNode,K=0;for(h=new M(this.document);K<D.childNodes.length&&D.childNodes[K]!=v;K++);h.setStart(new y(D),K);h.setEnd(new y(D),K+1);d.push(h)}return d}return d.ranges=[]}}():function(a){var f=this._.cache;if(f.ranges&&!a)return f.ranges;a=[];var d=this.getNative();if(!d)return[];for(var h=0;h<d.rangeCount;h++){var l=d.getRangeAt(h),v=new M(this.document);v.setStart(new y(l.startContainer),l.startOffset);v.setEnd(new y(l.endContainer),l.endOffset);
a.push(v)}return f.ranges=a},getStartElement:function(){var a=this._.cache;if(a.startElement!==undefined)return a.startElement;var f,d=this.getNative();switch(this.getType()){case C.SELECTION_ELEMENT:return this.getSelectedElement();case C.SELECTION_TEXT:var h=this.getRanges()[0];if(h)if(!h.collapsed){for(h.optimize();I;){f=h.startContainer;if(h.startOffset==(f[0].nodeType===w.NodeType.ELEMENT_NODE?f[0].childNodes.length:f[0].nodeValue.length)&&!f._4e_isBlockBoundary())h.setStartAfter(f);else break}f=
h.startContainer;if(f[0].nodeType!=w.NodeType.ELEMENT_NODE)return f.parent();f=new y(f[0].childNodes[h.startOffset]);if(!f[0]||f[0].nodeType!=w.NodeType.ELEMENT_NODE)return h.startContainer;for(h=f[0].firstChild;h&&h.nodeType==w.NodeType.ELEMENT_NODE;){f=new y(h);h=h.firstChild}return f}if(t){h=d.createRange();h.collapse(I);f=new y(h.parentElement())}else{if((f=d.anchorNode)&&f.nodeType!=w.NodeType.ELEMENT_NODE)f=f.parentNode;if(f)f=new y(f)}}return a.startElement=f},getSelectedElement:function(){var a=
this,f,d=a._.cache;if(d.selectedElement!==undefined)return d.selectedElement;if(t){f=a.getNative().createRange();f=f.item&&f.item(0)}f=f?new y(f):function(){for(var h=a.getRanges()[0],l,v,D=2;D&&!((l=h.getEnclosedNode())&&l[0].nodeType==w.NodeType.ELEMENT_NODE&&j[l.nodeName()]&&(v=l));D--)h.shrink(J.SHRINK_ELEMENT);return v}();return d.selectedElement=f},reset:function(){this._.cache={}},selectElement:function(a){var f,d=this.document;if(t)try{f=d.body.createControlRange();f.addElement(a[0]);f.select()}catch(h){f=
d.body.createTextRange();f.moveToElementText(a[0]);f.select()}finally{}else{f=d.createRange();f.selectNode(a[0]);a=this.getNative();a.removeAllRanges();a.addRange(f)}this.reset()},selectRanges:function(a){if(t){if(a.length>1){var f=a[a.length-1];a[0].setEnd(f.endContainer,f.endOffset);a.length=1}a[0]&&a[0].select()}else{f=this.getNative();if(!f)return;f.removeAllRanges();for(var d=0;d<a.length;d++){var h=a[d],l=this.document.createRange(),v=h.startContainer;if(h.collapsed&&(k.gecko&&k.gecko<1.09||
k.opera||k.webkit)&&v[0].nodeType==w.NodeType.ELEMENT_NODE&&!v[0].childNodes.length){v[0].appendChild(this.document.createTextNode(k.webkit?"\u200b":""));h.startOffset++;h.endOffset++}l.setStart(v[0],h.startOffset);l.setEnd(h.endContainer[0],h.endOffset);f.addRange(l)}}this.reset()},createBookmarks2:function(a){for(var f=[],d=this.getRanges(),h=0;h<d.length;h++)f.push(d[h].createBookmark2(a));return f},createBookmarks:function(a,f){var d=[],h=this.document,l;f=f||this.getRanges();for(var v=f.length,D=
0;D<v;D++){d.push(l=f[D].createBookmark(a,I));var K=(a=l.serializable)?u.one("#"+l.startNode,h):l.startNode;l=a?u.one("#"+l.endNode,h):l.endNode;for(var S=D+1;S<v;S++){var Z=f[S],e=Z.startContainer,i=Z.endContainer;w.equals(e,K.parent())&&Z.startOffset++;w.equals(e,l.parent())&&Z.startOffset++;w.equals(i,K.parent())&&Z.endOffset++;w.equals(i,l.parent())&&Z.endOffset++}}return d},selectBookmarks:function(a){for(var f=[],d=0;d<a.length;d++){var h=new M(this.document);h.moveToBookmark(a[d]);f.push(h)}this.selectRanges(f);
return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(undefined,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true})},removeAllRanges:function(){var a=this.getNative();if(t)a&&a.clear();else a&&a.removeAllRanges()}});var c={table:1,tbody:1,tr:1},b=H.whitespaces(I),m=/\ufeff|\u00a0/;M.prototype.select=M.prototype.select=
!t?function(){var a=this.startContainer;if(this.collapsed&&a[0].nodeType==w.NodeType.ELEMENT_NODE&&!a[0].childNodes.length){a[0].appendChild(this.document.createTextNode(k.webkit?"\u200b":""));this.startOffset++;this.endOffset++}var f=this.document.createRange();f.setStart(a[0],this.startOffset);try{f.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(I);f.setEnd(this.endContainer[0],this.endOffset)}else throw d;}a=L(this.document).getNative();
a.removeAllRanges();a.addRange(f)}:function(a){var f=this.collapsed,d,h;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var l=this.startContainer[0].childNodes[this.startOffset];if(l.nodeType==w.NodeType.ELEMENT_NODE){(new N(this.document)).selectElement(new y(l));return}}if(this.startContainer[0].nodeType==w.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType==w.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in c)this.shrink(J.SHRINK_ELEMENT,
I);var v=this.createBookmark();l=v.startNode;var D;if(!f)D=v.endNode;v=this.document.body.createTextRange();v.moveToElementText(l[0]);v.moveStart("character",1);if(D){a=this.document.body.createTextRange();a.moveToElementText(D[0]);v.setEndPoint("EndToEnd",a);v.moveEnd("character",-1)}else{for(d=l[0].nextSibling;d&&!b(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(m))&&(a||!l[0].previousSibling||l[0].previousSibling&&w.nodeName(l[0].previousSibling)=="br");h=new y(this.document.createElement("span"));
h.html("&#65279;");h.insertBefore(l);if(d)w.insertBefore(this.document.createTextNode("\ufeff"),l[0]||l)}this.setStartBefore(l);l._4e_remove();if(f){if(d){v.moveStart("character",-1);v.select();this.document.selection.clear()}else v.select();if(h){this.moveToPosition(h,J.POSITION_BEFORE_START);h._4e_remove()}}else{this.setEndBefore(D);D._4e_remove();v.select()}};N.getSelection=L;return G.Selection=N},{requires:["./base","./walker","./range","./dom","node"]});
KISSY.add("editor/core/selectionFix",function(u,G){function N(j){function c(l,v){var D=d.body.createTextRange();try{D.moveToPoint(l,v)}catch(K){D=y}return D}function b(){var l=d.selection.createRange();h&&!l.item&&l.compareEndPoints("StartToEnd",l)===0&&h.select();J.remove(d,"mouseup",b);J.remove(d,"mousemove",m);h=a=0}function m(l){if(l.button){if(l=c(l.pageX,l.pageY)){l.compareEndPoints("StartToStart",h)>0?l.setEndPoint("StartToStart",h):l.setEndPoint("EndToEnd",h);l.select()}}else b()}var a,f=
j.get("window")[0],d=j.get("document")[0],h;J.on(d,"mousedown contextmenu",function(l){var v=d.documentElement;if(l.target===v){a&&b();if(!(v.scrollHeight>v.clientHeight)){a=1;if(h=c(l.pageX,l.pageY)){J.on(d,"mouseup",b);J.on(d,"mousemove",m);f.focus();h.select()}}}})}function L(j){function c(l){if(d){var v=j.getSelection(),D=v&&v.getType(),K=v&&b.selection;if(l&&K&&D==M.SELECTION_NONE)if(!b.queryCommandEnabled("InsertImage")){setTimeout(function(){c(k)},50);return}var S;if(!(K&&K.type&&K.type!="Control"&&
(S=K.createRange())&&(S=S.parentElement())&&(S=S.nodeName)&&S.toLowerCase()in{input:1,textarea:1})){f=K&&v.getRanges()[0];j.checkSelectionChange()}}}var b=j.get("document")[0],m=new H(b.body),a=new H(b.documentElement);G.Utils.ieEngine<8&&a.on("click",function(l){(new H(l.target)).nodeName()==="html"&&j.getSelection().getNative().createRange().select()});var f,d,h=k;a.on("mousedown",function(){h=w});a.on("mouseup",function(){h=k});m.on("focusin",function(l){if((new H(l.target)).nodeName()=="body")if(f){try{h&&
f.select()}catch(v){}f=y}});m.on("focus",function(){d=k;c()});m.on("beforedeactivate",function(l){if(!l.relatedTarget){d=w;h=k}});m.on("mousedown",function(){d=w});m.on("mouseup",function(){d=k;setTimeout(function(){c(k)},0)});m.on("keydown",function(){d=w});m.on("keyup",function(){d=k;setTimeout(function(){c()},0)})}function I(j){var c=j.get("document")[0];J.on(c,"mouseup keyup selectionchange",function(){j.checkSelectionChange()})}function T(j){function c(h){var l=G.XHTML_DTD;return h._4e_isBlockBoundary()&&
l.$empty[h.nodeName()]}function b(h){return a(h)&&f(h)}var m=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,a=G.Walker.whitespaces(k),f=G.Walker.bookmark(w,k),d=function(h){return a(h)&&h.nodeType!=8};j.on("selectionChange",function(h){var l=h.path,v=new H(j.get("document")[0].body);h=(h=h.selection)&&h.getRanges()[0];var D=l.blockLimit;if(C.gecko){var K=l.block||l.blockLimit,S=K&&K.last(b);K&&K._4e_isBlockBoundary()&&
!(S&&S[0].nodeType==1&&S._4e_isBlockBoundary())&&K.nodeName()!="pre"&&!K._4e_getBogus()&&K._4e_appendBogus()}if(!(!h||!h.collapsed||l.block)){if(D.nodeName()=="body"){if((l=h.fixBlock(k,"p"))&&l[0]!=v[0].lastChild)if(l.outerHtml().match(m))if((D=l.next(d,1))&&D[0].nodeType==t.NodeType.ELEMENT_NODE&&!c[D]){h.moveToElementEditablePosition(D);l._4e_remove()}else if((D=l.prev(d,1))&&D[0].nodeType==t.NodeType.ELEMENT_NODE&&!c[D]){h.moveToElementEditablePosition(D,D.outerHtml().match(m)?w:k);l._4e_remove()}h.select();
j.notifySelectionChange()}l=j.get("document")[0];h=new G.Range(l);h.moveToElementEditablePosition(v,k);if((new G.ElementPath(h.startContainer)).blockLimit.nodeName()!=="body"){v=(new H(l.createElement("p"))).appendTo(v);C.ie||v._4e_appendBogus()}}})}var k=true,w=false,y=null,C=u.UA,J=u.Event,t=u.DOM,H=u.Node,M=G.SELECTION;return{init:function(j){j.docReady(function(){if(C.ie){N(j);L(j)}else I(j)});T(j)}}},{requires:["./base","./selection","node"]});
KISSY.add("editor/core/styles",function(u,G){function N(p){return!K.attr(p,"_ke_bookmark")}function L(p,z){for(var q in p)if(typeof p[q]=="string")p[q]=p[q].replace(O,function(x,A){return z[A]});else L(p[q],z)}function I(p,z){if(z){p=u.clone(p);L(p,z)}var q=this.element=this.element=(p.element||"*").toLowerCase();this.type=this.type=q=="#text"||r[q]?S.STYLE_BLOCK:Q[q]?S.STYLE_OBJECT:S.STYLE_INLINE;this._={definition:p}}function T(p,z){var q=z?this.removeFromRange:this.applyToRange;p.body.focus();
for(var x=new e(p),A=x.getRanges(),B=0;B<A.length;B++)q.call(this,A[B]);x.selectRanges(A)}function k(p,z,q){var x=p.element;if(x=="*")x="span";z=new s(z.createElement(x));q&&q._4e_copyAttributes(z);q=p._.definition;p=q.attributes;q=I.getStyleText(q);if(p)for(var A in p)z.attr(A,p[A]);if(q)z[0].style.cssText=q;return z}function w(p){var z=p.createBookmark(h),q=p.createIterator();q.enforceRealBlocks=h;q.enlargeBr=h;for(var x,A=p.document;x=q.getNextParagraph();){var B=k(this,A,x);x=x;var F=B;B=F.nodeName==
"pre";var R=x.nodeName=="pre",U=!B&&R;if(B&&!R){R=x;F=F;U=R.html();U=y(U,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");U=U.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");U=U.replace(/([ \t\n\r]+|&nbsp;)/g," ");U=U.replace(/<br\b[^>]*>/gi,"\n");if(g.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(F[0]);F.outerHtml("<pre>"+U+"</pre>");F=new s(R.firstChild);F._4e_remove()}else F.html(U);F=F}else if(U)F=J(C(x),F);else x._4e_moveChildren(F);x[0].parentNode.replaceChild(F[0],x[0]);if(B){x=F;B=void 0;
if((B=x._4e_previousSourceNode(h,K.NodeType.ELEMENT_NODE))&&B.nodeName()=="pre"){F=y(B.html(),/\n$/,"")+"\n\n"+y(x.html(),/^\n/,"");g.ie?x.outerHtml("<pre>"+F+"</pre>"):x.html(F);B._4e_remove()}}}p.moveToBookmark(z)}function y(p,z,q){var x="",A="";p=p.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(B,F,R){F&&(x=F);R&&(A=R);return""});return x+p.replace(z,q)+A}function C(p){var z=[];y(p.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(q,x,A){return x+"</pre>"+A+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(q,x){z.push(x)});return z}function J(p,z){for(var q=z[0].ownerDocument.createDocumentFragment(),x=0;x<p.length;x++){var A=p[x];A=A.replace(/(\r\n|\r)/g,"\n");A=y(A,/^[ \t]*\n/,"");A=y(A,/\n$/,"");A=y(A,/^[ \t]+|[ \t]+$/g,function(F,R){return F.length==1?"&nbsp;":R?" "+Array(F.length).join("&nbsp;"):Array(F.length).join("&nbsp;")+" "});A=A.replace(/\n/g,"<br>");A=A.replace(/[ \t]{2,}/g,function(F){return Array(F.length).join("&nbsp;")+
" "});var B=z.clone();B.html(A);q.appendChild(B[0])}return q}function t(p){var z=p.document;if(p.collapsed){z=k(this,z,undefined);p.insertNode(z);p.moveToPosition(z,Z.POSITION_BEFORE_END)}else{var q=this.element,x=this._.definition,A,B=E[q];if(!B){A=h;B=E.span}var F=p.createBookmark();p.enlarge(Z.ENLARGE_ELEMENT);p.trim();var R=p.createBookmark(),U=R.startNode;R=R.endNode;for(var X=U,$;X&&X[0];){var V=l;if(K.equals(X,R)){X=v;V=h}else{var W=X[0].nodeType,aa=W==K.NodeType.ELEMENT_NODE?X.nodeName():
v;if(aa&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(h);continue}if(!aa||B[aa]&&(X._4e_position(R)|i.POSITION_PRECEDING|i.POSITION_IDENTICAL|i.POSITION_IS_CONTAINED)==i.POSITION_PRECEDING+i.POSITION_IDENTICAL+i.POSITION_IS_CONTAINED&&(!x.childRule||x.childRule(X))){var Y=X.parent();if(Y&&q=="a"&&Y.nodeName()==q){W=k(this,z,undefined);Y._4e_moveChildren(W);Y[0].parentNode.replaceChild(W[0],Y[0]);W._4e_mergeSiblings()}else if(Y&&Y[0]&&((E[Y.nodeName()]||E.span)[q]||A)&&(!x.parentRule||x.parentRule(Y))){if(!$&&
(!aa||!E.$removeEmpty[aa]||(X._4e_position(R)|i.POSITION_PRECEDING|i.POSITION_IDENTICAL|i.POSITION_IS_CONTAINED)==i.POSITION_PRECEDING+i.POSITION_IDENTICAL+i.POSITION_IS_CONTAINED)){$=new n(z);$.setStartBefore(X)}if(W==K.NodeType.TEXT_NODE||W==K.NodeType.ELEMENT_NODE&&!X[0].childNodes.length){Y=X;for(W=null;(V=!Y.next(N,1))&&(W=Y.parent())&&B[W.nodeName()]&&(W._4e_position(U)|i.POSITION_FOLLOWING|i.POSITION_IDENTICAL|i.POSITION_IS_CONTAINED)==i.POSITION_FOLLOWING+i.POSITION_IDENTICAL+i.POSITION_IS_CONTAINED&&
(!x.childRule||x.childRule(W));)Y=W;$.setEndAfter(Y)}}else V=h}else V=h;X=X._4e_nextSourceNode()}if(V&&$&&!$.collapsed){V=k(this,z,undefined);Y=$.getCommonAncestor();W={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};var ca;aa=null;for(var ba;V&&Y&&V[0]&&Y[0];){if(Y.nodeName()==q){for(ca in x.attributes)if(!(W.blockedAttrs[ca]||!(ba=Y.attr(aa))))if(V.attr(ca)==ba)V.removeAttr(ca);else W.blockedAttrs[ca]=1;for(aa in x.styles)if(!(W.blockedStyles[aa]||!(ba=Y.style(aa))))if(V.style(aa)==ba)V.style(aa,
"");else W.blockedStyles[aa]=1;if(!V._4e_hasAttributes()){V=v;break}}Y=Y.parent()}if(V){V[0].appendChild($.extractContents());a(this,V);$.insertNode(V);V._4e_mergeSiblings();g.ie||V[0].normalize()}else{V=new s(z.createElement("span"));V[0].appendChild($.extractContents());$.insertNode(V);a(this,V);V._4e_remove(true)}$=v}}U._4e_remove();R._4e_remove();p.moveToBookmark(F);p.shrink(Z.SHRINK_TEXT)}}function H(p){p.enlarge(Z.ENLARGE_ELEMENT);var z=p.createBookmark(),q=z.startNode;if(p.collapsed){for(var x=
new o(q.parent()),A,B=0,F;B<x.elements.length&&(F=x.elements[B]);B++){if(F==x.block||F==x.blockLimit)break;if(this.checkElementRemovable(F)){var R=p.checkBoundaryOfElement(F,Z.END),U=!R&&p.checkBoundaryOfElement(F,Z.START);if(U||R){A=F;A.match=U?"start":"end"}else{F._4e_mergeSiblings();if(F.nodeName()!=this.element){R=c(this);f(F,R[F.nodeName()]||R["*"])}else b(this,F)}}}if(A){F=q;for(B=0;;B++){R=x.elements[B];if(R.equals(A))break;else if(R.match)continue;else R=R.clone();R[0].appendChild(F[0]);F=
R}F[A.match=="start"?"insertBefore":"insertAfter"](A);x=A.html();if(!x||x=="\u200b")A.remove();else g.webkit&&D(p.document.createTextNode("\u200b")).insertBefore(F)}}else{var X=z.endNode,$=this;A=function(){for(var V=new o(q.parent()),W=new o(X.parent()),aa=v,Y=v,ca=0;ca<V.elements.length;ca++){var ba=V.elements[ca];if(ba==V.block||ba==V.blockLimit)break;if($.checkElementRemovable(ba))aa=ba}for(ca=0;ca<W.elements.length;ca++){ba=W.elements[ca];if(ba==W.block||ba==W.blockLimit)break;if($.checkElementRemovable(ba))Y=
ba}Y&&X._4e_breakParent(Y);aa&&q._4e_breakParent(aa)};A();for(x=new s(q[0].nextSibling);x[0]!==X[0];){B=x._4e_nextSourceNode();if(x[0]&&x[0].nodeType==K.NodeType.ELEMENT_NODE&&this.checkElementRemovable(x)){if(x.nodeName()==this.element)b(this,x);else{F=c(this);f(x,F[x.nodeName()]||F["*"])}if(B[0].nodeType==K.NodeType.ELEMENT_NODE&&B.contains(q)){A();B=new s(q[0].nextSibling)}}x=B}}p.moveToBookmark(z)}function M(p){p=String(p);var z={};p.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,
function(q,x,A){z[x]=A});return z}function j(p,z){var q="";if(z!==l){q=document.createElement("span");q.style.cssText=p;q=q.style.cssText||""}else q=p;return q.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function c(p){if(p._.overrides)return p._.overrides;var z=p._.overrides={},q=p._.definition.overrides;if(q){u.isArray(q)||(q=[q]);for(var x=0;x<q.length;x++){var A=q[x],B,F,R;if(typeof A=="string")B=A.toLowerCase();else{B=A.element?A.element.toLowerCase():
p.element;F=A.attributes;R=A.styles}A=z[B]||(z[B]={});if(F){B=A.attributes=A.attributes||[];for(var U in F)B.push([U.toLowerCase(),F[U]])}if(R){A=A.styles=A.styles||[];for(var X in R)A.push([X.toLowerCase(),R[X]])}}}return z}function b(p,z){var q=p._.definition,x=c(p),A=u.merge(q.attributes,(x[z.nodeName()]||x["*"]||{}).attributes);q=u.merge(q.styles,(x[z.nodeName()]||x["*"]||{}).styles);x=u.isEmptyObject(A)&&u.isEmptyObject(q);for(var B in A)if(!((B=="class"||p._.definition.fullMatch)&&z.attr(B)!=
m(B,A[B]))){x=x||!!z.hasAttr(B);z.removeAttr(B)}for(var F in q)if(!(p._.definition.fullMatch&&z.style(F)!=m(F,q[F],h))){x=x||!!z.style(F);z.style(F,"")}d(z)}function m(p,z,q){var x=new s("<span>");x[q?"style":"attr"](p,z);return x[q?"style":"attr"](p)}function a(p,z){for(var q=c(p),x=z.all(p.element),A=x.length;--A>=0;)b(p,new s(x[A]));for(var B in q)if(B!=p.element){x=z.all(B);for(A=x.length-1;A>=0;A--){var F=new s(x[A]);f(F,q[B])}}}function f(p,z){var q,x=z&&z.attributes;if(x)for(q=0;q<x.length;q++){var A=
x[q][0],B;if(B=p.attr(A)){var F=x[q][1];if(F===v||F.test&&F.test(B)||typeof F=="string"&&B==F)p[0].removeAttribute(A)}}if(x=z&&z.styles)for(q=0;q<x.length;q++){A=x[q][0];if(F=p.css(A)){var R=x[q][1];if(R===v||R.test&&R.test(B)||typeof R=="string"&&F==R)p.css(A,"")}}d(p)}function d(p){if(!p._4e_hasAttributes()){var z=p[0].firstChild,q=p[0].lastChild;p._4e_remove(h);if(z){z.nodeType==K.NodeType.ELEMENT_NODE&&K._4e_mergeSiblings(z);q&&z!=q&&q.nodeType==K.NodeType.ELEMENT_NODE&&K._4e_mergeSiblings(q)}}}
var h=true,l=false,v=null,D=u.all,K=u.DOM,S={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},Z=G.RANGE,e=G.Selection,i=G.POSITION,n=G.Range,s=u.Node,g=u.UA,o=G.ElementPath,r={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},E=G.XHTML_DTD,Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,O=/#\((.+?)\)/g;G.STYLE=S;I.prototype={constructor:I,apply:function(p){T.call(this,p,l)},remove:function(p){T.call(this,p,h)},applyToRange:function(p){return(this.applyToRange=
this.type==S.STYLE_INLINE?t:this.type==S.STYLE_BLOCK?w:this.type==S.STYLE_OBJECT?v:v).call(this,p)},removeFromRange:function(p){return(this.removeFromRange=this.type==S.STYLE_INLINE?H:v).call(this,p)},checkElementRemovable:function(p,z){if(!p)return l;var q=this._.definition,x;if(p.nodeName()==this.element){if(!z&&!p._4e_hasAttributes())return h;var A=q._AC;if(A)q=A;else{A={};var B=0,F=q.attributes;if(F)for(var R in F){B++;A[R]=F[R]}if(F=I.getStyleText(q)){A.style||B++;A.style=F}A._length=B;q=q._AC=
A}if(q._length){for(var U in q)if(U!="_length"){B=p.attr(U)||"";if(U=="style")a:{A=q[U];B=j(B,l);typeof A=="string"&&(A=M(A));typeof B=="string"&&(B=M(B));F=void 0;for(F in A)if(!(F in B&&(B[F]==A[F]||A[F]=="inherit"||B[F]=="inherit"))){A=l;break a}A=h}else A=q[U]==B;if(A){if(!z)return h}else if(z)return l}if(z)return h}else return h}U=c(this);if(U=U[p.nodeName()]||U["*"]){if(!(q=U.attributes)&&!(x=U.styles))return h;if(q)for(A=0;A<q.length;A++){U=q[A][0];if(U=p.attr(U)){B=q[A][1];if(B===v||typeof B==
"string"&&U==B||B.test&&B.test(U))return h}}if(x)for(A=0;A<x.length;A++)if(U=p.css(x[A][0])){q=x[A][1];if(q===v||typeof q=="string"&&U==q||q.test&&q.test(U))return h}}return l},checkActive:function(p){switch(this.type){case S.STYLE_BLOCK:return this.checkElementRemovable(p.block||p.blockLimit,h);case S.STYLE_OBJECT:case S.STYLE_INLINE:for(var z=p.elements,q=0,x;q<z.length;q++){x=z[q];if(!(this.type==S.STYLE_INLINE&&(K.equals(x,p.block)||K.equals(x,p.blockLimit))))if(!(this.type==S.STYLE_OBJECT&&!(x.nodeName()in
Q)))if(this.checkElementRemovable(x,h))return h}}return l}};I.getStyleText=function(p){var z=p._ST;if(z)return z;z=p.styles;var q=p.attributes&&p.attributes.style||"",x="";if(q.length)q=q.replace(P,";");for(var A in z){var B=z[A],F=(A+":"+B).replace(P,";");if(B=="inherit")x+=F;else q+=F}if(q.length)q=j(q);q+=x;return p._ST=q};return G.Style=I},{requires:["./base","./range","./selection","./domIterator","./elementPath","node"]});
KISSY.add("editor/core/utils",function(u,G){var N=u.Node,L=u.DOM,I=u.UA,T={debugUrl:function(k){var w=u.Config;w.debug||(k=k.replace(/\.(js|css)/i,"-min.$1"));if(k.indexOf("?t")==-1){k+=k.indexOf("?")!=-1?"&":"?";k+="t="+encodeURIComponent(w.tag)}return w.base+"editor/"+k},lazyRun:function(k,w,y){var C=k[w],J=k[y];k[w]=function(){C.apply(this,arguments);k[w]=k[y];return J.apply(this,arguments)}},getXY:function(k,w){var y=k.left,C=k.top,J=w.get("window")[0];y-=L.scrollLeft(J);C-=L.scrollTop(J);J=w.get("iframe").offset();
y+=J.left;C+=J.top;return{left:y,top:C}},tryThese:function(){for(var k,w=0,y=arguments.length;w<y;w++){var C=arguments[w];try{k=C();break}catch(J){}}return k},arrayCompare:function(k,w){if(!k&&!w)return true;if(!k||!w||k.length!=w.length)return false;for(var y=0;y<k.length;y++)if(k[y]!==w[y])return false;return true},clearAllMarkers:function(k){for(var w in k)k[w]._4e_clearMarkers(k,true,undefined)},ltrim:function(k){return k.replace(/^\s+/,"")},rtrim:function(k){return k.replace(/\s+$/,"")},isNumber:function(k){return/^\d+(.\d+)?$/.test(u.trim(k))},
verifyInputs:function(k){for(var w=0;w<k.length;w++){var y=new N(k[w]),C=u.trim(T.valInput(y)),J=y.attr("data-verify");y=y.attr("data-warning");if(J&&!RegExp(J).test(C)){alert(y);return false}}return true},sourceDisable:function(k,w){k.on("sourceMode",w.disable,w);k.on("wysiwygMode",w.enable,w)},resetInput:function(k){var w=k.attr("placeholder");if(w&&I.ie){k.addClass("ks-editor-input-tip");k.val(w)}else I.ie||k.val("")},valInput:function(k,w){if(w===undefined)return k.hasClass("ks-editor-input-tip")?
"":k.val();else{k.removeClass("ks-editor-input-tip");k.val(w)}},placeholder:function(k,w){k.attr("placeholder",w);if(I.ie){k.on("blur",function(){if(!u.trim(k.val())){k.addClass("ks-editor-input-tip");k.val(w)}});k.on("focus",function(){k.removeClass("ks-editor-input-tip");u.trim(k.val())==w&&k.val("")})}},htmlEncode:function(k){return!k?k:String(k).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(k){k=u.clone(k);for(var w in k){var y=k[w];
if(typeof y==="function")k[w]=y()}return k},map:function(k,w){for(var y=0;y<k.length;y++)k[y]=w(k[y]);return k},ieEngine:document.documentMode||I.ie,preventFocus:function(k){I.ie?k.unselectable():k.attr("onmousedown","return false;")},injectDom:function(k){u.mix(L,k);for(var w in k)(function(y){N.prototype[y]=function(){var C=[].slice.call(arguments,0);C.unshift(this[0]);if((C=k[y].apply(null,C))&&(C.nodeType||u.isWindow(C)))return new N(C);else{if(u.isArray(C))if(C.__IS_NODELIST||C[0]&&C[0].nodeType)return new N(C);
return C}}})(w)},addRes:function(){var k=this.__res=this.__res||[];k.push.apply(k,u.makeArray(arguments))},destroyRes:function(){for(var k=this.__res||[],w=0;w<k.length;w++){var y=k[w];if(typeof y==="function")y();else if(y.destroy)y.destroy();else y.remove&&y.remove()}this.__res=[]},getQueryCmd:function(k){return"query"+("-"+k).replace(/-(\w)/g,function(w,y){return y.toUpperCase()})+"Value"}};return G.Utils=T},{requires:["./base","node"]});
KISSY.add("editor/core/walker",function(u,G){function N(b,m){if(this._.end)return w;var a,f=this.range,d,h=this.guard,l=this.type,v=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;f.trim();if(f.collapsed){this.end();return w}}if(!b&&!this._.guardLTR){var D=f.endContainer[0],K=D.childNodes[f.endOffset];this._.guardLTR=function(i,n){if(n&&(D==i||C.nodeName(i)=="body"))return false;return i!=K}}if(b&&!this._.guardRTL){var S=f.startContainer[0],Z=f.startOffset>0&&S.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(i,n){if(n&&(S==i||C.nodeName(i)=="body"))return false;return i!=Z}}var e=b?this._.guardRTL:this._.guardLTR;d=h?function(i,n){if(e(i,n)===k)return k;return h(i,n)}:e;if(this.current)a=this.current[v](k,l,d);else if(b){a=f.endContainer;if(f.endOffset>0){a=new t(a[0].childNodes[f.endOffset-1]);if(d(a[0])===k)a=w}else a=d(a,T)===k?w:a._4e_previousSourceNode(T,l,d,undefined)}else{a=f.startContainer;a=new t(a[0].childNodes[f.startOffset]);if(a.length){if(d(a[0])===k)a=
w}else a=d(f.startContainer,T)===k?w:f.startContainer._4e_nextSourceNode(T,l,d,undefined)}for(;a&&!this._.end;){this.current=a;if(!this.evaluator||this.evaluator(a[0])!==k){if(!m)return a}else if(m&&this.evaluator)return k;a=a[v](k,l,d)}this.end();return this.current=w}function L(b){for(var m,a=w;m=N.call(this,b);)a=m;return a}function I(b){this.range=b;this.guard=this.evaluator=w;this._={}}var T=true,k=false,w=null,y=u.UA,C=u.DOM,J=G.XHTML_DTD,t=u.Node;u.augment(I,{end:function(){this._.end=1},next:function(){return N.call(this)},
previous:function(){return N.call(this,T)},checkForward:function(){return N.call(this,k,T)!==k},checkBackward:function(){return N.call(this,T,T)!==k},lastForward:function(){return L.call(this)},lastBackward:function(){return L.call(this,T)},reset:function(){delete this.current;this._={}},_iterator:N});u.mix(I,{blockBoundary:function(b){return function(m){return!(m.nodeType==C.NodeType.ELEMENT_NODE&&C._4e_isBlockBoundary(m,b))}},bookmark:function(b,m){function a(f){return C.nodeName(f)=="span"&&C.attr(f,
"_ke_bookmark")}return function(f){var d,h;d=f.nodeType==C.NodeType.TEXT_NODE&&(h=f.parentNode)&&a(h);d=b?d:d||a(f);return!!(m^d)}},whitespaces:function(b){return function(m){m=m.nodeType==C.NodeType.TEXT_NODE&&!u.trim(m.nodeValue);return!!(b^m)}},invisible:function(b){var m=I.whitespaces();return function(a){a=m(a)||a.nodeType==C.NodeType.ELEMENT_NODE&&!a.offsetHeight;return!!(b^a)}}});var H=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,M=I.whitespaces(),j=I.bookmark(),c=function(b){var m=C.nodeName(b);return j(b)||
M(b)||b.nodeType==1&&m in J.$inline&&!(m in J.$empty)};G.Utils.injectDom({_4e_getBogus:function(b){b=new t(b);do b=b._4e_previousSourceNode();while(b&&c(b[0]));b=b&&(!y.ie?b.nodeName()=="br":b[0].nodeType==3&&H.test(b.text()))?b[0]:false;return b}});return G.Walker=I},{requires:["./base","./utils","./dom","node"]});
KISSY.add("editor/core/zIndexManager",function(u,G){var N=G.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};G.baseZIndex=function(L){return(G.Config.baseZIndex||1E4)+L};return N},{requires:["./base"]});
