KISSY.add("editor/plugin/image/dialog",function(n,A,k,B,C,D){function w(b){for(b=b;b;){var a=b.nodeName();if(a=="a")return b;if(x.$block[a]||x.$blockLimit[a])break;b=b.parent()}return null}function y(b,a){this.editor=b;this.imageCfg=a||{};this.suffix=(this.cfg=this.imageCfg.upload||null)&&this.cfg.suffix||"png,jpg,jpeg,gif";this.suffix_reg=RegExp(this.suffix.split(/,/).join("|")+"$","i");this.suffix_warning="\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3a"+this.suffix+"\u7684\u56fe\u7247"}var x=k.XHTML_DTD,z=n.UA,u=KISSY.NodeList,p="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",f=k.Utils.valInput;
n.augment(y,{_prepare:function(){function b(e){if(e.files)return e.files[0].size;return 0}var a=this,c=a.editor.get("prefixCls")+"editor-";a.dialog=a.d=(new B.Dialog({width:500,headerContent:"\u56fe\u7247",bodyContent:n.substitute("<div class='{prefixCls}img-tabs'><div class='{prefixCls}img-tabs-bar ks-clear'><div class='{prefixCls}img-tabs-tab-selected {prefixCls}img-tabs-tab' hidefocus='hidefocus'>\u7f51\u7edc\u56fe\u7247</div><div class='{prefixCls}img-tabs-tab' hidefocus='hidefocus'>\u672c\u5730\u4e0a\u4f20</div></div><div class='{prefixCls}img-tabs-body' ><div class='{prefixCls}img-tabs-panel {prefixCls}img-tabs-panel-selected'><label><span class='{prefixCls}image-title'>\u56fe\u7247\u5730\u5740\uff1a </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /' class='{prefixCls}img-url {prefixCls}input' style='width:390px;vertical-align:middle;' /></label></div><div class='{prefixCls}img-tabs-panel'><form class='{prefixCls}img-upload-form' enctype='multipart/form-data'><p style='zoom:1;'><input class='{prefixCls}input {prefixCls}img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='{prefixCls}image-up {prefixCls}button ks-inline-block'>\u6d4f\u89c8...</a></p><div class='{prefixCls}img-up-extraHtml'></div></form></div></div></div><div style='padding:0 20px 5px 20px;zoom:1'><table style='width:100%;margin-top:8px;' class='{prefixCls}img-setting'><tr><td><label>\u5bbd\u5ea6\uff1a </label><input  data-verify='^(\u81ea\u52a8|((?!0$)\\d+))?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='{prefixCls}img-width {prefixCls}input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </td><td><label>\u9ad8\u5ea6\uff1a <label><input  data-verify='^(\u81ea\u52a8|((?!0$)\\d+))?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='{prefixCls}img-height {prefixCls}input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label><input type='checkbox' class='{prefixCls}img-ratio' style='vertical-align:middle;margin-left:5px;' checked='checked'/> \u9501\u5b9a\u9ad8\u5bbd\u6bd4</label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a </label><select class='{prefixCls}img-align' title='\u5bf9\u9f50'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a </label><input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='{prefixCls}img-margin {prefixCls}input' style='width:60px'/> \u50cf\u7d20</td></tr><tr><td colspan='2' style='padding-top: 6px'><label>\u94fe\u63a5\u7f51\u5740\uff1a </label><input class='{prefixCls}img-link {prefixCls}input' style='width:235px;vertical-align:middle;'  data-verify='^(?:(?:\\s*)|(?:https?://[^\\s]+)|(?:#.+))$'  data-warning='\u8bf7\u8f93\u5165\u5408\u9002\u7684\u7f51\u5740\u683c\u5f0f' /><label><input class='{prefixCls}img-link-blank' style='vertical-align:middle;margin-left:5px;' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></td></tr></table></div></div>",
{prefixCls:c}),footerContent:n.substitute("<div style='padding:5px 20px 20px;'><a href='javascript:void('\u786e\u5b9a')' class='{prefixCls}img-insert {prefixCls}button ks-inline-block' style='margin-right:30px;'>\u786e\u5b9a</a> <a  href='javascript:void('\u53d6\u6d88')' class='{prefixCls}img-cancel {prefixCls}button ks-inline-block'>\u53d6\u6d88</a></div>",{prefixCls:c}),mask:true})).render();var d=a.d.get("el"),l=d.one("."+c+"img-cancel"),v=d.one("."+c+"img-insert"),q=k.Utils.verifyInputs,j=d.one("."+c+"img-setting");a.uploadForm=d.one("."+
c+"img-upload-form");a.imgLocalUrl=d.one("."+c+"img-local-url");a.tab=(new C({srcNode:a.d.get("body").one("."+c+"img-tabs"),prefixCls:c+"img-"})).render();a.imgLocalUrl.val(p);a.imgUrl=d.one("."+c+"img-url");a.imgHeight=d.one("."+c+"img-height");a.imgWidth=d.one("."+c+"img-width");a.imgRatio=d.one("."+c+"img-ratio");a.imgAlign=D.Select.decorate(d.one("."+c+"img-align"),{prefixCls:c+"big-",width:80,menuCfg:{prefixCls:c+"",render:d}});a.imgMargin=d.one("."+c+"img-margin");a.imgLink=d.one("."+c+"img-link");
a.imgLinkBlank=d.one("."+c+"img-link-blank");var g=k.Utils.placeholder;g(a.imgUrl,"http://");g(a.imgHeight,"\u81ea\u52a8");g(a.imgWidth,"\u81ea\u52a8");g(a.imgLink,"http://");a.imgHeight.on("keyup",function(){var e=parseInt(f(a.imgHeight));!e||!a.imgRatio[0].checked||a.imgRatio[0].disabled||!a.imgRatioValue||f(a.imgWidth,Math.floor(e*a.imgRatioValue))});a.imgWidth.on("keyup",function(){var e=parseInt(f(a.imgWidth));!e||!a.imgRatio[0].checked||a.imgRatio[0].disabled||!a.imgRatioValue||f(a.imgHeight,Math.floor(e/a.imgRatioValue))});
l.on("click",function(e){a.d.hide();e.halt()});var h=(new u("<a class='"+c+"button ks-inline-block' style='position:absolute;z-index:"+k.baseZIndex(k.zIndexManager.LOADING_CANCEL)+";left:-9999px;top:-9999px;'>\u53d6\u6d88\u4e0a\u4f20</a>")).appendTo(document.body,undefined);a.loadingCancel=h;v.on("click",function(e){e.halt();if((a.imageCfg.remote===false||n.indexOf(a.tab.getSelectedTab(),a.tab.getTabs())==1)&&a.cfg){if(q(j.all("input")))if(a.imgLocalUrl.val()==p)alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");else if(a.suffix_reg.test(a.imgLocalUrl.val())){e=
b(a.fileInput[0]);if(m&&m<e/1E3)alert("\u4e0a\u4f20\u56fe\u7247\u6700\u5927\uff1a"+m/1E3+"M");else{a.d.loading();h.on("click",function(i){i.halt();r.abort()});e=k.Utils.normParams(a.cfg.serverParams)||{};e["document-domain"]=document.domain;var r=A({data:e,url:a.cfg.serverUrl,form:a.uploadForm[0],dataType:"json",type:"post",complete:function(i,s){h.css({left:-9999,top:-9999});a.d.unloading();if(s!="abort"){i||(i={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"});if(i.error)alert(i.error);else{f(a.imgUrl,i.imgUrl);(new Image).src=i.imgUrl;a._insert()}}}});e=a.d.get("el");
var o=e.offset();h.css({left:o.left+e[0].offsetWidth/2.5,top:o.top+e[0].offsetHeight/1.5})}}else{alert(a.suffix_warning);a.uploadForm[0].reset();a.imgLocalUrl.val(p)}}else q(d.all("input"))&&a._insert()});if(a.cfg){a.cfg.extraHtml&&d.one("."+c+"img-up-extraHtml").html(a.cfg.extraHtml);var t=d.one("."+c+"image-up"),m=a.cfg&&a.cfg.sizeLimit;a.fileInput=(new u("<input type='file' style='position:absolute;cursor:pointer;left:"+(z.ie?"360":z.chrome?"319":"369")+"px;z-index:2;top:0px;height:26px;' size='1' name='"+
(a.cfg.fileInput||"Filedata")+"'/>")).insertAfter(a.imgLocalUrl);if(m)p="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+m/1E3+" M";a.imgLocalUrl.val(p);a.fileInput.css("opacity",0);a.fileInput.on("mouseenter",function(){t.addClass(""+c+"button-hover")});a.fileInput.on("mouseleave",function(){t.removeClass(""+c+"button-hover")});a.fileInput.on("change",function(){var e=a.fileInput.val();a.imgLocalUrl.val(e.replace(/.+[\/\\]/,""))});a.imageCfg.remote===false&&a.tab.removeItemAt(0,1)}else a.tab.removeItemAt(1,1);a._prepare=n.noop},_insert:function(){var b=
this,a=f(b.imgUrl),c,d=parseInt(f(b.imgHeight)),l=parseInt(f(b.imgWidth)),v=b.imgAlign.get("value"),q=parseInt(b.imgMargin.val()),j="";if(d)j+="height:"+d+"px;";if(l)j+="width:"+l+"px;";if(v!="none")j+="float:"+v+";";if(!isNaN(q)&&q!=0)j+="margin:"+q+"px;";b.d.hide();if(b.selectedEl){c=b.selectedEl;b.editor.execCommand("save");b.selectedEl.attr({src:a,_ke_saved_src:a,style:j})}else{c=new u("<img "+(j?"style='"+j+"'":"")+" src='"+a+"' _ke_saved_src='"+a+"' alt='' />",null,b.editor.get("document")[0]);
b.editor.insertElement(c)}setTimeout(function(){var g=w(c),h=n.trim(f(b.imgLink)),t=b.editor.getSelection(),m=b.imgLinkBlank.attr("checked")?"_blank":"_self",e,r=0,o,i,s;if(g){e=g.attr("target")||"_self";if(h!=g.attr("href")||e!=m){c._4e_breakParent(g);if((o=c.prev())&&o.nodeName()=="a"&&!o[0].childNodes.length)o.remove();if((i=c.next())&&i.nodeName()=="a"&&!i[0].childNodes.length)i.remove()}else r=1}if(!r&&h){b.selectedEl||(s=t.createBookmarks());g=new u("<a></a>");g.attr("_ke_saved_href",h).attr("href",
h).attr("target",m);h=c[0];h.parentNode.replaceChild(g[0],h);g.append(h)}if(s)t.selectBookmarks(s);else b.selectedEl&&b.editor.getSelection().selectElement(b.selectedEl);r||b.editor.execCommand("save")},100)},_update:function(b){var a=0,c,d=k.Utils.resetInput;if((this.selectedEl=b)&&this.imageCfg.remote!==false){f(this.imgUrl,b.attr("src"));c=parseInt(b.style("width"));var l=parseInt(b.style("height"));l?f(this.imgHeight,l):d(this.imgHeight);c?f(this.imgWidth,c):d(this.imgWidth);this.imgAlign.set("value",
b.style("float")||"none");this.imgMargin.val(parseInt(b.style("margin"))||0);this.imgRatio[0].disabled=false;this.imgRatioValue=c/l;c=w(b)}else{if(b=this.editor.getSelection().getCommonAncestor())c=w(b);b=this.imageCfg.defaultMargin;if(b==undefined)b=10;if(this.tab.get("bar").get("children").length==2)a=1;this.imgLinkBlank.attr("checked",true);d(this.imgUrl);d(this.imgLink);d(this.imgHeight);d(this.imgWidth);this.imgAlign.set("value","none");this.imgMargin.val(b);this.imgRatio[0].disabled=true;this.imgRatioValue=
null}if(c){f(this.imgLink,c.attr("_ke_saved_href")||c.attr("href"));this.imgLinkBlank.attr("checked",c.attr("target")=="_blank")}else{d(this.imgLink);this.imgLinkBlank.attr("checked",true)}this.uploadForm[0].reset();this.imgLocalUrl.val(p);d=this.tab;d.setSelectedTab(d.getTabAt(a))},show:function(b){this._prepare();this._update(b);this.d.show()},destroy:function(){this.d.destroy();this.tab.destroy();this.loadingCancel&&this.loadingCancel.remove();this.imgAlign&&this.imgAlign.destroy()}});return y},
{requires:["ajax","editor","../overlay/","tabs","../menubutton/"]});
